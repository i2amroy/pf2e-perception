{
  "version": 3,
  "sources": ["../src/constants.js", "../src/module.js", "../src/effect.js", "../src/actor.js", "../src/pf2e/success.js", "../src/scene.js", "../src/pf2e/highlight.js", "../src/template.js", "../src/utils.js", "../src/apps/base-menu.js", "../src/apps/perception.js", "../src/geometry.js", "../src/lighting.js", "../src/rule-element.js", "../src/token.js", "../src/apps/validation.js", "../src/chat.js", "../src/action.js", "../src/check.js", "../src/api.js", "../src/combat.js", "../src/detection.js", "../src/apps/icon-path-menu.js", "../src/settings.js", "../src/main.js"],
  "sourcesContent": ["export const COVER_UUID = \"Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi\";\r\n\r\nexport const VISIBILITY_VALUES = {\r\n    [undefined]: 0,\r\n    observed: 0,\r\n    concealed: 1,\r\n    hidden: 2,\r\n    undetected: 3,\r\n    unnoticed: 4,\r\n};\r\n\r\nexport const VISIBILITIES = [\"observed\", \"concealed\", \"hidden\", \"undetected\", \"unnoticed\"];\r\n\r\nexport const COVERS = [\"none\", \"lesser\", \"standard\", \"greater\", \"greater-prone\"];\r\n\r\nexport const COVER_VALUES = {\r\n    [undefined]: 0,\r\n    none: 0,\r\n    lesser: 1,\r\n    standard: 2,\r\n    greater: 3,\r\n    \"greater-prone\": 4,\r\n};\r\n\r\nexport const defaultValues = {\r\n    cover: \"none\",\r\n    visibility: \"observed\",\r\n};\r\n\r\nexport const attackCheckRoll = [\"attack-roll\", \"spell-attack-roll\"];\r\n\r\nexport const validCheckRoll = [...attackCheckRoll, \"skill-check\", \"perception-check\"];\r\n\r\nexport const ICONS_PATHS = {\r\n    cover: \"modules/pf2e-perception/images/cover.webp\",\r\n    concealed: \"systems/pf2e/icons/conditions/concealed.webp\",\r\n    hidden: \"systems/pf2e/icons/conditions/hidden.webp\",\r\n    undetected: \"systems/pf2e/icons/conditions/undetected.webp\",\r\n    unnoticed: \"systems/pf2e/icons/conditions/unnoticed.webp\",\r\n};\r\n\r\nexport const VISION_LEVELS = {\r\n    BLINDED: 0,\r\n    NORMAL: 1,\r\n    LOWLIGHT: 2,\r\n    DARKVISION: 3,\r\n};\r\n\r\nexport const DARKNESS_COLOR = \"#000000\";\r\nexport const MIST_COLOR = \"#656665\";\r\nexport const POISON_GREEN = \"#809e71\";\r\n\r\nexport const DARKNESS_SLUGS = [\"darkness\", \"dance-of-darkness\", \"ravenous-darkness\"];\r\nexport const MIST_SLUGS = [\"obscuring-mist\", \"stinking-cloud\", \"noxious-vapors\"];\r\n", "export const MODULE_ID = \"pf2e-perception\";\r\n\r\nexport function templatePath(template) {\r\n    return `modules/${MODULE_ID}/templates/${template}.hbs`;\r\n}\r\n\r\nexport function localize(...args) {\r\n    const data = args.at(-1);\r\n    const useFormat = typeof data === \"object\";\r\n\r\n    const keys = useFormat ? args.slice(0, -1) : args;\r\n    keys.unshift(MODULE_ID);\r\n\r\n    return game.i18n[useFormat ? \"format\" : \"localize\"](keys.join(\".\"), data);\r\n}\r\n\r\nexport function getFlag(doc, flag) {\r\n    return doc.getFlag(MODULE_ID, flag);\r\n}\r\n\r\nexport function setFlag(doc, flag, value) {\r\n    return doc.setFlag(MODULE_ID, flag, value);\r\n}\r\n\r\nexport function unsetFlag(doc, flag) {\r\n    return doc.unsetFlag(MODULE_ID, flag, true);\r\n}\r\n\r\nexport function getFlags(doc) {\r\n    return foundry.utils.getProperty(doc, `flags.${MODULE_ID}`) ?? {};\r\n}\r\n\r\nexport function getSetting(setting) {\r\n    return game.settings.get(MODULE_ID, setting);\r\n}\r\n\r\nexport function setSetting(setting, value) {\r\n    return game.settings.set(MODULE_ID, setting, value);\r\n}\r\n\r\nexport function hasPermission() {\r\n    return game.user.role >= getSetting(\"permission\");\r\n}\r\n\r\nexport function getActionName(action) {\r\n    return game.i18n.localize(`PF2E.Actions.${action}.Title`);\r\n}\r\n", "import { COVER_UUID, COVER_VALUES } from \"./constants.js\";\r\nimport { MODULE_ID, localize } from \"./module.js\";\r\n\r\nexport function createFlatFootedSource(visibility) {\r\n    const condition = game.pf2e.ConditionManager.getCondition(\"off-guard\");\r\n    const source = condition.toObject();\r\n    source.name += ` (${game.i18n.localize(`PF2E.condition.${visibility}.name`)})`;\r\n    return source;\r\n}\r\n\r\nexport function createCoverSource(level, bonus) {\r\n    bonus ??= COVER_VALUES[level] === 3 ? 4 : COVER_VALUES[level];\r\n\r\n    return {\r\n        _id: \"I9lfZUiCwMiGogVi\",\r\n        img: \"systems/pf2e/icons/conditions-2/status_acup.webp\",\r\n        name: localize(\"cover\", level),\r\n        system: {\r\n            description: {\r\n                gm: \"\",\r\n                value: \"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>\",\r\n            },\r\n            rules: [\r\n                { domain: \"all\", key: \"RollOption\", option: `self:cover-bonus:${bonus}` },\r\n                { domain: \"all\", key: \"RollOption\", option: `self:cover-level:${level}` },\r\n                {\r\n                    key: \"FlatModifier\",\r\n                    predicate: [\r\n                        {\r\n                            or: [\r\n                                { and: [\"self:condition:prone\", \"item:ranged\"] },\r\n                                { not: \"self:cover-level:greater-prone\" },\r\n                            ],\r\n                        },\r\n                    ],\r\n                    selector: \"ac\",\r\n                    type: \"circumstance\",\r\n                    value: bonus,\r\n                },\r\n                {\r\n                    key: \"FlatModifier\",\r\n                    predicate: [\"area-effect\", { not: \"self:cover-level:greater-prone\" }],\r\n                    selector: \"reflex\",\r\n                    type: \"circumstance\",\r\n                    value: bonus,\r\n                },\r\n                {\r\n                    key: \"FlatModifier\",\r\n                    predicate: [\r\n                        { or: [\"action:hide\", \"action:sneak\", \"avoid-detection\"] },\r\n                        { not: \"self:cover-level:greater-prone\" },\r\n                    ],\r\n                    selector: \"stealth\",\r\n                    type: \"circumstance\",\r\n                    value: bonus,\r\n                },\r\n                {\r\n                    key: \"FlatModifier\",\r\n                    predicate: [\"action:avoid-notice\", { not: \"self:cover-level:greater-prone\" }],\r\n                    selector: \"initiative\",\r\n                    type: \"circumstance\",\r\n                    value: bonus,\r\n                },\r\n            ],\r\n            slug: \"effect-cover\",\r\n        },\r\n        type: \"effect\",\r\n        flags: {\r\n            core: { sourceId: COVER_UUID },\r\n            [MODULE_ID]: {\r\n                level,\r\n                bonus,\r\n            },\r\n        },\r\n    };\r\n}\r\n\r\nexport function findChoiceSetRule(item, flag = undefined) {\r\n    if (!item) return undefined;\r\n    return item.system.rules.find(\r\n        (rule) => rule.key === \"ChoiceSet\" && (!flag || rule.flag === flag)\r\n    );\r\n}\r\n", "import { COVER_UUID } from \"./constants.js\";\r\nimport { findChoiceSetRule } from \"./effect.js\";\r\n\r\nexport function getActorToken(actor, target = false) {\r\n    if (!(actor instanceof Actor)) return undefined;\r\n    const actorId = actor.id;\r\n    const isToken = actor.isToken;\r\n    const tokens = target ? game.user.targets : canvas.tokens?.controlled ?? [];\r\n    return (\r\n        tokens.find((token) => (isToken ? token.actor === actor : token.actor.id === actorId)) ??\r\n        actor.getActiveTokens().shift() ??\r\n        null\r\n    );\r\n}\r\n\r\nexport function isProne(actor) {\r\n    return actor.itemTypes.condition.some((item) => item.slug === \"prone\");\r\n}\r\n\r\nexport function getCoverEffect(actor, selection = false) {\r\n    const effect = actor.itemTypes.effect.find((x) => x.sourceId === COVER_UUID);\r\n    return selection ? findChoiceSetRule(effect)?.selection.level : effect;\r\n}\r\n\r\nexport function getFeatWithUUID(actor, uuid) {\r\n    return actor.itemTypes.feat.find((f) => f.sourceId === uuid);\r\n}\r\n\r\nfunction hasSense(actor, sense) {\r\n    if (!actor || !sense || !actor.system.perception?.senses) return false;\r\n    sense = sense.toLowerCase();\r\n    return !!actor.system.perception.senses.find(({ type }) => type === sense);\r\n}\r\n\r\nexport function hasGreaterDarkvision(actor) {\r\n    return hasSense(actor, \"greater-darkvision\");\r\n}\r\n\r\nexport function seeInvisibility(actor) {\r\n    return hasSense(actor, \"see-invisibility\");\r\n}\r\n", "const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n    LOWER_BY_TWO: -2,\r\n    LOWER: -1,\r\n    INCREASE: 1,\r\n    INCREASE_BY_TWO: 2,\r\n    TO_CRITICAL_FAILURE: \"criticalFailure\",\r\n    TO_FAILURE: \"failure\",\r\n    TO_SUCCESS: \"success\",\r\n    TO_CRITICAL_SUCCESS: \"criticalSuccess\",\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS_STRINGS = [\"criticalFailure\", \"failure\", \"success\", \"criticalSuccess\"];\r\n\r\nexport class DegreeOfSuccess {\r\n    constructor(roll, dc, dosAdjustments = null) {\r\n        if (roll instanceof Roll) {\r\n            this.dieResult =\r\n                (roll.isDeterministic\r\n                    ? roll.terms.find((t) => t instanceof NumericTerm)\r\n                    : roll.dice.find((d) => d instanceof foundry.dice.terms.Die && d.faces === 20)\r\n                )?.total ?? 1;\r\n            this.rollTotal = roll.total;\r\n        } else {\r\n            this.dieResult = roll.dieValue;\r\n            this.rollTotal = roll.dieValue + roll.modifier;\r\n        }\r\n\r\n        this.dc = typeof dc === \"number\" ? { value: dc } : dc;\r\n\r\n        this.unadjusted = this.#calculateDegreeOfSuccess();\r\n        this.adjustment = this.#getDegreeAdjustment(this.unadjusted, dosAdjustments);\r\n        this.value = this.adjustment\r\n            ? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted)\r\n            : this.unadjusted;\r\n    }\r\n\r\n    static CRITICAL_FAILURE = 0;\r\n    static FAILURE = 1;\r\n    static SUCCESS = 2;\r\n    static CRITICAL_SUCCESS = 3;\r\n\r\n    #getDegreeAdjustment(degree, adjustments) {\r\n        if (!adjustments) return null;\r\n\r\n        for (const outcome of [\"all\", ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n            const { label, amount } = adjustments[outcome] ?? {};\r\n            if (\r\n                amount &&\r\n                label &&\r\n                !(\r\n                    degree === DegreeOfSuccess.CRITICAL_SUCCESS &&\r\n                    amount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE\r\n                ) &&\r\n                !(\r\n                    degree === DegreeOfSuccess.CRITICAL_FAILURE &&\r\n                    amount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER\r\n                ) &&\r\n                (outcome === \"all\" || DEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n            ) {\r\n                return { label, amount };\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    #adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n        switch (amount) {\r\n            case \"criticalFailure\":\r\n                return 0;\r\n            case \"failure\":\r\n                return 1;\r\n            case \"success\":\r\n                return 2;\r\n            case \"criticalSuccess\":\r\n                return 3;\r\n            default:\r\n                return Math.clamped(degreeOfSuccess + amount, 0, 3);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param degree The current success value\r\n     * @return The new success value\r\n     */\r\n    #adjustDegreeByDieValue(degree) {\r\n        if (this.dieResult === 20) {\r\n            return this.#adjustDegreeOfSuccess(DEGREE_ADJUSTMENT_AMOUNTS.INCREASE, degree);\r\n        } else if (this.dieResult === 1) {\r\n            return this.#adjustDegreeOfSuccess(DEGREE_ADJUSTMENT_AMOUNTS.LOWER, degree);\r\n        }\r\n\r\n        return degree;\r\n    }\r\n\r\n    #calculateDegreeOfSuccess() {\r\n        const dc = this.dc.value;\r\n\r\n        if (this.rollTotal - dc >= 10) {\r\n            return this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS);\r\n        } else if (dc - this.rollTotal >= 10) {\r\n            return this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE);\r\n        } else if (this.rollTotal >= dc) {\r\n            return this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS);\r\n        }\r\n\r\n        return this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE);\r\n    }\r\n}\r\n", "import { getFlag, getSetting, localize } from \"./module.js\";\r\n\r\nexport function renderSceneConfig(config, html) {\r\n    let settings = \"\";\r\n\r\n    const list = [\"standard\", \"npc-vision\"];\r\n    for (const setting of list) {\r\n        const checked = getSceneSetting(config.object, setting);\r\n\r\n        settings += `<div class=\"form-group pf2e-perception-injected\">\r\n    <label>${localize(`settings.${setting}.name`)}</label>\r\n    <input type=\"checkbox\" name=\"flags.pf2e-perception.${setting}\" ${checked ? \"checked\" : \"\"}>\r\n    <p class=\"notes\">${localize(`settings.${setting}.short`)}</p>\r\n</div>`;\r\n    }\r\n\r\n    settings += \"<hr>\";\r\n\r\n    html.find('.tab[data-tab=\"basic\"] hr').first().after(settings);\r\n\r\n    const addedHeight = html\r\n        .find(\".pf2e-perception-injected\")\r\n        .toArray()\r\n        .reduce((height, el) => ((height += el.clientHeight), height), 0);\r\n\r\n    config.setPosition({ top: config.position.top - addedHeight / 2 });\r\n}\r\n\r\nexport function getValidTokens(token) {\r\n    token = token instanceof Token ? token.document : token;\r\n    if (!(token instanceof TokenDocument)) return [];\r\n\r\n    let tokens = token.scene.tokens.filter((t) => t !== token && t.actor?.isOfType(\"creature\"));\r\n\r\n    if (getSetting(\"encounter\")) {\r\n        const combat = game.combats.active;\r\n        if (!combat) return tokens;\r\n\r\n        return tokens.filter((t) => {\r\n            const actor = t.actor;\r\n            const traits = actor.traits;\r\n            return (\r\n                actor.type === \"familiar\" ||\r\n                traits.has(\"minion\") ||\r\n                traits.has(\"eidolon\") ||\r\n                combat.getCombatantByToken(t.id)\r\n            );\r\n        });\r\n    }\r\n\r\n    return tokens;\r\n}\r\n\r\nexport function validateTokens(token, tokens) {\r\n    const validToken = getValidTokens(token).map((t) => t.id);\r\n    return tokens.filter((t) => {\r\n        const id = t instanceof Token || t instanceof TokenDocument ? t.id : t;\r\n        return validToken.includes(id);\r\n    });\r\n}\r\n\r\nexport function getSceneSetting(scene, setting) {\r\n    return getFlag(scene, setting) ?? getSetting(setting);\r\n}\r\n", "/**\r\n * Measure distance using Pathfinder 2e grid-counting rules\r\n * @param p0 The origin point\r\n * @param p1 The destination point\r\n */\r\nfunction measureDistance(p0, p1) {\r\n    if (canvas.grid.type !== CONST.GRID_TYPES.SQUARE) {\r\n        return canvas.grid.measurePath([p0, p1]).distance;\r\n    }\r\n\r\n    return measureDistanceOnGrid(new Ray(p0, p1));\r\n}\r\n\r\n/**\r\n * Given the distance in each dimension, measure the distance in grid units\r\n * @param segment A pair of x/y distances constituting the line segment between two points\r\n * @param [reach] If this is a reach measurement, the origin actor's reach\r\n */\r\nfunction measureDistanceOnGrid(segment, { reach = null } = {}) {\r\n    if (!canvas.dimensions) return NaN;\r\n\r\n    const gridSize = canvas.dimensions.size;\r\n    const gridDistance = canvas.dimensions.distance;\r\n\r\n    const nx = Math.ceil(Math.abs(segment.dx / gridSize));\r\n    const ny = Math.ceil(Math.abs(segment.dy / gridSize));\r\n    const nz = Math.ceil(Math.abs((segment.dz || 0) / gridSize));\r\n\r\n    // ingore the lowest difference\r\n    const sortedDistance = [nx, ny, nz].sort((a, b) => a - b);\r\n    // Get the number of straight and diagonal moves\r\n    const squares = {\r\n        doubleDiagonal: sortedDistance[0],\r\n        diagonal: sortedDistance[1] - sortedDistance[0],\r\n        straight: sortedDistance[2] - sortedDistance[1],\r\n    };\r\n\r\n    // \"Unlike with measuring most distances, 10-foot reach can reach 2 squares diagonally.\" (CRB pg 455)\r\n    const reduction = squares.diagonal + squares.doubleDiagonal > 1 && reach === 10 ? 1 : 0;\r\n\r\n    // Diagonals in PF pretty much count as 1.5 times a straight\r\n    // for diagonals across the x, y, and z axis count it as 1.75 as a best guess\r\n    const distance =\r\n        Math.floor(squares.doubleDiagonal * 1.75 + squares.diagonal * 1.5 + squares.straight) -\r\n        reduction;\r\n\r\n    return distance * gridDistance;\r\n}\r\n\r\n/** Highlight grid according to Pathfinder 2e effect-area shapes */\r\nexport function highlightGrid({\r\n    areaShape,\r\n    object,\r\n    colors,\r\n    document,\r\n    collisionType = \"move\",\r\n    preview = false,\r\n    // added stuff\r\n    collisionOrigin,\r\n}) {\r\n    // Only highlight for objects that are non-previews (have IDs)\r\n    if (!object.id && !preview) return;\r\n\r\n    const dimensions = canvas.dimensions;\r\n    const grid = canvas.interface.grid;\r\n    if (!(grid && dimensions)) return;\r\n\r\n    // Set data defaults\r\n    const angle = document.angle ?? 0;\r\n    const direction = document.direction ?? 45;\r\n\r\n    // Clear existing highlight\r\n    const highlightLayer = grid.getHighlightLayer(object.highlightId)?.clear();\r\n    if (!highlightLayer) return;\r\n\r\n    const center = canvas.grid.getCenterPoint({ x: document.x, y: document.y });\r\n    const { i: col0, j: row0 } = canvas.grid.getOffset({ x: center.x, y: center.y });\r\n\r\n    const minAngle = (360 + ((direction - angle * 0.5) % 360)) % 360;\r\n    const maxAngle = (360 + ((direction + angle * 0.5) % 360)) % 360;\r\n    const snappedOrigin =\r\n        \"snappingMode\" in object\r\n            ? canvas.grid.getSnappedPoint(\r\n                  { x: document.x, y: document.y },\r\n                  { mode: object.snappingMode }\r\n              )\r\n            : object.center;\r\n    const withinAngle = (min, max, value) => {\r\n        min = (360 + (min % 360)) % 360;\r\n        max = (360 + (max % 360)) % 360;\r\n        value = (360 + (value % 360)) % 360;\r\n\r\n        if (min < max) return value >= min && value <= max;\r\n        return value >= min || value <= max;\r\n    };\r\n\r\n    // Offset measurement for cones to ensure that cones only start measuring from cell borders\r\n    const coneOriginOffset = (() => {\r\n        if (areaShape !== \"cone\") return { x: 0, y: 0 };\r\n\r\n        // Degrees anticlockwise from pointing right. In 45-degree increments from 0 to 360\r\n        const dir = (direction >= 0 ? 360 - direction : -direction) % 360;\r\n        // If we're not on a border for X, offset by 0.5 or -0.5 to the border of the cell in the direction we're looking on X axis\r\n        const xOffset =\r\n            snappedOrigin.x % dimensions.size !== 0\r\n                ? Math.sign((1 * Math.round(Math.cos(Math.toRadians(dir)) * 100)) / 100) / 2\r\n                : 0;\r\n        // Same for Y, but cos Y goes down on screens, we invert\r\n        const yOffset =\r\n            snappedOrigin.y % dimensions.size !== 0\r\n                ? -Math.sign((1 * Math.round(Math.sin(Math.toRadians(dir)) * 100)) / 100) / 2\r\n                : 0;\r\n        return { x: xOffset * dimensions.size, y: yOffset * dimensions.size };\r\n    })();\r\n\r\n    // Point we are measuring distances from\r\n    const padding = Math.clamp(document.width ?? 0, 1.5, 2);\r\n    const docDistance = document.distance ?? 0;\r\n    const padded = (docDistance * padding) / dimensions.distance;\r\n    const rowCount = Math.ceil(padded / (dimensions.size / canvas.grid.sizeX));\r\n    const columnCount = Math.ceil(padded / (dimensions.size / canvas.grid.sizeY));\r\n\r\n    // If this is an emanation, measure from the outer squares of the token's space\r\n    const offsetEmanationOrigin = (destination) => {\r\n        if (!(areaShape === \"emanation\" && object instanceof Token)) {\r\n            return { x: 0, y: 0 };\r\n        }\r\n\r\n        // No offset is needed for medium and smaller creatures\r\n        if (object.w <= dimensions.size) return { x: 0, y: 0 };\r\n\r\n        const offset = (object.w - dimensions.size) / 2;\r\n        const getCoordinate = (centerCoord, destCoord) =>\r\n            destCoord === centerCoord ? 0 : destCoord > centerCoord ? offset : -offset;\r\n\r\n        return {\r\n            x: getCoordinate(object.center.x, destination.x),\r\n            y: getCoordinate(object.center.y, destination.y),\r\n        };\r\n    };\r\n\r\n    for (let a = -columnCount; a < columnCount; a++) {\r\n        for (let b = -rowCount; b < rowCount; b++) {\r\n            // Position of cell's top-left corner, in pixels\r\n            const { x: gx, y: gy } = canvas.grid.getTopLeftPoint({ i: col0 + a, j: row0 + b });\r\n            // Position of cell's center in pixels\r\n            const destination = {\r\n                x: gx + dimensions.size * 0.5,\r\n                y: gy + dimensions.size * 0.5,\r\n            };\r\n            if (destination.x < 0 || destination.y < 0) continue;\r\n\r\n            // Determine point of origin\r\n            const emanationOriginOffset = offsetEmanationOrigin(destination);\r\n            const origin = {\r\n                x: snappedOrigin.x + coneOriginOffset.x + emanationOriginOffset.x,\r\n                y: snappedOrigin.y + coneOriginOffset.y + emanationOriginOffset.y,\r\n            };\r\n\r\n            if (areaShape === \"cone\") {\r\n                const ray = new Ray(origin, destination);\r\n                const rayAngle = (360 + ((ray.angle / (Math.PI / 180)) % 360)) % 360;\r\n                if (ray.distance > 0 && !withinAngle(minAngle, maxAngle, rayAngle)) {\r\n                    continue;\r\n                }\r\n            }\r\n\r\n            // Determine grid-square point to which we're measuring the distance\r\n            const distance = measureDistance(destination, origin);\r\n            if (distance > docDistance) continue;\r\n\r\n            const hasCollision =\r\n                canvas.ready &&\r\n                CONFIG.Canvas.polygonBackends[collisionType].testCollision(\r\n                    collisionOrigin ?? origin,\r\n                    destination,\r\n                    {\r\n                        type: collisionType,\r\n                        mode: \"any\",\r\n                    }\r\n                );\r\n\r\n            if (hasCollision) {\r\n                grid.highlightPosition(highlightLayer.name, {\r\n                    x: gx,\r\n                    y: gy,\r\n                    border: 0x000001,\r\n                    color: 0x000000,\r\n                });\r\n                highlightLayer\r\n                    .beginFill(0x000000, 0.5)\r\n                    .moveTo(gx, gy)\r\n                    .lineTo(gx + dimensions.size, gy + dimensions.size)\r\n                    .endFill();\r\n            } else {\r\n                grid.highlightPosition(highlightLayer.name, {\r\n                    x: gx,\r\n                    y: gy,\r\n                    border: colors.border,\r\n                    color: colors.fill,\r\n                });\r\n            }\r\n        }\r\n    }\r\n}\r\n", "import {\r\n    DARKNESS_COLOR,\r\n    DARKNESS_SLUGS,\r\n    MIST_COLOR,\r\n    MIST_SLUGS,\r\n    POISON_GREEN,\r\n} from \"./constants.js\";\r\nimport { MODULE_ID, getFlag, localize } from \"./module.js\";\r\nimport { highlightGrid } from \"./pf2e/highlight.js\";\r\n\r\nconst templateConversion = {\r\n    burst: \"circle\",\r\n    cone: \"cone\",\r\n    cube: \"rect\",\r\n    cylinder: \"circle\",\r\n    emanation: \"circle\",\r\n    line: \"ray\",\r\n    square: \"rect\",\r\n};\r\n\r\nexport function createTemplate({ type, distance, traits, fillColor, width, flags }) {\r\n    const templateData = {\r\n        t: templateConversion[type],\r\n        distance,\r\n        fillColor: fillColor || game.user.color,\r\n        flags: {\r\n            [MODULE_ID]: flags,\r\n        },\r\n    };\r\n\r\n    switch (templateData.t) {\r\n        case \"ray\":\r\n            templateData.width =\r\n                Number(width) ||\r\n                CONFIG.MeasuredTemplate.defaults.width * canvas.dimensions.distance;\r\n            break;\r\n        case \"cone\":\r\n            templateData.angle = CONFIG.MeasuredTemplate.defaults.angle;\r\n            break;\r\n        case \"rect\": {\r\n            const distance = templateData.distance ?? 0;\r\n            templateData.distance = Math.hypot(distance, distance);\r\n            templateData.width = distance;\r\n            templateData.direction = 45;\r\n            break;\r\n        }\r\n    }\r\n\r\n    if (traits) foundry.utils.setProperty(templateData, \"flags.pf2e.origin.traits\", traits);\r\n\r\n    canvas.templates.createPreview(templateData);\r\n}\r\n\r\nexport function createSeekTemplate({ type = \"burst\", token, distance }) {\r\n    if (!checkScene(token)) return;\r\n\r\n    distance ??= type === \"cone\" ? 30 : 15;\r\n\r\n    createTemplate({\r\n        type,\r\n        distance,\r\n        traits: [\"concentrate\", \"secret\"],\r\n        flags: {\r\n            type: \"seek\",\r\n            tokenId: token.id,\r\n            collisionType: \"sight\",\r\n            collisionOrigin: token.center,\r\n        },\r\n    });\r\n}\r\n\r\nexport function createDarknessTemplate({ type = \"burst\", distance = 20, conceal = false } = {}) {\r\n    createTemplate({\r\n        type,\r\n        distance,\r\n        fillColor: DARKNESS_COLOR,\r\n        flags: {\r\n            type: \"darkness\",\r\n            conceal,\r\n        },\r\n    });\r\n}\r\n\r\nexport function createMistTemplate({ type = \"burst\", distance = 20 } = {}) {\r\n    createTemplate({\r\n        type,\r\n        distance,\r\n        fillColor: MIST_COLOR,\r\n        flags: {\r\n            type: \"mist\",\r\n        },\r\n    });\r\n}\r\n\r\nfunction getTemplates(type, token) {\r\n    if (token && !checkScene(token)) return null;\r\n    return canvas.scene.templates.filter((t) => getFlag(t, \"type\") === type) ?? [];\r\n}\r\n\r\nexport function getDarknessTemplates(token) {\r\n    return getTemplates(\"darkness\", token);\r\n}\r\n\r\nexport function getMistTemplates(token) {\r\n    return getTemplates(\"mist\", token);\r\n}\r\n\r\nexport function getSeekTemplateTokens(token) {\r\n    if (!checkScene(token)) return null;\r\n\r\n    const template = canvas.scene.templates.find((t) => getFlag(t, \"type\") === \"seek\");\r\n    if (!template) return null;\r\n\r\n    const tokenDoc = token instanceof Token ? token.document : token;\r\n\r\n    return getTemplateTokens(template, {\r\n        collisionType: \"sight\",\r\n        collisionOrigin: tokenDoc.center,\r\n    });\r\n}\r\n\r\nexport async function deleteSeekTemplate(token) {\r\n    const templates = token.scene.templates.filter(\r\n        (t) => getFlag(t, \"type\") === \"seek\" && getFlag(t, \"tokenId\") === token.id\r\n    );\r\n    for (const template of templates) {\r\n        await template.delete();\r\n    }\r\n}\r\n\r\nfunction checkScene(token) {\r\n    if (canvas.scene === token.scene) return true;\r\n    ui.notifications.error(localize(\"template.scene\"));\r\n    return false;\r\n}\r\n\r\nexport function getTemplateTokens(\r\n    measuredTemplate,\r\n    { collisionOrigin, collisionType = \"move\" } = {}\r\n) {\r\n    const grid = canvas.interface.grid;\r\n    const dimensions = canvas.dimensions;\r\n    const template =\r\n        measuredTemplate instanceof MeasuredTemplateDocument\r\n            ? measuredTemplate.object\r\n            : measuredTemplate;\r\n    if (!canvas.scene || !template?.highlightId || !grid || !dimensions) return [];\r\n\r\n    const gridHighlight = grid.getHighlightLayer(template.highlightId);\r\n    if (!gridHighlight || canvas.grid.type !== CONST.GRID_TYPES.SQUARE) return [];\r\n\r\n    const gridSize = canvas.grid.size;\r\n    const containedTokens = [];\r\n    const origin = collisionOrigin ?? template.center;\r\n    const tokens = canvas.tokens.quadtree.getObjects(gridHighlight.getLocalBounds(undefined, true));\r\n\r\n    for (const token of tokens) {\r\n        const tokenDoc = token.document;\r\n        const tokenPositions = [];\r\n\r\n        for (let h = 0; h < tokenDoc.height; h++) {\r\n            const tokenX = Math.floor(token.x / gridSize) * gridSize;\r\n            const tokenY = Math.floor(token.y / gridSize) * gridSize;\r\n            const y = tokenY + h * gridSize;\r\n\r\n            tokenPositions.push(`${tokenX},${y}`);\r\n\r\n            if (tokenDoc.width > 1) {\r\n                for (let w = 1; w < tokenDoc.width; w++) {\r\n                    tokenPositions.push(`${tokenX + w * gridSize},${y}`);\r\n                }\r\n            }\r\n        }\r\n\r\n        for (const position of tokenPositions) {\r\n            if (!gridHighlight.positions.has(position)) {\r\n                continue;\r\n            }\r\n\r\n            const [gx, gy] = position.split(\",\").map((s) => Number(s));\r\n            const destination = {\r\n                x: gx + dimensions.size * 0.5,\r\n                y: gy + dimensions.size * 0.5,\r\n            };\r\n            if (destination.x < 0 || destination.y < 0) continue;\r\n\r\n            const hasCollision = CONFIG.Canvas.polygonBackends[collisionType].testCollision(\r\n                origin,\r\n                destination,\r\n                {\r\n                    type: collisionType,\r\n                    mode: \"any\",\r\n                }\r\n            );\r\n\r\n            if (!hasCollision) {\r\n                containedTokens.push(token);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    return containedTokens;\r\n}\r\n\r\nexport function highlightTemplateGrid() {\r\n    const isCircleOrCone = [\"circle\", \"cone\"].includes(this.document.t);\r\n    const hasSquareGrid = canvas.grid.type === CONST.GRID_TYPES.SQUARE;\r\n    if (!isCircleOrCone || !hasSquareGrid) {\r\n        return MeasuredTemplate.prototype.highlightGrid.call(this);\r\n    }\r\n\r\n    // Refrain from highlighting if not visible\r\n    if (!this.isVisible) {\r\n        canvas.interface.grid.getHighlightLayer(this.highlightId)?.clear();\r\n        return;\r\n    }\r\n\r\n    const collisionType = getFlag(this.document, \"collisionType\");\r\n    const collisionOrigin = getFlag(this.document, \"collisionOrigin\");\r\n\r\n    highlightGrid({\r\n        areaShape: this.areaShape,\r\n        object: this,\r\n        document: this.document,\r\n        colors: {\r\n            border: Number(this.document.borderColor),\r\n            fill: Number(this.document.fillColor),\r\n        },\r\n        preview: true,\r\n        // added stuff\r\n        collisionType,\r\n        collisionOrigin,\r\n    });\r\n}\r\n\r\nexport function preCreateMeasuredTemplate(template) {\r\n    const { type, slug, castLevel = 0 } = template.getFlag(\"pf2e\", \"origin\") ?? {};\r\n    if (type !== \"spell\") return;\r\n\r\n    if (DARKNESS_SLUGS.includes(slug)) {\r\n        template.updateSource({\r\n            fillColor: DARKNESS_COLOR,\r\n            [`flags.${MODULE_ID}`]: { type: \"darkness\", conceal: castLevel >= 4 },\r\n        });\r\n    } else if (MIST_SLUGS.includes(slug)) {\r\n        template.updateSource({\r\n            fillColor: MIST_COLOR,\r\n            [`flags.${MODULE_ID}`]: { type: \"mist\" },\r\n        });\r\n    } else if (slug === \"cloudkill\") {\r\n        template.updateSource({\r\n            fillColor: POISON_GREEN,\r\n            [`flags.${MODULE_ID}`]: { type: \"mist\" },\r\n        });\r\n    }\r\n}\r\n\r\nexport function onMeasuredTemplate(template) {\r\n    if (getFlag(template, \"type\") === \"darkness\")\r\n        canvas.perception.update({ initializeVision: true });\r\n}\r\n", "export function modifier(value) {\r\n    return value >= 0 ? `+${value}` : value;\r\n}\r\n\r\nexport function omit(object, names) {\r\n    const set = new Set(names);\r\n    return Object.entries(object).reduce((acc, [name, value]) => {\r\n        if (!set.has(name)) acc[name] = value;\r\n        return acc;\r\n    }, {});\r\n}\r\n\r\nexport function getPrototype(obj, depth = 1) {\r\n    const prototype = Object.getPrototypeOf(obj);\r\n    if (depth > 1) return getPrototype(prototype, depth - 1);\r\n    return prototype;\r\n}\r\n\r\nexport function sortByName(a, b) {\r\n    return a.name.localeCompare(b.name);\r\n}\r\n\r\nexport function asNumberOnly(value) {\r\n    value = Number(value);\r\n    return isNaN(value) ? undefined : value;\r\n}\r\n", "import { COVERS, VISIBILITIES, defaultValues } from \"../constants.js\";\r\nimport { MODULE_ID, localize } from \"../module.js\";\r\nimport { validateTokens } from \"../scene.js\";\r\nimport { getTokenData, setTokenData } from \"../token.js\";\r\nimport { sortByName } from \"../utils.js\";\r\n\r\nexport class BaseMenu extends Application {\r\n    #token;\r\n    #resolve;\r\n    #selected;\r\n    #_currentData;\r\n    #hoverTokenListener;\r\n\r\n    constructor({ token, resolve, selected = [] }, options = {}) {\r\n        super(options);\r\n\r\n        this.#token = token;\r\n        this.#resolve = resolve;\r\n        this.#selected = selected;\r\n\r\n        this.#hoverTokenListener = (token, hover) => {\r\n            const tokenId = token.id;\r\n            const tokens = this.element.find(\"[data-token-id]\");\r\n            tokens.removeClass(\"hover\");\r\n            if (hover) tokens.filter(`[data-token-id=${tokenId}]`).addClass(\"hover\");\r\n        };\r\n\r\n        Hooks.on(\"hoverToken\", this.#hoverTokenListener);\r\n    }\r\n\r\n    async close(options = {}) {\r\n        Hooks.off(\"hoverToken\", this.#hoverTokenListener);\r\n        this.#resolve?.(options.resolve ?? false);\r\n        super.close(options);\r\n    }\r\n\r\n    static get defaultOptions() {\r\n        return foundry.utils.mergeObject(Application.defaultOptions, {\r\n            minimizable: false,\r\n        });\r\n    }\r\n\r\n    static async openMenu(params, options = {}) {\r\n        if (params.token instanceof TokenDocument) params.token = params.token.object;\r\n        if (!params.token) {\r\n            ui.notifications.error(localize(\"menu.no-token\"));\r\n            return;\r\n        }\r\n\r\n        options.id = `${MODULE_ID}-${params.token.document.uuid}`;\r\n\r\n        const win = Object.values(ui.windows).find((x) => x.id === options.id);\r\n        if (win) win.close();\r\n\r\n        return new Promise((resolve) => {\r\n            params.resolve = resolve;\r\n            // biome-ignore lint/complexity/noThisInStatic: not working\r\n            new this(params, options).render(true);\r\n        });\r\n    }\r\n\r\n    static createPropertyData(original, current, property) {\r\n        const defaultValue = defaultValues[property];\r\n        const originalValue = original[property] ?? defaultValue;\r\n        const currentValue = current[property] ?? defaultValue;\r\n        return {\r\n            original: originalValue,\r\n            current: currentValue,\r\n            changed: originalValue !== currentValue,\r\n            custom: currentValue !== defaultValue,\r\n            originalCustom: originalValue !== defaultValue,\r\n        };\r\n    }\r\n\r\n    get token() {\r\n        return this.#token;\r\n    }\r\n\r\n    get document() {\r\n        return this.#token.document;\r\n    }\r\n\r\n    get actor() {\r\n        return this.#token.actor;\r\n    }\r\n\r\n    get scene() {\r\n        return this.#token.scene;\r\n    }\r\n\r\n    get selected() {\r\n        return this.#selected.length ? validateTokens(this.token, this.#selected) : [];\r\n    }\r\n\r\n    get currentData() {\r\n        return foundry.utils.deepClone(this.#currentData);\r\n    }\r\n\r\n    get #currentData() {\r\n        if (!this.#_currentData) this.#_currentData = this.getSavedData();\r\n        return this.#_currentData;\r\n    }\r\n\r\n    getSavedData() {\r\n        const data = getTokenData(this.document) ?? {};\r\n        return foundry.utils.deepClone(data);\r\n    }\r\n\r\n    reset() {\r\n        this.#_currentData = this.getSavedData();\r\n        this.#selected = [];\r\n        this.render();\r\n    }\r\n\r\n    isSelected(token) {\r\n        const id = typeof token === \"object\" ? token.id : token;\r\n        return this.#selected.includes(id);\r\n    }\r\n\r\n    getData(options) {\r\n        return {\r\n            i18n: localize,\r\n            covers: COVERS.map((value) => ({ value, label: localize(`cover.${value}`) })),\r\n            visibilities: VISIBILITIES.map((value) => ({\r\n                value,\r\n                label: localize(`visibility.${value}`),\r\n            })),\r\n        };\r\n    }\r\n\r\n    activateListeners(html) {\r\n        html.find(\"[data-token-id]\").on(\"mouseenter\", (event) => {\r\n            const { tokenId } = event.currentTarget.dataset;\r\n            const token = this.scene.tokens.get(tokenId)?.object;\r\n            if (!token || token.controlled) return;\r\n            token._onHoverIn(event, { hoverOutOthers: true });\r\n        });\r\n\r\n        html.find(\"[data-action=close]\").on(\"click\", () => {\r\n            this.close({ resolve: true });\r\n        });\r\n\r\n        html.find(\"select[name=visibility], select[name=cover]\").on(\"change\", (event) => {\r\n            const target = event.currentTarget;\r\n            const property = target.name;\r\n            const defaultValue = defaultValues[property];\r\n            const value = target.value || defaultValue;\r\n            const tokenId = target.closest(\".token\")?.dataset.tokenId;\r\n            const tokenIds = tokenId ? [tokenId] : this.#selected;\r\n\r\n            for (const tokenId of tokenIds) {\r\n                foundry.utils.setProperty(this.#currentData, `${tokenId}.${property}`, value);\r\n            }\r\n\r\n            if (tokenId) {\r\n                target.classList.toggle(\"changed\", value !== target.dataset.original);\r\n                target.classList.toggle(\"custom\", value !== defaultValue);\r\n            } else this.render();\r\n        });\r\n\r\n        html.find(\"[data-action=accept]\").on(\"click\", (event) => {\r\n            this._saveData(this.#currentData);\r\n            this.close({ resolve: true });\r\n        });\r\n    }\r\n\r\n    _saveData(currentData) {\r\n        setTokenData(this.document, currentData);\r\n    }\r\n\r\n    _setSelected(selected) {\r\n        this.#selected =\r\n            selected ??\r\n            this.element\r\n                .find(\"[data-token-id].ui-selected\")\r\n                .toArray()\r\n                .map((el) => el.dataset.tokenId);\r\n    }\r\n\r\n    _spliIntoAlliances(tokens) {\r\n        const allies = [];\r\n        const enemies = [];\r\n        const neutral = [];\r\n\r\n        const alliance = this.actor.alliance;\r\n        const opposition =\r\n            alliance === \"party\" ? \"opposition\" : alliance === \"opposition\" ? \"party\" : null;\r\n\r\n        for (const token of tokens) {\r\n            if (opposition) {\r\n                const actorAlliance = token.actor ? token.actor.alliance : token.alliance;\r\n                if (actorAlliance === alliance) allies.push(token);\r\n                else if (actorAlliance === opposition) enemies.push(token);\r\n                else if (actorAlliance === null) neutral.push(token);\r\n            } else neutral.push(token);\r\n        }\r\n\r\n        return {\r\n            allies: allies.sort(sortByName),\r\n            neutral: neutral.sort(sortByName),\r\n            enemies: enemies.sort(sortByName),\r\n            hasTokens: allies.length || enemies.length || neutral.length,\r\n        };\r\n    }\r\n}\r\n", "import { localize, templatePath } from \"../module.js\";\r\nimport { getValidTokens } from \"../scene.js\";\r\nimport { BaseMenu } from \"./base-menu.js\";\r\n\r\nexport class PerceptionMenu extends BaseMenu {\r\n    get title() {\r\n        return localize(\"menu.perception.title\", { name: this.token.name });\r\n    }\r\n\r\n    get template() {\r\n        return templatePath(\"perception\");\r\n    }\r\n\r\n    getData(options) {\r\n        const selected = this.selected;\r\n        const currentData = this.currentData;\r\n        const originalData = this.getSavedData();\r\n\r\n        const tokens = getValidTokens(this.token).map(({ id, name, actor }) => {\r\n            const current = currentData[id] ?? {};\r\n            const original = originalData[id] ?? {};\r\n\r\n            return {\r\n                id,\r\n                name,\r\n                alliance: actor.alliance,\r\n                cover: BaseMenu.createPropertyData(original, current, \"cover\"),\r\n                visibility: BaseMenu.createPropertyData(original, current, \"visibility\"),\r\n                selected: selected.includes(id),\r\n            };\r\n        });\r\n\r\n        return {\r\n            ...super.getData(options),\r\n            ...this._spliIntoAlliances(tokens),\r\n        };\r\n    }\r\n\r\n    activateListeners(html) {\r\n        super.activateListeners(html);\r\n\r\n        html.filter(\".tokens\").selectable({\r\n            autoRefresh: false,\r\n            filter: \".token\",\r\n            cancel: \"header,select\",\r\n            stop: () => this._setSelected(),\r\n        });\r\n\r\n        html.find(\"[data-action=select-all]\").on(\"click\", (event) => {\r\n            const section = $(event.currentTarget).closest(\"section\");\r\n            const tokens = (section.length ? section : html).find(\"[data-token-id]\");\r\n            const allSelected = tokens.filter(\":not(.ui-selected)\").length === 0;\r\n            tokens.toggleClass(\"ui-selected\", !allSelected);\r\n            this._setSelected();\r\n        });\r\n\r\n        html.find(\"[data-action=use-selection]\").on(\"click\", (event) => {\r\n            this._setSelected(canvas.tokens.controlled.map((t) => t.id));\r\n            this.render();\r\n        });\r\n\r\n        html.find(\"[data-action=reset]\").on(\"click\", (event) => this.reset());\r\n    }\r\n}\r\n", "export const RECT_CORNERS = [\r\n    { x: 0, y: 0 },\r\n    { x: 1, y: 0 },\r\n    { x: 0, y: 1 },\r\n    { x: 1, y: 1 },\r\n];\r\n\r\nexport const RECT_SPREAD = [\r\n    { x: 0.25, y: 0.25 },\r\n    { x: 0.5, y: 0.25 },\r\n    { x: 0.75, y: 0.25 },\r\n    { x: 0.25, y: 0.5 },\r\n    { x: 0.5, y: 0.5 },\r\n    { x: 0.75, y: 0.5 },\r\n    { x: 0.25, y: 0.75 },\r\n    { x: 0.5, y: 0.75 },\r\n    { x: 0.75, y: 0.75 },\r\n];\r\n\r\nexport function getRectEdges(rect, margin) {\r\n    const opposite = 1 - margin;\r\n    return {\r\n        top: {\r\n            A: getRectPoint({ x: margin, y: margin }, rect),\r\n            B: getRectPoint({ x: opposite, y: margin }, rect),\r\n        },\r\n        right: {\r\n            A: getRectPoint({ x: opposite, y: margin }, rect),\r\n            B: getRectPoint({ x: opposite, y: opposite }, rect),\r\n        },\r\n        bottom: {\r\n            A: getRectPoint({ x: opposite, y: opposite }, rect),\r\n            B: getRectPoint({ x: margin, y: opposite }, rect),\r\n        },\r\n        left: {\r\n            A: getRectPoint({ x: margin, y: opposite }, rect),\r\n            B: getRectPoint({ x: margin, y: margin }, rect),\r\n        },\r\n    };\r\n}\r\n\r\nexport function lineIntersectWall(origin, target, debug = false) {\r\n    if (debug) drawDebugLine(origin, target);\r\n    return CONFIG.Canvas.polygonBackends.move.testCollision(origin, target, {\r\n        type: \"move\",\r\n        mode: \"any\",\r\n    });\r\n}\r\n\r\nexport function pointToTokenIntersectWall(origin, token, debug = false) {\r\n    for (const point of rectSpread(token.bounds)) {\r\n        if (lineIntersectWall(origin, point, debug)) return true;\r\n    }\r\n    return false;\r\n}\r\n\r\nexport function getRectPoint(point, rect) {\r\n    return { x: rect.x + rect.width * point.x, y: rect.y + rect.height * point.y };\r\n}\r\n\r\nexport function clearDebug() {\r\n    canvas.controls.debug.clear();\r\n}\r\n\r\nexport function drawDebugLine(origin, target, color = \"blue\") {\r\n    const hex = color === \"blue\" ? 0x0066cc : color === \"red\" ? 0xff0000 : 0x16a103;\r\n    canvas.controls.debug.lineStyle(4, hex).moveTo(origin.x, origin.y).lineTo(target.x, target.y);\r\n}\r\n\r\nexport function* rectSpread(rect) {\r\n    for (const point of RECT_SPREAD) {\r\n        yield getRectPoint(point, rect);\r\n    }\r\n}\r\n\r\nexport function* rectCorners(rect) {\r\n    for (const point of RECT_CORNERS) {\r\n        yield getRectPoint(point, rect);\r\n    }\r\n}\r\n", "import { clearDebug, drawDebugLine } from \"./geometry.js\";\r\n\r\nexport function getDarknessExposure(token, debug = false) {\r\n    token = token instanceof Token ? token : token.object;\r\n\r\n    if (token.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)) return undefined;\r\n\r\n    const scene = token.scene;\r\n    if (scene !== canvas.scene || !scene.tokenVision) return undefined;\r\n\r\n    if (debug) clearDebug();\r\n\r\n    const center = token.document.center;\r\n    let darkness = null;\r\n\r\n    for (const light of canvas.effects.darknessSources) {\r\n        if (!light.active) continue;\r\n\r\n        const greaterDarkness = light.data.color === 0;\r\n\r\n        if (light.object === token) {\r\n            if (greaterDarkness) return \"greater\";\r\n            darkness = \"darkness\";\r\n            continue;\r\n        }\r\n\r\n        if (!light.shape.contains(center.x, center.y)) {\r\n            if (debug) drawDebugLine(light, center, \"red\");\r\n            continue;\r\n        }\r\n\r\n        if (greaterDarkness) return \"greater\";\r\n        darkness = \"darkness\";\r\n        continue;\r\n    }\r\n\r\n    return darkness;\r\n}\r\n\r\nexport function getLightExposure(token, debug = false) {\r\n    token = token instanceof Token ? token : token.object;\r\n\r\n    if (token.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)) return undefined;\r\n\r\n    const scene = token.scene;\r\n    if (\r\n        scene !== canvas.scene ||\r\n        !scene.tokenVision ||\r\n        scene.environment.darknessLevel < scene.environment.globalLight.darkness.max\r\n    )\r\n        return undefined;\r\n\r\n    if (debug) clearDebug();\r\n\r\n    const center = token.document.center;\r\n    let exposure = null;\r\n\r\n    for (const light of canvas.effects.lightSources) {\r\n        if (!light.active || light instanceof foundry.canvas.sources.GlobalLightSource) continue;\r\n\r\n        const bright = light.data.bright;\r\n        const dim = light.data.dim;\r\n\r\n        if (light.object === token) {\r\n            if (bright) return \"bright\";\r\n            if (dim) exposure = \"dim\";\r\n            continue;\r\n        }\r\n\r\n        if (!light.shape.contains(center.x, center.y)) {\r\n            if (debug) drawDebugLine(light, center, \"red\");\r\n            continue;\r\n        }\r\n\r\n        if (light.ratio === 1 && bright > 0) {\r\n            if (debug) drawDebugLine(light, center, \"green\");\r\n            return \"bright\";\r\n        }\r\n\r\n        if (light.ratio === 0 && bright > 0) {\r\n            if (debug) drawDebugLine(light, center, \"blue\");\r\n            exposure = \"dim\";\r\n            continue;\r\n        }\r\n\r\n        const distance = new Ray(light, center).distance;\r\n        if (distance <= bright) {\r\n            if (debug) {\r\n                drawDebugLine(light, center, \"green\");\r\n                exposure = \"bright\";\r\n            } else return \"bright\";\r\n        } else {\r\n            if (debug) {\r\n                drawDebugLine(light, center, \"blue\");\r\n                if (exposure !== \"bright\") exposure = \"dim\";\r\n            } else exposure = \"dim\";\r\n        }\r\n    }\r\n\r\n    return exposure;\r\n}\r\n", "import { COVERS, VISIBILITIES } from \"./constants.js\";\r\n\r\nconst DATA = {\r\n    cover: {\r\n        cancel: { targets: [\"lesser\", \"standard\", \"greater\", \"greater-prone\"] },\r\n        set: {\r\n            targets: [\"none\", \"lesser\", \"standard\", \"greater\", \"greater-prone\"],\r\n            value: [\"none\", \"lesser\", \"standard\", \"greater\", \"greater-prone\"],\r\n        },\r\n        reduce: { targets: [\"lesser\", \"standard\", \"greater\", \"greater-prone\"] },\r\n        ignore: { targets: \"string\" },\r\n        ignored: { targets: [\"allies\", \"enemies\"] },\r\n        ac: { targets: [\"lesser\", \"standard\", \"greater\", \"greater-prone\"], value: [\"number\"] },\r\n    },\r\n    visibility: {\r\n        cancel: { targets: [\"concealed\", \"hidden\", \"undetected\", \"unnoticed\"] },\r\n        set: {\r\n            targets: [\"observed\", \"concealed\", \"hidden\", \"undetected\", \"unnoticed\"],\r\n            value: [\"observed\", \"concealed\", \"hidden\", \"undetected\", \"unnoticed\"],\r\n        },\r\n        reduce: { targets: [\"concealed\", \"hidden\", \"undetected\", \"unnoticed\"] },\r\n        noff: { targets: [\"hidden\", \"undetected\", \"unnoticed\"] },\r\n        noinvis: {},\r\n        dc: { targets: [\"concealed\", \"hidden\"], value: [\"number\", \"string\"] },\r\n    },\r\n};\r\n\r\nconst SELECTORS = {\r\n    cover: Object.keys(DATA.cover),\r\n    visibility: Object.keys(DATA.visibility),\r\n    all: [...Object.keys(DATA.cover), ...Object.keys(DATA.visibility)],\r\n};\r\n\r\nexport function setupRuleElement() {\r\n    const rollOptionSchema = game.pf2e.RuleElements.builtin.RollOption.defineSchema();\r\n    const PredicateField = rollOptionSchema.predicate.constructor;\r\n    const ResolvableValueField = rollOptionSchema.value.constructor;\r\n\r\n    class PF2ePerceptionRuleElement extends game.pf2e.RuleElement {\r\n        constructor(source, options) {\r\n            if (typeof source.targets === \"string\") source.targets = [source.targets];\r\n\r\n            super({ priority: CONST.ACTIVE_EFFECT_MODES.CUSTOM, ...source }, options);\r\n\r\n            const selectorType = SELECTORS[source.type];\r\n            if (!selectorType) return;\r\n\r\n            if (!selectorType?.includes(source.selector)) {\r\n                this.failValidation(\r\n                    `The type \"${\r\n                        source.type\r\n                    }\" only accepts the following selectors: ${selectorType.join(\", \")}.`\r\n                );\r\n                return;\r\n            }\r\n\r\n            const selector = DATA[source.type]?.[source.selector];\r\n            if (!selector) return;\r\n\r\n            const selectorWarn = (msg) => {\r\n                const { name, uuid } = this.item;\r\n                console.warn(\r\n                    `PF2e System | PF2ePerception rules element on item ${name} (${uuid}) simple warning: ${msg}`\r\n                );\r\n            };\r\n\r\n            const targetsType = Array.isArray(selector.targets)\r\n                ? [...selector.targets, \"all\"]\r\n                : selector.targets;\r\n            const joinedTargets = Array.isArray(targetsType) ? targetsType.join(\", \") : null;\r\n\r\n            if (!targetsType && source.targets?.length) {\r\n                selectorWarn(\r\n                    `The selector \"${source.selector}\" doesn't accept any targets property.`\r\n                );\r\n                return;\r\n            }\r\n\r\n            if (source.selector === \"ignore\" && !source.targets?.length) {\r\n                const msg = `The selector \"${source.selector}\" requires a targets property with the ids of the tokens on the scene that should not give cover.`;\r\n                this.failValidation(msg);\r\n                return;\r\n            }\r\n\r\n            if (joinedTargets && source.targets?.some((t) => !targetsType.includes(t))) {\r\n                const msg = `The targets property of selector \"${source.selector}\" only accepts the following: ${joinedTargets}.`;\r\n                this.failValidation(msg);\r\n                return;\r\n            } else if (\r\n                !joinedTargets &&\r\n                targetsType &&\r\n                source.targets?.some((t) => typeof t !== targetsType)\r\n            ) {\r\n                const msg = `The targets property of selector \"${source.selector}\" needs to be of type \"${targetsType}\".`;\r\n                this.failValidation(msg);\r\n                return;\r\n            }\r\n\r\n            if (!selector.value && source.value) {\r\n                selectorWarn(\r\n                    `The selector \"${source.selector}\" doesn't accept any value property.`\r\n                );\r\n                return;\r\n            }\r\n\r\n            if (source.selector === \"set\") {\r\n                if (!selector.value.includes(source.value)) {\r\n                    const joinedValues = selector.value.join(\", \");\r\n                    const msg = `The selector \"${source.selector}\" only accepts the following: ${joinedValues}.`;\r\n                    this.failValidation(msg);\r\n                }\r\n            } else {\r\n                const sourcevalueType = typeof source.value;\r\n                if (selector.value && !selector.value.includes(sourcevalueType)) {\r\n                    const msg = `The selector \"${source.selector}\" does not accept a value property of type ${sourcevalueType}.`;\r\n                    this.failValidation(msg);\r\n                }\r\n            }\r\n        }\r\n\r\n        static defineSchema() {\r\n            const { fields } = foundry.data;\r\n\r\n            return {\r\n                ...super.defineSchema(),\r\n\r\n                type: new fields.StringField({\r\n                    required: true,\r\n                    nullable: false,\r\n                    blank: false,\r\n                    choices: [\"visibility\", \"cover\"],\r\n                }),\r\n\r\n                affects: new fields.StringField({\r\n                    required: true,\r\n                    nullable: false,\r\n                    blank: false,\r\n                    initial: \"self\",\r\n                    choices: [\"self\", \"other\"],\r\n                }),\r\n\r\n                selector: new fields.StringField({\r\n                    required: true,\r\n                    nullable: false,\r\n                    blank: false,\r\n                }),\r\n\r\n                targets: new fields.ArrayField(\r\n                    new fields.StringField({\r\n                        required: true,\r\n                        nullable: false,\r\n                        blank: false,\r\n                        initial: undefined,\r\n                    }),\r\n                    {\r\n                        required: true,\r\n                        nullable: false,\r\n                        initial: [\"all\"],\r\n                    }\r\n                ),\r\n\r\n                predicate: new PredicateField({\r\n                    required: false,\r\n                    nullable: false,\r\n                }),\r\n\r\n                value: new ResolvableValueField({\r\n                    required: false,\r\n                    initial: undefined,\r\n                }),\r\n            };\r\n        }\r\n\r\n        test(rollOptions, password) {\r\n            if (!password) return false;\r\n            return super.test(rollOptions);\r\n        }\r\n\r\n        addToPerception(affects, perception, options) {\r\n            if (!this.test(options, true)) return;\r\n\r\n            const prefix =\r\n                this.affects === \"self\" ? affects : affects === \"origin\" ? \"target\" : \"origin\";\r\n            const root = `${prefix}.${this.type}.${this.selector}`;\r\n            const verificator = DATA[this.type][this.selector];\r\n\r\n            if (!verificator.targets) {\r\n                foundry.utils.setProperty(perception, root, true);\r\n                return;\r\n            }\r\n\r\n            const targets = this.targets.includes(\"all\") ? verificator.targets : this.targets;\r\n\r\n            if (!verificator.value) {\r\n                for (const target of targets) {\r\n                    const path = `${root}.${target}`;\r\n                    foundry.utils.setProperty(perception, path, true);\r\n                }\r\n                return;\r\n            }\r\n\r\n            for (const target of targets) {\r\n                const path = `${root}.${target}`;\r\n\r\n                let value = foundry.utils.getProperty(perception, path);\r\n                if (value) value.add(this.value);\r\n                else value = new Set([this.value]);\r\n\r\n                foundry.utils.setProperty(perception, path, value);\r\n            }\r\n        }\r\n    }\r\n\r\n    game.pf2e.RuleElements.custom.PF2ePerception = PF2ePerceptionRuleElement;\r\n}\r\n\r\nexport function perceptionRules(origin, target, { distance, extraOptions = [] } = {}) {\r\n    const originActor = origin.actor;\r\n    const targetActor = target.actor;\r\n    if (!originActor || !targetActor) return {};\r\n\r\n    const rules = {\r\n        origin: originActor.rules.filter((r) => !r.ignored && r.key === \"PF2ePerception\") ?? [],\r\n        target: targetActor.rules.filter((r) => !r.ignored && r.key === \"PF2ePerception\") ?? [],\r\n    };\r\n    if (!rules.origin.length && !rules.target.length) return {};\r\n\r\n    const selfOptions = {\r\n        origin: originActor.getRollOptions(),\r\n        target: targetActor.getRollOptions(),\r\n    };\r\n\r\n    const otherOptions = {\r\n        origin: targetActor.getSelfRollOptions(\"target\"),\r\n        target: originActor.getSelfRollOptions(\"origin\"),\r\n    };\r\n\r\n    origin = origin instanceof Token ? origin : origin.object;\r\n    target = target instanceof Token ? target : target.object;\r\n\r\n    distance ??= origin.distanceTo(target);\r\n    const distances = [`origin:distance:${distance}`, `target:distance:${distance}`];\r\n\r\n    const perception = {};\r\n\r\n    for (const prefix of [\"origin\", \"target\"]) {\r\n        const testOptions = [\r\n            ...extraOptions,\r\n            ...selfOptions[prefix],\r\n            ...otherOptions[prefix],\r\n            ...distances,\r\n        ];\r\n        for (const rule of rules[prefix]) {\r\n            rule.addToPerception(prefix, perception, testOptions);\r\n        }\r\n    }\r\n\r\n    return perception;\r\n}\r\n\r\nexport function getIgnoredPerception(token) {\r\n    const actor = token.actor;\r\n    if (!actor) return [];\r\n\r\n    const rules =\r\n        actor.rules.filter(\r\n            (r) =>\r\n                !r.ignored &&\r\n                r.key === \"PF2ePerception\" &&\r\n                r.type === \"cover\" &&\r\n                r.selector === \"ignored\"\r\n        ) ?? [];\r\n\r\n    return rules.flatMap((r) => r.targets);\r\n}\r\n\r\nexport function getPerception(perception, affects, type, selector, targets) {\r\n    let cursor = perception[affects]?.[type]?.[selector];\r\n    return targets ? cursor?.[targets] : cursor;\r\n}\r\n\r\nexport function updateFromPerceptionRules(perception, affects, type, value) {\r\n    if (value === undefined) {\r\n        value = type === \"cover\" ? \"none\" : \"observed\";\r\n    }\r\n\r\n    const list = type === \"cover\" ? COVERS : VISIBILITIES;\r\n\r\n    if (value && getPerception(perception, affects, type, \"cancel\", value)) return undefined;\r\n\r\n    const setValue = getPerception(perception, affects, type, \"set\", value)?.first();\r\n    if (setValue && list.includes(setValue)) {\r\n        value = setValue;\r\n    } else if (value && getPerception(perception, affects, type, \"reduce\", value)) {\r\n        const index = list.indexOf(value);\r\n        value = list[Math.max(0, index - 1)];\r\n    }\r\n\r\n    return value === list[0] ? undefined : value;\r\n}\r\n", "import { getCoverEffect, hasGreaterDarkvision, isProne, seeInvisibility } from \"./actor.js\";\r\nimport { PerceptionMenu } from \"./apps/perception.js\";\r\nimport {\r\n    COVERS,\r\n    COVER_VALUES,\r\n    ICONS_PATHS,\r\n    VISIBILITY_VALUES,\r\n    defaultValues,\r\n} from \"./constants.js\";\r\nimport {\r\n    clearDebug,\r\n    drawDebugLine,\r\n    getRectEdges,\r\n    lineIntersectWall,\r\n    pointToTokenIntersectWall,\r\n} from \"./geometry.js\";\r\nimport { getLightExposure } from \"./lighting.js\";\r\nimport { MODULE_ID, getFlag, getSetting, hasPermission, unsetFlag } from \"./module.js\";\r\nimport { getIgnoredPerception, getPerception, updateFromPerceptionRules } from \"./rule-element.js\";\r\nimport { getSceneSetting, getValidTokens } from \"./scene.js\";\r\nimport { getDarknessTemplates, getMistTemplates, getTemplateTokens } from \"./template.js\";\r\n\r\nexport function renderTokenHUD(hud, html) {\r\n    if (!hasPermission() || !hud.object.actor?.isOfType(\"creature\")) return;\r\n    html.find(\".col.left\").append(\r\n        `<div class=\"control-icon\" data-action=\"pf2e-perception\"><i class=\"fa-solid fa-eye\"></i></div>`\r\n    );\r\n    html.find(\"[data-action=pf2e-perception]\").on(\"click\", (event) => openHUD(hud.object));\r\n}\r\n\r\nexport function openHUD(token) {\r\n    return PerceptionMenu.openMenu({ token });\r\n}\r\n\r\nexport function pasteToken(originals, sources) {\r\n    for (const source of sources) {\r\n        delete source.flags?.[MODULE_ID];\r\n    }\r\n}\r\n\r\nexport function getTokenData(token, ...path) {\r\n    path.unshift(\"data\");\r\n    token = token instanceof Token ? token.document : token;\r\n    return getFlag(token, path.join(\".\"));\r\n}\r\n\r\nexport async function clearTokenData(token) {\r\n    token = token instanceof Token ? token.document : token;\r\n    return unsetFlag(token, \"data\");\r\n}\r\n\r\nexport async function setTokenData(token, data) {\r\n    const valid = getValidTokens(token).map((t) => t.id);\r\n    const updates = {};\r\n\r\n    for (const tokenId in data) {\r\n        if (!valid.includes(tokenId)) {\r\n            updates[`flags.${MODULE_ID}.data.-=${tokenId}`] = null;\r\n            continue;\r\n        }\r\n\r\n        const current = data[tokenId];\r\n        const original = getTokenData(token, tokenId) ?? {};\r\n\r\n        if (current.visibility === defaultValues.visibility) delete current.visibility;\r\n        if (current.cover === defaultValues.cover) delete current.cover;\r\n\r\n        if (original.cover === current.cover && original.visibility === current.visibility)\r\n            continue;\r\n\r\n        if (!current.visibility && !current.cover) {\r\n            updates[`flags.${MODULE_ID}.data.-=${tokenId}`] = null;\r\n        } else {\r\n            for (const property of [\"cover\", \"visibility\"]) {\r\n                if (original[property] === current[property]) continue;\r\n                if (!current[property])\r\n                    updates[`flags.${MODULE_ID}.data.${tokenId}.-=${property}`] = null;\r\n                else updates[`flags.${MODULE_ID}.data.${tokenId}.${property}`] = current[property];\r\n            }\r\n        }\r\n    }\r\n\r\n    token = token instanceof Token ? token.document : token;\r\n    return token.update(updates);\r\n}\r\n\r\nexport function getWallCover(origin, target, debug = false) {\r\n    const scene = origin.scene;\r\n    if (!getSceneSetting(scene, \"standard\")) return;\r\n\r\n    if (debug) clearDebug();\r\n\r\n    const standard = getSetting(\"standard-type\");\r\n    const intersects =\r\n        standard === \"points\"\r\n            ? pointToTokenIntersectWall(origin.center, target, debug)\r\n            : lineIntersectWall(origin.center, target.center, debug);\r\n\r\n    return intersects ? \"standard\" : undefined;\r\n}\r\n\r\nconst SIZES = {\r\n    tiny: 0,\r\n    sm: 1,\r\n    med: 2,\r\n    lg: 3,\r\n    huge: 4,\r\n    grg: 5,\r\n};\r\n\r\nexport function getCover(\r\n    origin,\r\n    target,\r\n    { perception = {}, options = [], affects = \"origin\", debug = false } = {}\r\n) {\r\n    const prone = options.includes(\"item:ranged\") ? isProne(target.actor) : false;\r\n\r\n    const returnValue = (value) => {\r\n        return updateFromPerceptionRules(perception, affects, \"cover\", value);\r\n    };\r\n\r\n    let systemCover = getCoverEffect(target.actor, true);\r\n    if (prone && COVER_VALUES[systemCover] > COVER_VALUES.lesser)\r\n        return returnValue(\"greater-prone\");\r\n\r\n    if (!prone && systemCover === \"greater-prone\") systemCover = undefined;\r\n\r\n    let cover = getTokenData(target, origin.id, \"cover\");\r\n    if (prone && COVER_VALUES[cover] > COVER_VALUES.lesser) return returnValue(\"greater-prone\");\r\n\r\n    if (!prone && cover === \"greater-prone\") cover = undefined;\r\n\r\n    if (COVER_VALUES[systemCover] < COVER_VALUES.standard) {\r\n        const api = game.modules.get(MODULE_ID).custom ?? {};\r\n\r\n        if (COVER_VALUES[cover] < COVER_VALUES.standard) {\r\n            const custom = api.getWallCover;\r\n            let wallCover;\r\n\r\n            if (typeof custom === \"function\") {\r\n                const customCover = custom(origin, target, debug);\r\n                wallCover = COVERS.includes(customCover)\r\n                    ? customCover\r\n                    : getWallCover(origin, target, debug);\r\n            } else {\r\n                wallCover = getWallCover(origin, target, debug);\r\n            }\r\n\r\n            if (COVER_VALUES[wallCover] > COVER_VALUES[cover]) cover = wallCover;\r\n        }\r\n\r\n        if (COVER_VALUES[cover] < COVER_VALUES.standard && origin.distanceTo(target) > 5) {\r\n            const custom = api.getCreatureCover;\r\n            let creatureCover;\r\n\r\n            if (typeof custom === \"function\") {\r\n                const customCover = custom(origin, target, { perception, debug });\r\n                creatureCover = COVERS.includes(customCover)\r\n                    ? customCover\r\n                    : getCreatureCover(origin, target, { perception, debug });\r\n            } else {\r\n                creatureCover = getCreatureCover(origin, target, { perception, debug });\r\n            }\r\n\r\n            if (COVER_VALUES[creatureCover] > COVER_VALUES[cover]) cover = creatureCover;\r\n        }\r\n    }\r\n\r\n    if (prone && COVER_VALUES[cover] > COVER_VALUES.lesser) return returnValue(\"greater-prone\");\r\n    return returnValue(COVER_VALUES[cover] > COVER_VALUES[systemCover] ? cover : undefined);\r\n}\r\n\r\nexport function getCreatureCover(\r\n    originToken,\r\n    targetToken,\r\n    { perception = {}, debug = false } = {}\r\n) {\r\n    const setting = getSetting(\"lesser\");\r\n    if (setting === \"none\") return undefined;\r\n\r\n    originToken = originToken instanceof Token ? originToken.document : originToken;\r\n    targetToken = targetToken instanceof Token ? targetToken.document : targetToken;\r\n\r\n    const ignoreIds = (() => {\r\n        const originIds = Object.keys(perception.origin?.cover?.ignore ?? {});\r\n        const targetIds = Object.keys(perception.target?.cover?.ignore ?? {});\r\n        return new Set([...originIds, ...targetIds]);\r\n    })();\r\n\r\n    let cover = undefined;\r\n    const origin = originToken.center;\r\n    const target = targetToken.center;\r\n\r\n    const originActor = originToken.actor;\r\n    const targetActor = targetToken.actor;\r\n\r\n    if (debug) {\r\n        clearDebug();\r\n        drawDebugLine(origin, target);\r\n    }\r\n\r\n    const isExtraLarge = (token) => {\r\n        const size = SIZES[token.actor.size];\r\n        return size - originSize >= 2 && size - targetSize >= 2;\r\n    };\r\n\r\n    const originSize = SIZES[originActor.size];\r\n    const targetSize = SIZES[targetActor.size];\r\n\r\n    const originAlliance = originActor.alliance;\r\n    const deadCover = getSetting(\"dead-cover\");\r\n    const proneCover = getSetting(\"prone-cover\");\r\n\r\n    const tokens = originToken.scene.tokens.contents\r\n        .filter((token) => {\r\n            const actor = token.actor;\r\n            const ignored = getIgnoredPerception(token);\r\n\r\n            return (\r\n                actor &&\r\n                !token.hidden &&\r\n                token !== originToken &&\r\n                token !== targetToken &&\r\n                (proneCover || !isProne(actor)) &&\r\n                (deadCover || actor.hitPoints?.value !== 0) &&\r\n                !ignoreIds.has(token.id) &&\r\n                !(\r\n                    ignored.includes(\"all\") ||\r\n                    ignored.includes(actor.alliance === originAlliance ? \"allies\" : \"enemies\")\r\n                )\r\n            );\r\n        })\r\n        .sort((a, b) => SIZES[b.actor.size] - SIZES[a.actor.size]);\r\n\r\n    let extralarges =\r\n        originSize < SIZES.huge && targetSize < SIZES.huge && tokens.filter(isExtraLarge).length;\r\n\r\n    const margin = setting === \"ten\" ? 0.1 : setting === \"twenty\" ? 0.2 : 0;\r\n\r\n    const intersectsEdge = (edge) => {\r\n        if (debug) drawDebugLine(edge.A, edge.B, \"red\");\r\n        return foundry.utils.lineSegmentIntersects(origin, target, edge.A, edge.B);\r\n    };\r\n\r\n    const intersectsWith =\r\n        setting === \"cross\"\r\n            ? (edges) => {\r\n                  return (\r\n                      (intersectsEdge(edges.top) && intersectsEdge(edges.bottom)) ||\r\n                      (intersectsEdge(edges.left) && intersectsEdge(edges.right))\r\n                  );\r\n              }\r\n            : (edges) => Object.values(edges).some((edge) => intersectsEdge(edge));\r\n\r\n    for (const tokenDocument of tokens) {\r\n        const token = tokenDocument.object;\r\n        const edges = getRectEdges(token.bounds, margin);\r\n        if (intersectsWith(edges)) return extralarges ? \"standard\" : \"lesser\";\r\n        else if (isExtraLarge(tokenDocument)) extralarges--;\r\n    }\r\n\r\n    return cover;\r\n}\r\n\r\nexport function getVisibility(\r\n    origin,\r\n    target,\r\n    { perception = {}, affects = \"origin\", debug = false } = {}\r\n) {\r\n    origin = origin instanceof Token ? origin : origin.object;\r\n    target = target instanceof Token ? target : target.object;\r\n\r\n    const originActor = origin.actor;\r\n    const targetActor = target.actor;\r\n\r\n    let systemVisibility = (() => {\r\n        if (!originActor || !targetActor) return;\r\n\r\n        let visibility;\r\n\r\n        if (targetActor.hasCondition(\"blinded\")) visibility = \"hidden\";\r\n        else if (targetActor.hasCondition(\"dazzled\")) visibility = \"concealed\";\r\n\r\n        for (const condition of [\"unnoticed\", \"undetected\", \"hidden\", \"concealed\"]) {\r\n            if (\r\n                VISIBILITY_VALUES[condition] > VISIBILITY_VALUES[visibility] &&\r\n                originActor.hasCondition(condition)\r\n            )\r\n                visibility = condition;\r\n        }\r\n\r\n        return visibility;\r\n    })();\r\n\r\n    const returnValue = (value) => {\r\n        if (!isInvisible)\r\n            return updateFromPerceptionRules(perception, affects, \"visibility\", value);\r\n\r\n        if (VISIBILITY_VALUES[value] < VISIBILITY_VALUES.hidden) value = \"hidden\";\r\n\r\n        const seeInvis =\r\n            seeInvisibility(targetActor) ||\r\n            getPerception(perception, affects, \"visibility\", \"noinvis\");\r\n        if (seeInvis) value = \"concealed\";\r\n\r\n        return updateFromPerceptionRules(perception, affects, \"visibility\", value);\r\n    };\r\n\r\n    const isInvisible = originActor?.hasCondition(\"invisible\");\r\n    const visibility = getTokenData(origin, target.id, \"visibility\");\r\n    let mergedVisibility =\r\n        VISIBILITY_VALUES[systemVisibility] > VISIBILITY_VALUES[visibility]\r\n            ? systemVisibility\r\n            : visibility;\r\n\r\n    if (VISIBILITY_VALUES[mergedVisibility] >= VISIBILITY_VALUES.hidden || isInvisible)\r\n        return returnValue(mergedVisibility);\r\n\r\n    const targetLowlight = targetActor?.hasLowLightVision;\r\n    const targetDarkvision = targetActor?.hasDarkvision;\r\n    const targetGreaterDarkvision = targetActor && hasGreaterDarkvision(targetActor);\r\n    if (targetGreaterDarkvision && mergedVisibility === \"concealed\")\r\n        return returnValue(mergedVisibility);\r\n\r\n    let inDarkness;\r\n    if (!targetGreaterDarkvision) {\r\n        // const darknessExposure = getDarknessExposure(origin)\r\n        // if (darknessExposure) {\r\n        //     inDarkness = true;\r\n        //     // if (!targetDarkvision) return returnValue(\"hidden\");\r\n        // }\r\n\r\n        const darknessTemplates = getDarknessTemplates(origin);\r\n        if (darknessTemplates?.length) {\r\n            let darknessVisibility;\r\n\r\n            for (const template of darknessTemplates) {\r\n                const darknessTokens = getTemplateTokens(template);\r\n                if (!darknessTokens.length) continue;\r\n\r\n                const inTemplate =\r\n                    darknessTokens.includes(origin) || darknessTokens.includes(target);\r\n                if (inTemplate) inDarkness = true;\r\n                else continue;\r\n\r\n                if (!targetDarkvision) return returnValue(\"hidden\");\r\n\r\n                const templateConceals = getFlag(template, \"conceal\");\r\n                if (templateConceals) darknessVisibility = \"concealed\";\r\n            }\r\n\r\n            if (darknessVisibility === \"concealed\") mergedVisibility = \"concealed\";\r\n            if (inDarkness && mergedVisibility === \"concealed\")\r\n                return returnValue(mergedVisibility);\r\n        }\r\n    }\r\n\r\n    if (mergedVisibility !== \"concealed\") {\r\n        const mistTemplates = getMistTemplates(origin);\r\n        if (mistTemplates?.length) {\r\n            for (const template of mistTemplates) {\r\n                const mistTokens = getTemplateTokens(template);\r\n                if (!mistTokens.length) continue;\r\n\r\n                const inTemplate = mistTokens.includes(origin) || mistTokens.includes(target);\r\n                if (inTemplate) return returnValue(\"concealed\");\r\n            }\r\n        }\r\n    }\r\n\r\n    if (inDarkness || targetGreaterDarkvision) return returnValue(mergedVisibility);\r\n\r\n    const exposure = getLightExposure(origin, debug);\r\n    let exposedVisibility =\r\n        exposure === \"dim\" ? \"concealed\" : exposure === null ? \"hidden\" : undefined;\r\n    if (exposedVisibility === \"concealed\" && targetLowlight) exposedVisibility = undefined;\r\n    else if (exposedVisibility === \"hidden\" && targetDarkvision) exposedVisibility = undefined;\r\n\r\n    if (VISIBILITY_VALUES[exposedVisibility] > VISIBILITY_VALUES[mergedVisibility])\r\n        mergedVisibility = exposedVisibility;\r\n    return returnValue(mergedVisibility);\r\n}\r\n\r\nexport function updateToken(token, data, context, userId) {\r\n    const flags = data.flags?.[\"pf2e-perception\"];\r\n\r\n    if (flags && (flags.data || flags[\"-=data\"] !== undefined)) {\r\n        token.object.renderFlags.set({ refreshVisibility: true });\r\n\r\n        if (game.user.isGM) return;\r\n\r\n        const hk = Hooks.on(\"refreshToken\", (refreshed) => {\r\n            if (!token.object === refreshed) return;\r\n            Hooks.off(\"refreshToken\", hk);\r\n            if (game.combat?.getCombatantByToken(token.id)) ui.combat.render();\r\n        });\r\n    }\r\n}\r\n\r\nexport function hoverToken(token, hovered) {\r\n    if (hovered) showAllConditionals(token);\r\n    else clearConditionals(token);\r\n}\r\n\r\nexport function deleteToken(token) {\r\n    clearConditionals(token);\r\n    if (!game.user.isGM) ui.combat.render();\r\n}\r\n\r\nexport function controlToken(token, controlled) {\r\n    if (!controlled) return;\r\n    clearConditionals();\r\n    Hooks.once(\"sightRefresh\", () => token.hover && showAllConditionals(token));\r\n}\r\n\r\nconst CONDITIONALS = {};\r\n\r\nexport function clearConditionals(token) {\r\n    const tokenId = token?.id;\r\n    if (!tokenId) return $(\".pf2e-conditionals\").remove();\r\n\r\n    for (const el of CONDITIONALS[tokenId] ?? []) {\r\n        el.remove();\r\n    }\r\n\r\n    delete CONDITIONALS[tokenId];\r\n}\r\n\r\nexport function showAllConditionals(token) {\r\n    const tokens = getValidTokens(token);\r\n    for (const target of tokens) {\r\n        showConditionals(target, token);\r\n    }\r\n}\r\n\r\nexport async function showConditionals(origin, target) {\r\n    origin = origin instanceof Token ? origin : origin.object;\r\n    if (!origin.visible || !origin.actor?.isOfType(\"creature\")) return;\r\n\r\n    let data = getTokenData(origin, target.id);\r\n    if (foundry.utils.isEmpty(data)) return;\r\n\r\n    if (\r\n        !game.user.isGM &&\r\n        !target.document.hasPlayerOwner &&\r\n        VISIBILITY_VALUES[data.visibility] >= VISIBILITY_VALUES.hidden\r\n    ) {\r\n        if (!data.cover) return;\r\n        data = { cover: data.cover };\r\n    }\r\n\r\n    const targetId = target.id;\r\n    const coords = canvas.clientCoordinatesFromCanvas(origin);\r\n    const iconSize = getSetting(\"icon-size\");\r\n    const width = origin.document.width * canvas.grid.size * origin.worldTransform.a;\r\n\r\n    const style = [\r\n        `top: ${coords.y}px`,\r\n        `left: ${coords.x + width / 2}px`,\r\n        `--icon-size: ${iconSize}px`,\r\n    ].join(\"; \");\r\n\r\n    let content = `<div class=\"pf2e-conditionals\" data-hover-id=\"${origin.id}\"`;\r\n    content += ` data-token-id=\"${targetId}\" style=\"${style}\">`;\r\n\r\n    const savedPaths = getSetting(\"icon-path\");\r\n    Object.entries(data).map(([property, value]) => {\r\n        const icon = property === \"cover\" ? \"cover\" : value;\r\n        let path = savedPaths[icon] || ICONS_PATHS[icon];\r\n        if (path.startsWith(\"systems\") || path.startsWith(\"modules\")) path = `../../../${path}`;\r\n        content += `<div class=\"conditional\"><img src=\"${path}\"></img></div>`;\r\n    });\r\n\r\n    content += \"</div>\";\r\n\r\n    const conditionals = $(content);\r\n    (CONDITIONALS[targetId] ??= []).push(conditionals);\r\n\r\n    $(document.body).append(conditionals);\r\n}\r\n\r\nexport function preCreateToken(token) {\r\n    const actor = token.actor;\r\n    if (!actor?.isOfType(\"creature\")) return;\r\n\r\n    if (actor.isOfType(\"npc\") && getSceneSetting(token.scene, \"npc-vision\")) {\r\n        token.updateSource({ \"sight.enabled\": true });\r\n    }\r\n\r\n    if (game.user.isGM && token.hidden) {\r\n        const targets = game.user.targets;\r\n        const updates = {};\r\n\r\n        for (const target of targets) {\r\n            updates[target.id] = { visibility: \"unnoticed\" };\r\n        }\r\n\r\n        if (targets.size) {\r\n            token.updateSource({ [`flags.${MODULE_ID}.data`]: updates });\r\n        }\r\n    }\r\n}\r\n", "import { validateMessage } from \"../chat.js\";\r\nimport { COVERS, VISIBILITIES, VISIBILITY_VALUES, defaultValues } from \"../constants.js\";\r\nimport { MODULE_ID, getSetting, localize, templatePath } from \"../module.js\";\r\nimport { DegreeOfSuccess } from \"../pf2e/success.js\";\r\nimport { getValidTokens } from \"../scene.js\";\r\nimport { deleteSeekTemplate } from \"../template.js\";\r\nimport { getTokenData } from \"../token.js\";\r\nimport { BaseMenu } from \"./base-menu.js\";\r\n\r\nclass ValidationMenu extends BaseMenu {\r\n    static async openMenu(params, options) {\r\n        // biome-ignore lint/complexity/noThisInStatic: shit aint working\r\n        const validated = await super.openMenu(params, options);\r\n        if (validated && params.message) validateMessage(params.message);\r\n        return validated;\r\n    }\r\n\r\n    get title() {\r\n        return localize(\"menu.validation.title\", { name: this.token.name });\r\n    }\r\n\r\n    get template() {\r\n        return templatePath(\"validation\");\r\n    }\r\n\r\n    get selected() {\r\n        const selected = super.selected;\r\n        if (selected.length) return selected;\r\n        return this.globalSelection;\r\n    }\r\n\r\n    get globalSelection() {\r\n        const token = this.token;\r\n        const alliance = token.actor.alliance;\r\n        return getValidTokens(token)\r\n            .filter((t) => t.actor.alliance !== alliance)\r\n            .map((t) => t.id);\r\n    }\r\n\r\n    getSavedData(converted = true) {\r\n        const data = super.getSavedData();\r\n        return converted ? this._convertData(data) : data;\r\n    }\r\n\r\n    _convertData(data) {\r\n        const property = this.property;\r\n        const scene = this.scene;\r\n        const selected = this.selected;\r\n        const defaultValue = defaultValues[property];\r\n        const propertyList = property === \"cover\" ? COVERS : VISIBILITIES;\r\n\r\n        for (const tokenId of selected) {\r\n            const token = scene.tokens.get(tokenId);\r\n            const fullProperty = `${tokenId}.${property}`;\r\n            const currentValue = foundry.utils.getProperty(data, fullProperty) ?? defaultValue;\r\n\r\n            let processedValue = this.processValue({ token, value: currentValue });\r\n            if (!propertyList.includes(processedValue)) processedValue = currentValue;\r\n\r\n            if (currentValue === processedValue) continue;\r\n            foundry.utils.setProperty(data, fullProperty, processedValue);\r\n        }\r\n\r\n        return data;\r\n    }\r\n\r\n    processValue(params) {\r\n        throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`);\r\n    }\r\n\r\n    getData(options) {\r\n        const { covers, visibilities, i18n } = super.getData(options);\r\n        const currentData = this.currentData;\r\n        const originalData = this.getSavedData(false);\r\n        const property = this.property;\r\n\r\n        const selected = this.selected;\r\n        let tokens = getValidTokens(this.token);\r\n\r\n        tokens = tokens.map(({ id, name, actor }) => {\r\n            const current = currentData[id] ?? {};\r\n            const original = originalData[id] ?? {};\r\n\r\n            return {\r\n                id,\r\n                name,\r\n                alliance: actor.alliance,\r\n                selected: selected.includes(id),\r\n                ...BaseMenu.createPropertyData(original, current, property),\r\n            };\r\n        });\r\n\r\n        const validation = getSetting(\"validation\");\r\n        if (validation === \"selected\") tokens = tokens.filter((t) => t.selected);\r\n        else if (validation === \"changed\") tokens = tokens.filter((t) => t.changed);\r\n\r\n        return {\r\n            ...this._spliIntoAlliances(tokens),\r\n            i18n,\r\n            property: property,\r\n            options: property === \"cover\" ? covers : visibilities,\r\n            showSelected: selected.length !== tokens.length && validation === \"all\",\r\n            showChanges: validation !== \"changed\",\r\n        };\r\n    }\r\n\r\n    activateListeners(html) {\r\n        super.activateListeners(html);\r\n\r\n        html.find(\"[data-action=cancel]\").on(\"click\", (event) => {\r\n            this.close();\r\n        });\r\n    }\r\n}\r\n\r\nexport class CoverValidationMenu extends ValidationMenu {\r\n    #value;\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options);\r\n        this.#value = params.value;\r\n    }\r\n\r\n    get property() {\r\n        return \"cover\";\r\n    }\r\n\r\n    processValue() {\r\n        return this.#value;\r\n    }\r\n}\r\n\r\nclass VisibilityValidationMenu extends ValidationMenu {\r\n    #roll;\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options);\r\n        this.#roll = params.roll;\r\n    }\r\n\r\n    get property() {\r\n        return \"visibility\";\r\n    }\r\n\r\n    get roll() {\r\n        return this.#roll;\r\n    }\r\n}\r\n\r\nexport class HideValidationMenu extends VisibilityValidationMenu {\r\n    processValue({ token, value }) {\r\n        const roll = this.roll;\r\n        const dc = token.actor.perception.dc.value;\r\n        const visibility = VISIBILITY_VALUES[value];\r\n        const success = new DegreeOfSuccess(roll, dc).value;\r\n\r\n        if (success >= DegreeOfSuccess.SUCCESS && visibility < VISIBILITY_VALUES.hidden)\r\n            return \"hidden\";\r\n        if (success <= DegreeOfSuccess.FAILURE && visibility >= VISIBILITY_VALUES.hidden)\r\n            return \"observed\";\r\n        return value;\r\n    }\r\n}\r\n\r\nexport class CreateADiversionMenu extends VisibilityValidationMenu {\r\n    processValue({ token, value }) {\r\n        const roll = this.roll;\r\n        const dc = token.actor.perception.dc.value;\r\n        const visibility = VISIBILITY_VALUES[value];\r\n        const success = new DegreeOfSuccess(roll, dc).value;\r\n\r\n        if (success >= DegreeOfSuccess.SUCCESS && visibility < VISIBILITY_VALUES.hidden)\r\n            return \"hidden\";\r\n        return value;\r\n    }\r\n}\r\n\r\nexport class UnHideValidationMenu extends VisibilityValidationMenu {\r\n    get selected() {\r\n        return getValidTokens(this.token).map((t) => t.id);\r\n    }\r\n\r\n    processValue({ token, value }) {\r\n        const visibility = VISIBILITY_VALUES[value];\r\n        if (visibility >= VISIBILITY_VALUES.hidden) return \"observed\";\r\n        return value;\r\n    }\r\n}\r\n\r\nexport class PointOutValidationMenu extends VisibilityValidationMenu {\r\n    #originator;\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options);\r\n        this.#originator = params.originator;\r\n    }\r\n\r\n    get selected() {\r\n        const token = this.token;\r\n        const alliance = token.actor.alliance;\r\n        const originatorId = this.#originator.id;\r\n        const data = getTokenData(token) ?? {};\r\n\r\n        return getValidTokens(token)\r\n            .filter((t) => {\r\n                if (t.id === originatorId || t.actor.alliance === alliance) return false;\r\n                const visibility = foundry.utils.getProperty(data, `${t.id}.visibility`);\r\n                return VISIBILITY_VALUES[visibility] >= VISIBILITY_VALUES.undetected;\r\n            })\r\n            .map((t) => t.id);\r\n    }\r\n\r\n    processValue({ token, value }) {\r\n        return VISIBILITY_VALUES[value] >= VISIBILITY_VALUES.undetected ? \"hidden\" : value;\r\n    }\r\n}\r\n\r\nclass ReverseVisibilityValidationMenu extends VisibilityValidationMenu {\r\n    getSavedData(converted = true) {\r\n        const thisId = this.token.id;\r\n        const tokens = getValidTokens(this.token);\r\n        const data = {};\r\n\r\n        for (const token of tokens) {\r\n            const tokenData = getTokenData(token, thisId);\r\n            if (tokenData) data[token.id] = foundry.utils.deepClone(tokenData);\r\n        }\r\n\r\n        return converted ? this._convertData(data) : data;\r\n    }\r\n\r\n    getData() {\r\n        const parentData = super.getData();\r\n        parentData.isReversed = true;\r\n        parentData.options = VISIBILITIES.map((value) => ({\r\n            value,\r\n            label: localize(`visibility.reversed.${value}`),\r\n        }));\r\n        return parentData;\r\n    }\r\n\r\n    _saveData(currentData) {\r\n        const scene = this.scene;\r\n        const thisId = this.token.id;\r\n        const updates = [];\r\n\r\n        for (const [tokenId, data] of Object.entries(currentData)) {\r\n            const update = { _id: tokenId };\r\n            const token = scene.tokens.get(tokenId);\r\n\r\n            if (token) {\r\n                if (data.visibility === defaultValues.visibility) {\r\n                    // biome-ignore lint/performance/noDelete: needs to be gone\r\n                    delete data.visibility;\r\n                }\r\n\r\n                const original = getTokenData(token, thisId) ?? {};\r\n                if (original?.visibility === data.visibility) continue;\r\n\r\n                if (!original.cover && !data.visibility) {\r\n                    update[`flags.${MODULE_ID}.data.-=${thisId}`] = null;\r\n                } else if (!data.visibility) {\r\n                    update[`flags.${MODULE_ID}.data.${thisId}.-=visibility`] = null;\r\n                } else {\r\n                    update[`flags.${MODULE_ID}.data.${thisId}.visibility`] = data.visibility;\r\n                }\r\n            } else update[`flags.${MODULE_ID}.data.-=${thisId}`] = null;\r\n\r\n            updates.push(update);\r\n        }\r\n\r\n        scene.updateEmbeddedDocuments(\"Token\", updates);\r\n    }\r\n}\r\n\r\nexport class SeekValidationMenu extends ReverseVisibilityValidationMenu {\r\n    #fromTemplate;\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options);\r\n        this.#fromTemplate = params.fromTemplate;\r\n    }\r\n\r\n    get globalSelection() {\r\n        return [];\r\n    }\r\n\r\n    static async openMenu(params, options) {\r\n        // biome-ignore lint/complexity/noThisInStatic: nop\r\n        const validated = await super.openMenu(params, options);\r\n        if (validated) deleteSeekTemplate(params.token);\r\n    }\r\n\r\n    processValue({ token, value }) {\r\n        const roll = this.roll;\r\n        const dc = token.actor.skills.stealth.dc.value;\r\n        const visibility = VISIBILITY_VALUES[value];\r\n        const success = new DegreeOfSuccess(roll, dc).value;\r\n\r\n        if (success >= DegreeOfSuccess.CRITICAL_SUCCESS && visibility >= VISIBILITY_VALUES.hidden)\r\n            return \"observed\";\r\n        if (success >= DegreeOfSuccess.SUCCESS && visibility === VISIBILITY_VALUES.hidden)\r\n            return \"observed\";\r\n        if (success >= DegreeOfSuccess.SUCCESS && visibility >= VISIBILITY_VALUES.undetected)\r\n            return \"hidden\";\r\n        return value;\r\n    }\r\n}\r\n", "import {\r\n    CoverValidationMenu,\r\n    CreateADiversionMenu,\r\n    HideValidationMenu,\r\n    PointOutValidationMenu,\r\n    SeekValidationMenu,\r\n    UnHideValidationMenu,\r\n} from \"./apps/validation.js\";\r\nimport { attackCheckRoll } from \"./constants.js\";\r\nimport { MODULE_ID, getActionName, getFlag, getFlags, localize, setFlag } from \"./module.js\";\r\nimport { deleteSeekTemplate } from \"./template.js\";\r\n\r\nexport function renderChatMessage(message, html) {\r\n    const token = message.token;\r\n    if (!token) return;\r\n\r\n    const isGM = game.user.isGM;\r\n    const hasPlayerOwner = token.hasPlayerOwner;\r\n    const { cover, selected, skipWait, validated, pointOut } = getFlags(message);\r\n    const pf2eContext = message.getFlag(\"pf2e\", \"context\");\r\n\r\n    if (cover) {\r\n        if (isGM) {\r\n            const button = createValidateButton({ property: \"cover\", skipWait, validated });\r\n            html.find(\".message-content\").append(button);\r\n            html.find(\"[data-action=validate-cover]\").on(\"click\", () => {\r\n                CoverValidationMenu.openMenu({ token, selected, value: cover, message });\r\n            });\r\n        } else if (!skipWait) {\r\n            const hint = createWaitHint(\"cover\", validated);\r\n            html.find(\".message-content\").append(hint);\r\n        }\r\n    } else if (pf2eContext?.pf2ePerception?.visibility) {\r\n        if (!validated) html.find(\".message-buttons\").remove();\r\n\r\n        const flavor = html.find(\".flavor-text\");\r\n\r\n        if (!isGM && hasPlayerOwner) {\r\n            html.find(\".message-sender\").text(token.name);\r\n            flavor.empty();\r\n        }\r\n\r\n        const msg = localize(\r\n            `message.flat-check.${\r\n                validated === undefined ? \"blind\" : validated ? \"success\" : \"failure\"\r\n            }`\r\n        );\r\n        const hint = createHint(msg, validated);\r\n        flavor.append(hint);\r\n\r\n        if (isGM) {\r\n            for (const type of [\"success\", \"failure\"]) {\r\n                flavor.append(\r\n                    createChatButton({\r\n                        action: `${type}-message`,\r\n                        icon: \"fa-solid fa-message\",\r\n                        label: localize(\"message.flat-check.button\", type),\r\n                    })\r\n                );\r\n                html.find(`[data-action=${type}-message]`).on(\"click\", () => {\r\n                    setFlag(message, \"validated\", type === \"success\");\r\n                });\r\n            }\r\n        }\r\n    } else if (pf2eContext?.type === \"skill-check\" && pf2eContext.pf2ePerception) {\r\n        if (isGM) {\r\n            if (pf2eContext.options.includes(\"action:hide\")) {\r\n                const button = createValidateButton({\r\n                    property: \"visibility\",\r\n                    skipWait,\r\n                    validated,\r\n                });\r\n                html.find(\".flavor-text\").append(button);\r\n                html.find(\"[data-action=validate-visibility]\").on(\"click\", () => {\r\n                    HideValidationMenu.openMenu({\r\n                        token,\r\n                        message,\r\n                        roll: message.rolls[0],\r\n                        selected: pf2eContext.pf2ePerception.selected,\r\n                    });\r\n                });\r\n            } else if (pf2eContext.options.includes(\"action:create-a-diversion\")) {\r\n                const button = createValidateButton({\r\n                    property: \"visibility\",\r\n                    skipWait,\r\n                    validated,\r\n                });\r\n                html.find(\".flavor-text\").append(button);\r\n                html.find(\"[data-action=validate-visibility]\").on(\"click\", () => {\r\n                    CreateADiversionMenu.openMenu({\r\n                        token,\r\n                        message,\r\n                        roll: message.rolls[0],\r\n                        selected: pf2eContext.pf2ePerception.selected,\r\n                    });\r\n                });\r\n            }\r\n        } else if (hasPlayerOwner) {\r\n            if (pf2eContext.options.includes(\"action:hide\")) {\r\n                addBlindSkillCheckFlavor({ token, message, html, validated, action: \"Hide\" });\r\n            } else if (pf2eContext.options.includes(\"action:create-a-diversion\")) {\r\n                addSkillCheckFlavor(html, validated);\r\n            }\r\n        }\r\n    } else if (pf2eContext?.type === \"perception-check\" && pf2eContext.pf2ePerception) {\r\n        if (isGM) {\r\n            if (pf2eContext.options.includes(\"action:seek\")) {\r\n                const buttons = createValidateCombo({\r\n                    skipWait,\r\n                    validated,\r\n                    smallAction: \"delete-template\",\r\n                    smallIcon: \"fa-thin fa-cubes\",\r\n                    smallSlashed: true,\r\n                });\r\n\r\n                html.find(\".flavor-text\").append(buttons);\r\n\r\n                html.find(\"[data-action=validate-visibility]\").on(\"click\", () => {\r\n                    SeekValidationMenu.openMenu({\r\n                        token,\r\n                        message,\r\n                        roll: message.rolls[0],\r\n                        selected: pf2eContext.pf2ePerception.selected,\r\n                        fromTemplate: pf2eContext.pf2ePerception.fromTemplate,\r\n                    });\r\n                });\r\n\r\n                html.find(\"[data-action=delete-template\").on(\"click\", () => {\r\n                    deleteSeekTemplate(token);\r\n                });\r\n            }\r\n        } else if (hasPlayerOwner) {\r\n            if (pf2eContext.options.includes(\"action:seek\")) {\r\n                addBlindSkillCheckFlavor({ token, message, html, validated, action: \"Seek\" });\r\n            }\r\n        }\r\n    } else if (pointOut) {\r\n        const selectedToken = token.scene.tokens.get(pointOut);\r\n        if (!selectedToken) return;\r\n\r\n        if (isGM) {\r\n            const buttons = createValidateCombo({\r\n                skipWait,\r\n                validated,\r\n                smallAction: \"ping-token\",\r\n                smallIcon: \"fa-solid fa-signal-stream\",\r\n            });\r\n\r\n            html.find(\".message-content\").append(buttons);\r\n\r\n            html.find(\"[data-action=validate-visibility]\").on(\"click\", () => {\r\n                PointOutValidationMenu.openMenu({\r\n                    message,\r\n                    token: selectedToken,\r\n                    originator: token,\r\n                    selected: canvas.tokens.controlled.map((t) => t.id),\r\n                });\r\n            });\r\n\r\n            html.find(\"[data-action=ping-token]\").on(\"click\", () => {\r\n                canvas.ping(selectedToken.center);\r\n            });\r\n        } else if (hasPlayerOwner) {\r\n            const hint = createWaitHint(\"visibility\", validated);\r\n            html.find(\".message-content\").append(hint);\r\n        }\r\n    }\r\n\r\n    if (isGM && attackCheckRoll.includes(pf2eContext?.type)) {\r\n        const tooltip = localize(\"message.unhide.tooltip\");\r\n        const button = `<span class=\"pf2e-perception-unhide\">\r\n    <button data-action=\"unhide\" title=\"${tooltip}\">\r\n        <i class=\"fa-duotone fa-eye-slash\"></i>\r\n    </button>\r\n</span>`;\r\n\r\n        html.find(\".dice-result .dice-total\").append(button);\r\n        html.find(\"[data-action=unhide]\").on(\"click\", (event) => {\r\n            event.stopPropagation();\r\n            UnHideValidationMenu.openMenu({ token });\r\n        });\r\n    }\r\n}\r\n\r\nexport function validateMessage(message) {\r\n    if (!getFlag(message, \"validated\")) setFlag(message, \"validated\", true);\r\n}\r\n\r\nfunction createValidateCombo({ skipWait, validated, smallIcon, smallAction, smallSlashed }) {\r\n    let buttons = '<div class=\"pf2e-perception-chat-combo\">';\r\n\r\n    buttons += createValidateButton({ property: \"visibility\", skipWait, validated });\r\n    buttons += createChatButton({\r\n        action: smallAction,\r\n        icon: smallIcon,\r\n        slashed: smallSlashed,\r\n        tooltip: localize(`message.visibility.small-button.${smallAction}`),\r\n    });\r\n\r\n    buttons += \"</div>\";\r\n\r\n    return buttons;\r\n}\r\n\r\nfunction actionTitle(action, modifier) {\r\n    const skillName = game.i18n.localize(\r\n        modifier === \"perception\" ? \"PF2E.PerceptionLabel\" : `PF2E.Skill${modifier.capitalize()}`\r\n    );\r\n    const check = localize(\"message.check\");\r\n    return `<h4 class=\"action\">\r\n    <strong>${getActionName(action)}</strong>\r\n    <span class=\"action-glyph\">1</span>\r\n    <span class=\"subtitle\">(${skillName} ${check})</span>\r\n</h4>`;\r\n}\r\n\r\nfunction addSkillCheckFlavor(html, validated) {\r\n    const hint = createWaitHint(\"visibility\", validated);\r\n    html.find(\".flavor-text\").append(hint);\r\n}\r\n\r\nfunction addBlindSkillCheckFlavor({ html, token, message, validated, action }) {\r\n    const modifier = message.getFlag(\"pf2e\", \"modifierName\");\r\n    const title = actionTitle(action, modifier);\r\n\r\n    html.find(\".message-sender\").text(token.name);\r\n    html.find(\".flavor-text\").html(title);\r\n\r\n    addSkillCheckFlavor(html, validated);\r\n}\r\n\r\nfunction createWaitHint(property, validated) {\r\n    const hint = localize(`message.${property}.player.${validated ? \"validated\" : \"wait\"}`);\r\n    return createHint(hint, validated);\r\n}\r\n\r\nfunction createHint(hint, validated) {\r\n    const str =\r\n        validated === true\r\n            ? `<i class=\"fa-solid fa-check validated\"></i> ${hint}`\r\n            : validated === false\r\n            ? `<i class=\"fa-solid fa-xmark canceled\"></i> ${hint}`\r\n            : hint;\r\n    return `<i class=\"pf2e-perception-hint\">${str}</i>`;\r\n}\r\n\r\nfunction createValidateButton({ skipWait, validated, property }) {\r\n    let label = localize(\r\n        `message.${property}.gm.${skipWait ? \"check\" : validated ? \"validated\" : \"validate\"}`\r\n    );\r\n    if (!skipWait && validated) label += '<i class=\"fa-solid fa-check validated\"></i>';\r\n    return createChatButton({\r\n        action: `validate-${property}`,\r\n        icon: \"fa-solid fa-list\",\r\n        label,\r\n    });\r\n}\r\n\r\nexport function createChatButton({ action, icon, label, tooltip, slashed = false }) {\r\n    let button = `<button type=\"button\" class=\"pf2e-perception-chat-button\" data-action=\"${action}\" title=\"${tooltip}\">`;\r\n\r\n    if (icon) {\r\n        button += `<i class=\"${icon} ${label ? \"\" : \"no-label\"}\"></i>`;\r\n        if (slashed) {\r\n            button += `<i class=\"fa-solid fa-slash-forward slashed\"></i>`;\r\n        }\r\n    }\r\n    if (label) button += `${icon ? \" \" : \"\"}${label}`;\r\n\r\n    button += \"</button>\";\r\n\r\n    return button;\r\n}\r\n\r\nexport async function createTokenMessage({ content, token, flags, secret }) {\r\n    const data = {\r\n        content,\r\n        speaker: ChatMessage.getSpeaker({ token: token instanceof Token ? token.document : token }),\r\n    };\r\n    if (flags) foundry.utils.setProperty(data, `flags.${MODULE_ID}`, flags);\r\n    if (secret) {\r\n        data.type = CONST.CHAT_MESSAGE_TYPES.WHISPER;\r\n        data.whisper = ChatMessage.getWhisperRecipients(\"gm\");\r\n    }\r\n    return ChatMessage.create(data);\r\n}\r\n", "import { getActorToken, getCoverEffect, isProne } from \"./actor.js\";\r\nimport { createTokenMessage } from \"./chat.js\";\r\nimport { VISIBILITY_VALUES, defaultValues } from \"./constants.js\";\r\nimport { createCoverSource } from \"./effect.js\";\r\nimport { MODULE_ID, getActionName, getSetting, localize, templatePath } from \"./module.js\";\r\nimport { validateTokens } from \"./scene.js\";\r\nimport { createSeekTemplate, deleteSeekTemplate } from \"./template.js\";\r\nimport { clearTokenData, getTokenData, setTokenData } from \"./token.js\";\r\nimport { getPrototype } from \"./utils.js\";\r\n\r\nexport function setupActions() {\r\n    const hide = game.pf2e.actions.get(\"hide\");\r\n    const BaseAction = getPrototype(hide, 2).constructor;\r\n    const BaseActionVariant = getPrototype(hide.toActionVariant(), 2).constructor;\r\n    const SingleCheckAction = getPrototype(hide, 1).constructor;\r\n    const SingleCheckActionVariant = getPrototype(hide.toActionVariant(), 1).constructor;\r\n\r\n    setupCover(BaseAction, BaseActionVariant);\r\n    setupHide(SingleCheckAction, SingleCheckActionVariant);\r\n    setupCreateADiversion(SingleCheckAction, SingleCheckActionVariant);\r\n    setupSneak(SingleCheckAction, SingleCheckActionVariant);\r\n    setupSeek(SingleCheckAction, SingleCheckActionVariant);\r\n    setupPointOut(BaseAction, BaseActionVariant);\r\n}\r\n\r\nfunction setupPointOut(BaseAction, BaseActionVariant) {\r\n    class PointOutVariant extends BaseActionVariant {\r\n        async use(options = {}) {\r\n            const action = localize(\"action.point-out\");\r\n            const token = getSelectedToken(options, action);\r\n            if (token) pointOut(this, token);\r\n        }\r\n    }\r\n\r\n    class PointOut extends BaseAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                name: `${MODULE_ID}.action.point-out`,\r\n                description: `${MODULE_ID}.action.point-out.description`,\r\n                rollOptions: [\"action:point-out\"],\r\n                slug: \"point-out\",\r\n                traits: [\"auditory\", \"manipulate\", \"visual\"],\r\n            });\r\n        }\r\n\r\n        toActionVariant(data = {}) {\r\n            data.name ??= this.name;\r\n            return new PointOutVariant(this, data);\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set(\"point-out\", new PointOut());\r\n}\r\n\r\nasync function pointOut({ name, traits }, token) {\r\n    const target = game.user.targets.filter((t) => t.actor).first();\r\n    const visibility = target ? getTokenData(target, token.id, \"visibility\") : undefined;\r\n    const isVisible = target && VISIBILITY_VALUES[visibility] < VISIBILITY_VALUES.undetected;\r\n\r\n    let description;\r\n    if (isVisible) {\r\n        const dc = target.actor.skills.stealth.dc.value;\r\n        description = localize(\"message.point-out.short-check\", {\r\n            check: `@Check[type:perception|dc:${dc}|traits:auditory,manipulate,visual|showDC:gm]`,\r\n        });\r\n    } else description = localize(\"message.point-out.short\");\r\n\r\n    const content = await renderTemplate(templatePath(\"point-out\"), {\r\n        description,\r\n        name,\r\n        traits: traits.map((slug) => ({\r\n            slug,\r\n            tooltip: CONFIG.PF2E.traitsDescriptions[slug],\r\n            name: CONFIG.PF2E.actionTraits[slug],\r\n        })),\r\n    });\r\n\r\n    const flags = {\r\n        pointOut: isVisible ? target.id : undefined,\r\n    };\r\n\r\n    createTokenMessage({ content, token, flags });\r\n}\r\n\r\nfunction setupSeek(SingleCheckAction, SingleCheckActionVariant) {\r\n    class SeekVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = getActionName(\"Seek\");\r\n            const token = getSelectedToken(options, action);\r\n            if (!token) return;\r\n\r\n            if (getSetting(\"seek-template\")) {\r\n                const useTemplate = await seek(token);\r\n                if (!useTemplate) {\r\n                    return deleteSeekTemplate(token);\r\n                }\r\n            }\r\n\r\n            options.actors = [token.actor];\r\n            return super.use(options);\r\n        }\r\n    }\r\n\r\n    class Seek extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: \"PF2E.Actions.Seek.Description\",\r\n                name: \"PF2E.Actions.Seek.Title\",\r\n                notes: [\r\n                    {\r\n                        outcome: [\"criticalSuccess\"],\r\n                        text: \"PF2E.Actions.Seek.Notes.criticalSuccess\",\r\n                    },\r\n                    { outcome: [\"success\"], text: \"PF2E.Actions.Seek.Notes.success\" },\r\n                ],\r\n                rollOptions: [\"action:seek\"],\r\n                slug: \"seek\",\r\n                statistic: \"perception\",\r\n                traits: [\"concentrate\", \"secret\"],\r\n            });\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new SeekVariant(this, data);\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set(\"seek\", new Seek());\r\n}\r\n\r\nasync function seek(token) {\r\n    const unit = game.i18n.localize(\"PF2E.Foot.Plural\");\r\n\r\n    let content = '<p style=\"margin: 0 0.3em; text-align: center;\">';\r\n    content += `${localize(\"dialog.seek.hint\")}</p><p>`;\r\n\r\n    const templates = [\r\n        { type: \"cone\", distance: 30 },\r\n        { type: \"burst\", distance: 15 },\r\n        { type: \"burst\", distance: 30 },\r\n    ];\r\n\r\n    for (const { type, distance } of templates) {\r\n        const label = game.i18n.format(\"PF2E.TemplateLabel\", {\r\n            size: distance,\r\n            unit,\r\n            shape: game.i18n.localize(`PF2E.Area.Shape.${type}`),\r\n        });\r\n        content += `<button type=\"button\" data-action=\"create-template\" \r\n        data-type=\"${type}\" data-distance=\"${distance}\" style=\"margin: 0 0 5px; padding: 0;\">\r\n    <i class=\"fa-thin fa-cubes\"></i> ${label}</button>\r\n</button>`;\r\n    }\r\n\r\n    content += \"</p>\";\r\n\r\n    return Dialog.wait(\r\n        {\r\n            title: `${token.name} - ${game.i18n.localize(\"PF2E.Actions.Seek.Title\")}`,\r\n            content,\r\n            buttons: {\r\n                ok: {\r\n                    icon: '<i class=\"fa-solid fa-check\"></i>',\r\n                    label: localize(\"dialog.seek.accept\"),\r\n                    callback: () => true,\r\n                },\r\n                no: {\r\n                    icon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n                    label: localize(\"dialog.seek.cancel\"),\r\n                    callback: (html) => false,\r\n                },\r\n            },\r\n            close: () => false,\r\n            render: (html) => {\r\n                const content = html.filter(\".dialog-content\");\r\n                content.find(\"[data-action=create-template]\").on(\"click\", (event) => {\r\n                    const { type, distance } = event.currentTarget.dataset;\r\n                    deleteSeekTemplate(token);\r\n                    createSeekTemplate({ type, distance, token });\r\n                });\r\n            },\r\n        },\r\n        { width: 300, left: 10 }\r\n    );\r\n}\r\n\r\nfunction setupSneak(SingleCheckAction, SingleCheckActionVariant) {\r\n    class SneakVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = getActionName(\"Sneak\");\r\n            const token = getSelectedToken(options, action);\r\n            if (!token) return;\r\n\r\n            options.actors = [token.actor];\r\n            return super.use(options);\r\n        }\r\n    }\r\n\r\n    class Sneak extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: \"PF2E.Actions.Sneak.Description\",\r\n                name: \"PF2E.Actions.Sneak.Title\",\r\n                notes: [\r\n                    {\r\n                        outcome: [\"success\", \"criticalSuccess\"],\r\n                        text: \"PF2E.Actions.Sneak.Notes.success\",\r\n                    },\r\n                    { outcome: [\"failure\"], text: \"PF2E.Actions.Sneak.Notes.failure\" },\r\n                    {\r\n                        outcome: [\"criticalFailure\"],\r\n                        text: \"PF2E.Actions.Sneak.Notes.criticalFailure\",\r\n                    },\r\n                ],\r\n                rollOptions: [\"action:sneak\"],\r\n                slug: \"sneak\",\r\n                traits: [\"move\", \"secret\"],\r\n            });\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new SneakVariant(this, data);\r\n        }\r\n    }\r\n\r\n    // game.pf2e.actions.set('sneak', new Sneak())\r\n}\r\n\r\nfunction setupCreateADiversion(SingleCheckAction, SingleCheckActionVariant) {\r\n    class CreateADiversionVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = getActionName(\"CreateADiversion\");\r\n            const token = getSelectedToken(options, action);\r\n            if (!token) return;\r\n\r\n            options.actors = [token.actor];\r\n            return super.use(options);\r\n        }\r\n    }\r\n\r\n    class CreateADiversion extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: \"PF2E.Actions.CreateADiversion.Description\",\r\n                name: \"PF2E.Actions.CreateADiversion.Title\",\r\n                notes: [\r\n                    {\r\n                        outcome: [\"criticalSuccess\", \"success\"],\r\n                        text: \"PF2E.Actions.CreateADiversion.Notes.success\",\r\n                    },\r\n                    {\r\n                        outcome: [\"criticalFailure\", \"failure\"],\r\n                        text: \"PF2E.Actions.CreateADiversion.Notes.failure\",\r\n                    },\r\n                ],\r\n                section: \"skill\",\r\n                slug: \"create-a-diversion\",\r\n                statistic: \"deception\",\r\n                traits: [\"mental\"],\r\n                variants: [\r\n                    {\r\n                        name: \"PF2E.Actions.CreateADiversion.DistractingWords.Title\",\r\n                        rollOptions: [\r\n                            \"action:create-a-diversion\",\r\n                            \"action:create-a-diversion:distracting-words\",\r\n                        ],\r\n                        slug: \"distracting-words\",\r\n                        traits: [\"auditory\", \"linguistic\", \"mental\"],\r\n                    },\r\n                    {\r\n                        name: \"PF2E.Actions.CreateADiversion.Gesture.Title\",\r\n                        rollOptions: [\r\n                            \"action:create-a-diversion\",\r\n                            \"action:create-a-diversion:gesture\",\r\n                        ],\r\n                        slug: \"gesture\",\r\n                        traits: [\"manipulate\", \"mental\"],\r\n                    },\r\n                    {\r\n                        name: \"PF2E.Actions.CreateADiversion.Trick.Title\",\r\n                        rollOptions: [\r\n                            \"action:create-a-diversion\",\r\n                            \"action:create-a-diversion:trick\",\r\n                        ],\r\n                        slug: \"trick\",\r\n                        traits: [\"manipulate\", \"mental\"],\r\n                    },\r\n                ],\r\n            });\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new CreateADiversionVariant(this, data);\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set(\"create-a-diversion\", new CreateADiversion());\r\n}\r\n\r\nfunction setupHide(SingleCheckAction, SingleCheckActionVariant) {\r\n    class HideVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = getActionName(\"Hide\");\r\n            const token = getSelectedToken(options, action);\r\n            if (!token) return;\r\n\r\n            options.actors = [token.actor];\r\n            return super.use(options);\r\n        }\r\n    }\r\n\r\n    class Hide extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: \"PF2E.Actions.Hide.Description\",\r\n                name: \"PF2E.Actions.Hide.Title\",\r\n                rollOptions: [\"action:hide\"],\r\n                slug: \"hide\",\r\n                statistic: \"stealth\",\r\n                traits: [\"secret\"],\r\n                notes: [\r\n                    {\r\n                        outcome: [\"success\", \"criticalSuccess\"],\r\n                        text: \"PF2E.Actions.Hide.Notes.success\",\r\n                    },\r\n                ],\r\n            });\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new HideVariant(this, data);\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set(\"hide\", new Hide());\r\n}\r\n\r\nfunction setupCover(BaseAction, BaseActionVariant) {\r\n    class TakeCoverVariant extends BaseActionVariant {\r\n        async use(options = {}) {\r\n            const action = localize(\"action.take-cover\");\r\n            const token = getSelectedToken(options, action);\r\n            if (token) takeCover(token);\r\n        }\r\n    }\r\n\r\n    class TakeCover extends BaseAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: \"PF2E.Actions.TakeCover.Description\",\r\n                img: \"systems/pf2e/icons/conditions-2/status_acup.webp\",\r\n                name: \"PF2E.Actions.TakeCover.Title\",\r\n                slug: \"take-cover\",\r\n            });\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new TakeCoverVariant(this, data);\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set(\"take-cover\", new TakeCover());\r\n}\r\n\r\nasync function takeCover(token) {\r\n    const actor = token.actor;\r\n    const cover = getCoverEffect(actor);\r\n\r\n    const targets = validateTokens(token, game.user.targets.ids);\r\n    if (cover && !targets.length) return cover.delete();\r\n\r\n    const data = getTokenData(token) ?? {};\r\n    const covers = Object.entries(data).reduce((covers, [tokenId, { cover }]) => {\r\n        if (cover) covers[tokenId] = cover;\r\n        return covers;\r\n    }, {});\r\n\r\n    const content = await renderTemplate(templatePath(\"covers-dialog\"), {\r\n        i18n: localize,\r\n        hasTargets: !!targets.length,\r\n        hasCovers: !foundry.utils.isEmpty(covers),\r\n        hasTargetCover: targets.some((id) => id in covers),\r\n        isProne: isProne(actor),\r\n    });\r\n\r\n    const dialog = new Dialog({\r\n        title: `${token.name} - ${localize(\"action.take-cover\")}`,\r\n        content,\r\n        buttons: {},\r\n        render: (html) => {\r\n            html.find(\"button\").on(\"click\", async (event) => {\r\n                const { level } = event.currentTarget.dataset;\r\n                const skip = getSetting(\"skip-cover\");\r\n\r\n                const process = async (cover, isSelected) => {\r\n                    const selected = isSelected ? targets : undefined;\r\n\r\n                    const flavor =\r\n                        cover === defaultValues.cover\r\n                            ? selected\r\n                                ? \"remove\"\r\n                                : \"remove-all\"\r\n                            : \"take\";\r\n                    await createTokenMessage({\r\n                        content: localize(`message.cover.${flavor}`, {\r\n                            cover: localize(`cover.${cover}`),\r\n                        }),\r\n                        flags: { selected, cover, skipWait: skip },\r\n                        token,\r\n                    });\r\n\r\n                    if (skip) {\r\n                        if (cover === defaultValues.cover && !selected)\r\n                            return clearTokenData(token);\r\n                        const data = foundry.utils.deepClone(getTokenData(token)) ?? {};\r\n                        for (const tokenId of targets) {\r\n                            foundry.utils.setProperty(data, `${tokenId}.cover`, cover);\r\n                        }\r\n                        return setTokenData(token, data);\r\n                    }\r\n                };\r\n\r\n                if (level === \"remove-all\") process(defaultValues.cover);\r\n                else if (level === \"remove\") process(defaultValues.cover, true);\r\n                else if (targets.length) process(level, true);\r\n                else {\r\n                    const source = createCoverSource(level);\r\n                    actor.createEmbeddedDocuments(\"Item\", [source]);\r\n                }\r\n\r\n                dialog.close();\r\n            });\r\n        },\r\n    }).render(true);\r\n}\r\n\r\nfunction getSelectedToken(options, action) {\r\n    let tokens = options.tokens?.filter((t) => t.actor) ?? [];\r\n    if (!Array.isArray(tokens)) tokens = [tokens];\r\n\r\n    let actors = options.actors ?? [];\r\n    if (!Array.isArray(actors)) actors = [actors];\r\n\r\n    if (!tokens.length && actors.length === 1) tokens = [getActorToken(actors[0])].filter(Boolean);\r\n    if (!tokens.length) tokens = canvas.tokens.controlled.filter((t) => t.actor);\r\n    if (!tokens.length) tokens = [getActorToken(game.user.character)].filter(Boolean);\r\n\r\n    if (tokens.length > 1) {\r\n        ui.notifications.warn(localize(\"action.only-one\", { action }));\r\n        return;\r\n    }\r\n\r\n    if (!tokens.length) {\r\n        ui.notifications.warn(localize(\"action.must-one\", { action }));\r\n        return;\r\n    }\r\n\r\n    const token = tokens[0];\r\n    if (!token?.actor?.isOfType(\"creature\")) {\r\n        ui.notifications.warn(localize(\"action.must-creature\", { action }));\r\n        return;\r\n    }\r\n\r\n    return token;\r\n}\r\n", "import { getActorToken, getCoverEffect, isProne } from \"./actor.js\";\r\nimport {\r\n    COVERS,\r\n    COVER_UUID,\r\n    COVER_VALUES,\r\n    VISIBILITY_VALUES,\r\n    attackCheckRoll,\r\n    validCheckRoll,\r\n} from \"./constants.js\";\r\nimport { createCoverSource, createFlatFootedSource, findChoiceSetRule } from \"./effect.js\";\r\nimport { MODULE_ID, getFlag, getSetting, localize } from \"./module.js\";\r\nimport { getPerception, perceptionRules } from \"./rule-element.js\";\r\nimport { validateTokens } from \"./scene.js\";\r\nimport { getSeekTemplateTokens } from \"./template.js\";\r\nimport { getCover, getVisibility } from \"./token.js\";\r\nimport { asNumberOnly } from \"./utils.js\";\r\n\r\nexport async function checkRoll(wrapped, ...args) {\r\n    const context = args[1];\r\n    if (!context) return wrapped(...args);\r\n\r\n    if (Array.isArray(context.options)) context.options = new Set(context.options);\r\n\r\n    const {\r\n        actor,\r\n        createMessage = \"true\",\r\n        type,\r\n        token,\r\n        target,\r\n        isReroll,\r\n        viewOnly,\r\n        item,\r\n    } = context;\r\n    const originToken = (token ?? getActorToken(actor))?.object;\r\n    const targetToken = target?.token?.object;\r\n    const flatCheck = getSetting(\"flat-check\");\r\n\r\n    if (\r\n        viewOnly ||\r\n        isReroll ||\r\n        !createMessage ||\r\n        !originToken ||\r\n        actor.isOfType(\"hazard\") ||\r\n        !validCheckRoll.includes(type)\r\n    ) {\r\n        return wrapped(...args);\r\n    }\r\n\r\n    const targetActor = targetToken?.actor;\r\n    if (attackCheckRoll.includes(type) && targetActor) {\r\n        const event = args[2];\r\n\r\n        // should we roll a flat check to attack the target\r\n        flatCheck: if (flatCheck !== \"none\") {\r\n            const perception = perceptionRules(originToken, targetToken, {\r\n                extraOptions: context.options.filter((o) => o.startsWith(\"item:\")),\r\n            });\r\n\r\n            const visibility = getVisibility(targetToken, originToken, {\r\n                perception,\r\n                affects: \"target\",\r\n            });\r\n            if (!visibility) break flatCheck;\r\n\r\n            const dc = (() => {\r\n                const dc = getPerception(\r\n                    perception,\r\n                    \"target\",\r\n                    \"visibility\",\r\n                    \"dc\",\r\n                    visibility\r\n                )?.first();\r\n                const numberedDC = asNumberOnly(dc);\r\n                if (!numberedDC) return numberedDC;\r\n\r\n                const sign = dc[0];\r\n                if (![\"-\", \"+\"].includes(sign)) return numberedDC;\r\n\r\n                return (visibility === \"concealed\" ? 5 : 11) + numberedDC;\r\n            })();\r\n            if (dc === 0) break flatCheck;\r\n\r\n            const isUndetected = VISIBILITY_VALUES[visibility] >= VISIBILITY_VALUES.undetected;\r\n            const isBlind = event?.ctrlKey || event?.metaKey;\r\n\r\n            const roll = await new originToken.actor.saves.reflex.constructor(originToken.actor, {\r\n                modifiers: [],\r\n                slug: \"visibility-check\",\r\n                label: `${game.i18n.localize(\"PF2E.FlatCheck\")}: ${game.i18n.localize(\r\n                    `PF2E.condition.${visibility}.name`\r\n                )}`,\r\n                check: { type: \"flat-check\" },\r\n            }).roll({\r\n                dc: { value: dc ?? (visibility === \"concealed\" ? 5 : 11) },\r\n                target: targetToken.actor,\r\n                rollMode:\r\n                    isUndetected || isBlind ? (game.user.isGM ? \"gmroll\" : \"blindroll\") : \"roll\",\r\n            });\r\n\r\n            const isSuccess = roll.degreeOfSuccess > 1;\r\n\r\n            if (isUndetected) {\r\n                context.options.add(\"secret\");\r\n                context.pf2ePerception = {\r\n                    isSuccess: isSuccess,\r\n                    visibility,\r\n                };\r\n            }\r\n\r\n            if (flatCheck !== \"roll\" && !isUndetected && !isSuccess) return;\r\n        }\r\n\r\n        // this part replace formerly getRollContext\r\n        const itemOptions = item?.getRollOptions(\"item\") ?? [];\r\n        const distance = originToken.distanceTo(targetToken);\r\n        const perception = perceptionRules(originToken, targetToken, {\r\n            extraOptions: itemOptions,\r\n            distance,\r\n        });\r\n\r\n        let visibility = getVisibility(originToken, targetToken, { perception, affects: \"origin\" });\r\n\r\n        if (visibility && getPerception(perception, \"target\", \"visibility\", \"noff\", visibility)) {\r\n            visibility = undefined;\r\n        }\r\n\r\n        let cover = getCover(originToken, targetToken, {\r\n            perception,\r\n            affects: \"target\",\r\n            options: itemOptions,\r\n        });\r\n        let coverBonus = undefined;\r\n\r\n        if (cover) {\r\n            let ac = getPerception(perception, \"target\", \"cover\", \"ac\", cover)?.first();\r\n            if (ac != null) ac = Math.clamped(asNumberOnly(ac), 0, 4);\r\n            if (ac === 0) cover = undefined;\r\n            else if (ac) coverBonus = ac;\r\n        }\r\n\r\n        const overrideVisibility = VISIBILITY_VALUES[visibility] > VISIBILITY_VALUES.concealed;\r\n        const overrideCover = COVER_VALUES[cover] > COVER_VALUES.none;\r\n\r\n        if (overrideCover || overrideVisibility) {\r\n            const items = foundry.utils.deepClone(targetActor._source.items);\r\n\r\n            if (overrideCover) {\r\n                const source = createCoverSource(cover, coverBonus);\r\n                items.push(source);\r\n            }\r\n\r\n            if (overrideVisibility) {\r\n                const source = createFlatFootedSource(visibility);\r\n                items.push(source);\r\n            }\r\n\r\n            target.actor = targetActor.clone({ items }, { keepId: true });\r\n\r\n            const dc = context.dc;\r\n            if (dc?.slug) {\r\n                const statistic = target.actor.getStatistic(dc.slug)?.dc;\r\n                if (statistic) {\r\n                    dc.value = statistic.value;\r\n                    dc.statistic = statistic;\r\n                }\r\n            }\r\n        }\r\n\r\n        return wrapped(...args);\r\n    } else if (context.options.has(\"action:hide\")) {\r\n        foundry.utils.setProperty(context, \"pf2ePerception.selected\", game.user.targets.ids);\r\n        // } else if (context.options.has('action:sneak')) {\r\n        //     context.selected = game.user.targets.ids\r\n    } else if (context.options.has(\"action:create-a-diversion\")) {\r\n        foundry.utils.setProperty(context, \"pf2ePerception.selected\", game.user.targets.ids);\r\n    } else if (context.options.has(\"action:seek\")) {\r\n        const highlighted = getSeekTemplateTokens(originToken);\r\n        const tokens = highlighted ?? Array.from(game.user.targets);\r\n        const selected = validateTokens(originToken, tokens)\r\n            .filter((t) => !t.document.hidden)\r\n            .map((t) => t.id);\r\n\r\n        foundry.utils.setProperty(context, \"pf2ePerception.selected\", selected);\r\n        foundry.utils.setProperty(context, \"pf2ePerception.fromTemplate\", !!highlighted);\r\n    }\r\n\r\n    return wrapped(...args);\r\n}\r\n\r\nexport function renderCheckModifiersDialog(dialog, html) {\r\n    const { createMessage = \"true\", type, token, target, isReroll, options, dc } = dialog.context;\r\n    const originToken = token;\r\n    const targetToken = target?.token;\r\n    const targetActor = target?.actor;\r\n\r\n    if (\r\n        isReroll ||\r\n        !createMessage ||\r\n        !originToken ||\r\n        !targetToken ||\r\n        !targetActor ||\r\n        !attackCheckRoll.includes(type)\r\n    )\r\n        return;\r\n\r\n    const coverEffect = getCoverEffect(targetActor);\r\n    const currentCover = coverEffect\r\n        ? findChoiceSetRule(coverEffect)?.selection.level ?? getFlag(coverEffect, \"level\")\r\n        : undefined;\r\n    let coverOverride = dialog[MODULE_ID]?.coverOverride ?? currentCover;\r\n\r\n    let template = `<div class=\"conditional\">\r\n    <div class=\"label\">${localize(\"dice-checks.cover.label\")}</div>\r\n    <select name=\"overrideCover\">\r\n        <option value=\"\">${localize(\"dice-checks.cover.none\")}</option>`;\r\n\r\n    const covers = isProne(targetActor) ? COVERS.slice(1) : COVERS.slice(1, -1);\r\n\r\n    for (const slug of covers) {\r\n        const selected = slug === coverOverride ? \"selected\" : \"\";\r\n        const label = localize(`cover.${slug}`);\r\n        template += `<option value=\"${slug}\" ${selected}>${label}</option>`;\r\n    }\r\n\r\n    template += \"</select></div>\";\r\n\r\n    // visibility override here\r\n\r\n    template += \"<hr>\";\r\n\r\n    html.find(\".roll-mode-panel\").before(template);\r\n\r\n    html.find(\"select[name=overrideCover]\").on(\"change\", (event) => {\r\n        const value = event.currentTarget.value || undefined;\r\n        foundry.utils.setProperty(dialog, `${MODULE_ID}.coverOverride`, value);\r\n        coverOverride = value;\r\n    });\r\n\r\n    html.find(\"button.roll\")[0].addEventListener(\r\n        \"click\",\r\n        (event) => {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            event.stopImmediatePropagation();\r\n\r\n            let modified = false;\r\n            const items = foundry.utils.deepClone(targetActor._source.items);\r\n\r\n            if (coverOverride !== currentCover) {\r\n                modified = true;\r\n\r\n                const coverIndex = items.findIndex(\r\n                    (i) => foundry.utils.getProperty(i, \"flags.core.sourceId\") === COVER_UUID\r\n                );\r\n                if (coverIndex !== -1) items.splice(coverIndex, 1);\r\n\r\n                if (coverOverride) {\r\n                    const source = createCoverSource(coverOverride);\r\n                    items.push(source);\r\n                }\r\n            }\r\n\r\n            if (modified) {\r\n                target.actor = targetActor.clone({ items }, { keepId: true });\r\n\r\n                if (dc?.slug) {\r\n                    const statistic = target.actor.getStatistic(dc.slug)?.dc;\r\n                    if (statistic) {\r\n                        dc.value = statistic.value;\r\n                        dc.statistic = statistic;\r\n                    }\r\n                }\r\n            }\r\n\r\n            dialog.resolve(true);\r\n            dialog.isResolved = true;\r\n            dialog.close();\r\n        },\r\n        true\r\n    );\r\n\r\n    dialog.setPosition();\r\n}\r\n\r\nexport function getFlatCheckDc(originToken, targetToken, extraOptions = []) {\r\n    const perception = perceptionRules(originToken, targetToken, {\r\n        extraOptions,\r\n    });\r\n\r\n    const visibility = getVisibility(targetToken, originToken, {\r\n        perception,\r\n        affects: \"target\",\r\n    });\r\n    if (!visibility) return 0;\r\n\r\n    const dc = (() => {\r\n        const dc = getPerception(perception, \"target\", \"visibility\", \"dc\", visibility)?.first();\r\n        const numberedDC = asNumberOnly(dc);\r\n        if (!numberedDC) return numberedDC;\r\n\r\n        const sign = dc[0];\r\n        if (![\"-\", \"+\"].includes(sign)) return numberedDC;\r\n\r\n        return (visibility === \"concealed\" ? 5 : 11) + numberedDC;\r\n    })();\r\n\r\n    return dc ?? (visibility === \"concealed\" ? 5 : 11);\r\n}\r\n", "import { getCoverEffect, hasGreaterDarkvision, isProne, seeInvisibility } from \"./actor.js\";\r\nimport { getFlatCheckDc } from \"./check.js\";\r\nimport {\r\n    clearDebug,\r\n    getRectEdges,\r\n    lineIntersectWall,\r\n    pointToTokenIntersectWall,\r\n} from \"./geometry.js\";\r\nimport { getLightExposure } from \"./lighting.js\";\r\nimport { getPerception, perceptionRules, updateFromPerceptionRules } from \"./rule-element.js\";\r\nimport { getSceneSetting, getValidTokens, validateTokens } from \"./scene.js\";\r\nimport {\r\n    createDarknessTemplate,\r\n    createMistTemplate,\r\n    createSeekTemplate,\r\n    deleteSeekTemplate,\r\n    getDarknessTemplates,\r\n    getMistTemplates,\r\n    getSeekTemplateTokens,\r\n    getTemplateTokens,\r\n} from \"./template.js\";\r\nimport {\r\n    clearConditionals,\r\n    getCover,\r\n    getCreatureCover,\r\n    getTokenData,\r\n    getVisibility,\r\n    getWallCover,\r\n    openHUD,\r\n    showAllConditionals,\r\n    showConditionals,\r\n} from \"./token.js\";\r\n\r\nexport const API = {\r\n    check: {\r\n        getFlatCheckDc,\r\n    },\r\n    geometry: {\r\n        clearDebug,\r\n        getRectEdges,\r\n        lineIntersectWall,\r\n        pointToTokenIntersectWall,\r\n    },\r\n    token: {\r\n        getCreatureCover,\r\n        getWallCover,\r\n        getVisibility,\r\n        clearConditionals,\r\n        showConditionals,\r\n        showAllConditionals,\r\n        getTokenData,\r\n        getCover,\r\n        openHUD,\r\n    },\r\n    lighting: {\r\n        getLightExposure,\r\n    },\r\n    actor: {\r\n        isProne,\r\n        getCoverEffect,\r\n        seeInvisibility,\r\n        hasGreaterDarkvision,\r\n    },\r\n    scene: {\r\n        getValidTokens,\r\n        validateTokens,\r\n        getSceneSetting,\r\n    },\r\n    template: {\r\n        createSeekTemplate,\r\n        createDarknessTemplate,\r\n        createMistTemplate,\r\n        getDarknessTemplates,\r\n        getMistTemplates,\r\n        getSeekTemplateTokens,\r\n        deleteSeekTemplate,\r\n        getTemplateTokens,\r\n    },\r\n    ruleElement: {\r\n        perceptionRules,\r\n        getPerception,\r\n        updateFromPerceptionRules,\r\n    },\r\n};\r\n", "import { getSetting, localize, setSetting } from \"./module.js\";\r\n\r\nexport function renderCombatTracker(tracker, html) {\r\n    if (getSetting(\"target\")) setupToggleTarget(html);\r\n    // hideUndetected(html)\r\n}\r\n\r\nfunction hideUndetected(html) {\r\n    if (!canvas.ready) return;\r\n\r\n    const combatants = game.combats.viewed?.combatants;\r\n    if (!combatants?.size) return;\r\n\r\n    html.find(\"#combat-tracker .combatant\").each((i, li) => {\r\n        const { combatantId } = li.dataset;\r\n        const token = combatants.get(combatantId ?? \"\")?.token;\r\n        if (!token) return;\r\n\r\n        // if (isUndetected(token, 'basicSight', true)) li.remove()\r\n    });\r\n}\r\n\r\nfunction setupToggleTarget(html) {\r\n    html.find(\"[data-control=toggleTarget]\").each((_, el) => {\r\n        el.addEventListener(\r\n            \"click\",\r\n            (event) => {\r\n                event.preventDefault();\r\n                event.stopPropagation();\r\n                event.stopImmediatePropagation();\r\n\r\n                const { combatantId } = event.currentTarget.closest(\".combatant\").dataset;\r\n                const combatant = game.combats.viewed.combatants.get(combatantId ?? \"\");\r\n                const token = combatant?.token;\r\n                if (!token) return;\r\n\r\n                const isTargeted = Array.from(game.user.targets).some((t) => t.document === token);\r\n                token.object.setTarget(!isTargeted, { releaseOthers: !event.shiftKey });\r\n            },\r\n            true\r\n        );\r\n    });\r\n}\r\n\r\nexport function renderCombatTrackerConfig(config, html) {\r\n    const checked = getSetting(\"encounter\");\r\n\r\n    html.find(\".form-group\").last().after(`<div class=\"form-group\">\r\n    <label>${localize(\"settings.encounter.name\")}</label>\r\n    <input type=\"checkbox\" name=\"pf2e-perception.encounter\" ${checked ? \"checked\" : \"\"}>\r\n    <p class=\"notes\">${localize(\"settings.encounter.short\")}</p>\r\n</div>`);\r\n\r\n    html.find('input[name=\"pf2e-perception.encounter\"]').on(\"change\", (event) => {\r\n        const checked = event.currentTarget.checked;\r\n        setSetting(\"encounter\", checked);\r\n    });\r\n}\r\n", "import { VISIBILITY_VALUES } from \"./constants.js\";\r\nimport { perceptionRules } from \"./rule-element.js\";\r\nimport { getVisibility } from \"./token.js\";\r\n\r\nexport function detectionModeTestVisibility(visionSource, mode, config = {}) {\r\n    if (!mode.enabled) return false;\r\n    if (!this._canDetect(visionSource, config.object, config)) return false;\r\n    return config.tests.some((test) => this._testPoint(visionSource, mode, config.object, test));\r\n}\r\n\r\nexport function canDetect(threshold) {\r\n    return function (wrapped, visionSource, target, config) {\r\n        const canDetect = wrapped(visionSource, target);\r\n        if (canDetect === false) return false;\r\n\r\n        const origin = visionSource.object;\r\n        const reachedThreshold = reachesThreshold(origin, target, threshold, config);\r\n\r\n        return !reachedThreshold;\r\n    };\r\n}\r\n\r\nfunction reachesThreshold(origin, target, threshold, config = {}) {\r\n    if (!origin.actor || !target.actor) return false;\r\n\r\n    if (!config.visibility) {\r\n        const perception = perceptionRules(origin, target);\r\n        config.visibility = getVisibility(target, origin, { perception, affects: \"target\" });\r\n    }\r\n\r\n    return VISIBILITY_VALUES[config.visibility] >= threshold;\r\n}\r\n", "import { ICONS_PATHS } from \"../constants.js\";\r\nimport { getSetting, localize, setSetting, templatePath } from \"../module.js\";\r\n\r\nconst ICONS = [\"cover\", \"concealed\", \"hidden\", \"undetected\", \"unnoticed\"];\r\n\r\nexport class IconPathMenu extends FormApplication {\r\n    static get defaultOptions() {\r\n        return foundry.utils.mergeObject(super.defaultOptions, {\r\n            template: templatePath(\"icon-path-menu\"),\r\n            title: localize(\"settings.icon-path.name\"),\r\n            width: 500,\r\n        });\r\n    }\r\n\r\n    getData() {\r\n        const saved = getSetting(\"icon-path\");\r\n\r\n        const icons = ICONS.map((name) => ({\r\n            name,\r\n            placeholder: ICONS_PATHS[name],\r\n            value: saved[name] ?? \"\",\r\n            label:\r\n                name === \"cover\"\r\n                    ? localize(\"icon-path.cover\")\r\n                    : game.i18n.localize(CONFIG.PF2E.conditionTypes[name]),\r\n        }));\r\n\r\n        return {\r\n            icons,\r\n            i18n: localize,\r\n        };\r\n    }\r\n\r\n    activateListeners(html) {\r\n        super.activateListeners(html);\r\n\r\n        html.find(\"button[name=cancel]\").on(\"click\", (event) => {\r\n            event.prefentDefault();\r\n            this.close();\r\n        });\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n        setSetting(\"icon-path\", formData);\r\n    }\r\n}\r\n", "import { IconPathMenu } from \"./apps/icon-path-menu.js\";\r\nimport { MODULE_ID } from \"./module.js\";\r\n\r\nexport function registerSettings() {\r\n    register(\"icon-path\", Object, {}, { config: false });\r\n    game.settings.registerMenu(MODULE_ID, \"icon-path-menu\", {\r\n        name: path(\"icon-path\", \"name\"),\r\n        label: path(\"icon-path\", \"label\"),\r\n        icon: \"fa-solid fa-list\",\r\n        restricted: true,\r\n        type: IconPathMenu,\r\n    });\r\n\r\n    register(\"permission\", String, CONST.USER_ROLES.GAMEMASTER, {\r\n        choices: {\r\n            1: path(\"permission\", \"choices.1\"),\r\n            2: path(\"permission\", \"choices.2\"),\r\n            3: path(\"permission\", \"choices.3\"),\r\n            4: path(\"permission\", \"choices.4\"),\r\n        },\r\n    });\r\n\r\n    register(\"npc-vision\", Boolean, false);\r\n\r\n    register(\"target\", Boolean, true, {\r\n        onChange: () => ui.combat?.render(),\r\n    });\r\n\r\n    register(\"lesser\", String, \"ten\", {\r\n        choices: {\r\n            none: path(\"lesser\", \"choices.none\"),\r\n            cross: path(\"lesser\", \"choices.cross\"),\r\n            zero: path(\"lesser\", \"choices.zero\"),\r\n            ten: path(\"lesser\", \"choices.ten\"),\r\n            twenty: path(\"lesser\", \"choices.twenty\"),\r\n        },\r\n    });\r\n\r\n    register(\"standard\", Boolean, true);\r\n\r\n    register(\"dead-cover\", Boolean, true);\r\n\r\n    register(\"prone-cover\", Boolean, true);\r\n\r\n    register(\"standard-type\", String, \"center\", {\r\n        choices: {\r\n            center: path(\"standard-type\", \"choices.center\"),\r\n            points: path(\"standard-type\", \"choices.points\"),\r\n        },\r\n    });\r\n\r\n    register(\"skip-cover\", Boolean, true);\r\n\r\n    register(\"validation\", String, \"all\", {\r\n        choices: {\r\n            all: path(\"validation\", \"choices.all\"),\r\n            selected: path(\"validation\", \"choices.selected\"),\r\n            changed: path(\"validation\", \"choices.changed\"),\r\n        },\r\n    });\r\n\r\n    register(\"flat-check\", String, \"roll\", {\r\n        choices: {\r\n            none: path(\"flat-check\", \"choices.none\"),\r\n            roll: path(\"flat-check\", \"choices.roll\"),\r\n            cancel: path(\"flat-check\", \"choices.cancel\"),\r\n        },\r\n    });\r\n\r\n    register(\"encounter\", Boolean, false);\r\n\r\n    register(\"icon-size\", Number, 26, {\r\n        scope: \"client\",\r\n        range: {\r\n            min: 26,\r\n            max: 52,\r\n        },\r\n    });\r\n\r\n    register(\"seek-template\", Boolean, true, {\r\n        scope: \"client\",\r\n    });\r\n}\r\n\r\nfunction path(setting, key) {\r\n    return `${MODULE_ID}.settings.${setting}.${key}`;\r\n}\r\n\r\nfunction register(name, type, defValue, extra = {}) {\r\n    game.settings.register(MODULE_ID, name, {\r\n        name: path(name, \"name\"),\r\n        hint: path(name, \"hint\"),\r\n        scope: \"world\",\r\n        config: true,\r\n        type,\r\n        default: defValue,\r\n        ...extra,\r\n    });\r\n}\r\n", "import { setupActions } from \"./action.js\";\r\nimport { API } from \"./api.js\";\r\nimport { renderChatMessage } from \"./chat.js\";\r\nimport { checkRoll, renderCheckModifiersDialog } from \"./check.js\";\r\nimport { renderCombatTracker, renderCombatTrackerConfig } from \"./combat.js\";\r\nimport { VISIBILITY_VALUES } from \"./constants.js\";\r\nimport { canDetect, detectionModeTestVisibility } from \"./detection.js\";\r\nimport { MODULE_ID } from \"./module.js\";\r\nimport { setupRuleElement } from \"./rule-element.js\";\r\nimport { renderSceneConfig } from \"./scene.js\";\r\nimport { registerSettings } from \"./settings.js\";\r\nimport {\r\n    highlightTemplateGrid,\r\n    onMeasuredTemplate,\r\n    preCreateMeasuredTemplate,\r\n} from \"./template.js\";\r\nimport {\r\n    clearConditionals,\r\n    controlToken,\r\n    deleteToken,\r\n    hoverToken,\r\n    pasteToken,\r\n    preCreateToken,\r\n    renderTokenHUD,\r\n    updateToken,\r\n} from \"./token.js\";\r\n\r\nconst CHECK_ROLL = \"game.pf2e.Check.roll\";\r\n\r\nconst HIGHLIGHT_TEMPLATE_GRID = \"CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid\";\r\n\r\nconst DETECTION_MODE_TEST_VISIBILITY = \"DetectionMode.prototype.testVisibility\";\r\nconst LIGHT_CAN_DETECT = \"CONFIG.Canvas.detectionModes.lightPerception._canDetect\";\r\nconst VISION_CAN_DETECT = \"CONFIG.Canvas.detectionModes.basicSight._canDetect\";\r\nconst HEARING_CAN_DETECT = \"CONFIG.Canvas.detectionModes.hearing._canDetect\";\r\nconst TREMOR_CAN_DETECT = \"CONFIG.Canvas.detectionModes.feelTremor._canDetect\";\r\n\r\nHooks.once(\"init\", () => {\r\n    registerSettings();\r\n    setupActions();\r\n    setupRuleElement();\r\n\r\n    libWrapper.register(MODULE_ID, CHECK_ROLL, checkRoll);\r\n\r\n    libWrapper.register(MODULE_ID, HIGHLIGHT_TEMPLATE_GRID, highlightTemplateGrid, \"OVERRIDE\");\r\n\r\n    libWrapper.register(\r\n        MODULE_ID,\r\n        DETECTION_MODE_TEST_VISIBILITY,\r\n        detectionModeTestVisibility,\r\n        \"OVERRIDE\"\r\n    );\r\n    libWrapper.register(\r\n        MODULE_ID,\r\n        LIGHT_CAN_DETECT,\r\n        canDetect(VISIBILITY_VALUES.hidden),\r\n        \"WRAPPER\"\r\n    );\r\n    libWrapper.register(\r\n        MODULE_ID,\r\n        VISION_CAN_DETECT,\r\n        canDetect(VISIBILITY_VALUES.hidden),\r\n        \"WRAPPER\"\r\n    );\r\n    libWrapper.register(\r\n        MODULE_ID,\r\n        HEARING_CAN_DETECT,\r\n        canDetect(VISIBILITY_VALUES.undetected),\r\n        \"WRAPPER\"\r\n    );\r\n    libWrapper.register(\r\n        MODULE_ID,\r\n        TREMOR_CAN_DETECT,\r\n        canDetect(VISIBILITY_VALUES.undetected),\r\n        \"WRAPPER\"\r\n    );\r\n\r\n    const isGM =\r\n        game.data.users.find((x) => x._id === game.data.userId).role >= CONST.USER_ROLES.GAMEMASTER;\r\n    if (isGM) {\r\n        Hooks.on(\"renderSceneConfig\", renderSceneConfig);\r\n        Hooks.on(\"renderCombatTrackerConfig\", renderCombatTrackerConfig);\r\n    } else {\r\n        Hooks.on(\"renderCombatTracker\", renderCombatTracker);\r\n    }\r\n\r\n    game.modules.get(MODULE_ID).custom = {\r\n        getWallCover: undefined,\r\n        getCreatureCover: undefined,\r\n    };\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n    game.modules.get(MODULE_ID).api = API;\r\n\r\n    Hooks.on(\"renderChatMessage\", renderChatMessage);\r\n\r\n    for (const el of document.querySelectorAll(\"#chat-log .chat-message\")) {\r\n        const message = game.messages.get(el.dataset.messageId);\r\n        if (!message) continue;\r\n        renderChatMessage(message, $(el));\r\n    }\r\n\r\n    const isGM = game.user.isGM;\r\n\r\n    if (isGM && game.modules.get(\"pf2e-rules-based-npc-vision\")?.active) {\r\n        ui.notifications.error(`${MODULE_ID}.warning.npc-vision`, {\r\n            permanent: true,\r\n            localize: true,\r\n        });\r\n    }\r\n});\r\n\r\nHooks.on(\"hoverToken\", hoverToken);\r\nHooks.on(\"pasteToken\", pasteToken);\r\nHooks.on(\"updateToken\", updateToken);\r\nHooks.on(\"deleteToken\", deleteToken);\r\nHooks.on(\"controlToken\", controlToken);\r\nHooks.on(\"renderTokenHUD\", renderTokenHUD);\r\nHooks.on(\"preCreateToken\", preCreateToken);\r\n\r\nHooks.on(\"canvasPan\", () => clearConditionals());\r\n\r\nHooks.on(\"renderCheckModifiersDialog\", renderCheckModifiersDialog);\r\n\r\nHooks.on(\"preCreateMeasuredTemplate\", preCreateMeasuredTemplate);\r\nHooks.on(\"createMeasuredTemplate\", onMeasuredTemplate);\r\nHooks.on(\"updateMeasuredTemplate\", onMeasuredTemplate);\r\nHooks.on(\"deleteMeasuredTemplate\", onMeasuredTemplate);\r\n"],
  "mappings": "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",
  "names": ["COVER_UUID", "VISIBILITY_VALUES", "VISIBILITIES", "COVERS", "COVER_VALUES", "defaultValues", "attackCheckRoll", "validCheckRoll", "ICONS_PATHS", "DARKNESS_COLOR", "MIST_COLOR", "POISON_GREEN", "DARKNESS_SLUGS", "MIST_SLUGS", "MODULE_ID", "templatePath", "template", "__name", "localize", "args", "data", "useFormat", "keys", "getFlag", "doc", "flag", "setFlag", "value", "unsetFlag", "getFlags", "getSetting", "setting", "setSetting", "hasPermission", "getActionName", "action", "createFlatFootedSource", "visibility", "source", "__name", "createCoverSource", "level", "bonus", "COVER_VALUES", "localize", "COVER_UUID", "MODULE_ID", "findChoiceSetRule", "item", "flag", "rule", "getActorToken", "actor", "target", "actorId", "isToken", "token", "__name", "isProne", "item", "getCoverEffect", "selection", "effect", "x", "COVER_UUID", "findChoiceSetRule", "hasSense", "actor", "sense", "type", "__name", "hasGreaterDarkvision", "seeInvisibility", "DEGREE_ADJUSTMENT_AMOUNTS", "DEGREE_OF_SUCCESS_STRINGS", "_getDegreeAdjustment", "getDegreeAdjustment_fn", "_adjustDegreeOfSuccess", "adjustDegreeOfSuccess_fn", "_adjustDegreeByDieValue", "adjustDegreeByDieValue_fn", "_calculateDegreeOfSuccess", "calculateDegreeOfSuccess_fn", "_DegreeOfSuccess", "roll", "dc", "dosAdjustments", "__privateAdd", "t", "d", "__privateMethod", "DegreeOfSuccess", "__name", "degree", "adjustments", "outcome", "label", "amount", "degreeOfSuccess", "__publicField", "renderSceneConfig", "config", "html", "settings", "list", "setting", "checked", "getSceneSetting", "localize", "addedHeight", "height", "el", "__name", "getValidTokens", "token", "tokens", "t", "getSetting", "combat", "actor", "traits", "validateTokens", "validToken", "id", "scene", "getFlag", "measureDistance", "p0", "p1", "measureDistanceOnGrid", "__name", "segment", "reach", "gridSize", "gridDistance", "nx", "ny", "nz", "sortedDistance", "a", "b", "squares", "reduction", "highlightGrid", "areaShape", "object", "colors", "document", "collisionType", "preview", "collisionOrigin", "dimensions", "grid", "angle", "direction", "highlightLayer", "center", "col0", "row0", "minAngle", "maxAngle", "snappedOrigin", "withinAngle", "min", "max", "value", "coneOriginOffset", "dir", "xOffset", "yOffset", "padding", "docDistance", "padded", "rowCount", "columnCount", "offsetEmanationOrigin", "destination", "offset", "getCoordinate", "centerCoord", "destCoord", "gx", "gy", "emanationOriginOffset", "origin", "ray", "rayAngle", "templateConversion", "createTemplate", "type", "distance", "traits", "fillColor", "width", "flags", "templateData", "MODULE_ID", "__name", "createSeekTemplate", "token", "checkScene", "createDarknessTemplate", "conceal", "DARKNESS_COLOR", "createMistTemplate", "MIST_COLOR", "getTemplates", "t", "getFlag", "getDarknessTemplates", "getMistTemplates", "getSeekTemplateTokens", "template", "tokenDoc", "getTemplateTokens", "deleteSeekTemplate", "templates", "localize", "measuredTemplate", "collisionOrigin", "collisionType", "grid", "dimensions", "gridHighlight", "gridSize", "containedTokens", "origin", "tokens", "tokenPositions", "h", "tokenX", "y", "w", "position", "gx", "gy", "s", "destination", "highlightTemplateGrid", "isCircleOrCone", "hasSquareGrid", "highlightGrid", "preCreateMeasuredTemplate", "slug", "castLevel", "DARKNESS_SLUGS", "MIST_SLUGS", "POISON_GREEN", "onMeasuredTemplate", "getPrototype", "obj", "depth", "prototype", "__name", "sortByName", "a", "b", "asNumberOnly", "value", "BaseMenu", "#token", "#resolve", "#selected", "#_currentData", "#hoverTokenListener", "token", "resolve", "selected", "options", "hover", "tokenId", "tokens", "params", "localize", "MODULE_ID", "win", "x", "original", "current", "property", "defaultValue", "defaultValues", "originalValue", "currentValue", "validateTokens", "#currentData", "data", "getTokenData", "id", "COVERS", "value", "VISIBILITIES", "html", "event", "target", "tokenIds", "currentData", "setTokenData", "el", "allies", "enemies", "neutral", "alliance", "opposition", "actorAlliance", "sortByName", "__name", "PerceptionMenu", "BaseMenu", "localize", "templatePath", "options", "selected", "currentData", "originalData", "tokens", "getValidTokens", "id", "name", "actor", "current", "original", "html", "event", "section", "allSelected", "t", "__name", "RECT_SPREAD", "getRectEdges", "rect", "margin", "opposite", "getRectPoint", "__name", "lineIntersectWall", "origin", "target", "debug", "drawDebugLine", "pointToTokenIntersectWall", "token", "point", "rectSpread", "clearDebug", "color", "hex", "getLightExposure", "token", "debug", "scene", "clearDebug", "center", "exposure", "light", "bright", "dim", "drawDebugLine", "__name", "DATA", "SELECTORS", "setupRuleElement", "rollOptionSchema", "PredicateField", "ResolvableValueField", "PF2ePerceptionRuleElement", "source", "options", "selectorType", "selector", "selectorWarn", "__name", "msg", "name", "uuid", "targetsType", "joinedTargets", "t", "joinedValues", "sourcevalueType", "fields", "rollOptions", "password", "affects", "perception", "root", "verificator", "targets", "target", "path", "value", "perceptionRules", "origin", "distance", "extraOptions", "originActor", "targetActor", "rules", "r", "selfOptions", "otherOptions", "distances", "prefix", "testOptions", "rule", "getIgnoredPerception", "token", "actor", "getPerception", "type", "cursor", "updateFromPerceptionRules", "list", "COVERS", "VISIBILITIES", "setValue", "index", "renderTokenHUD", "hud", "html", "hasPermission", "event", "openHUD", "__name", "token", "PerceptionMenu", "pasteToken", "originals", "sources", "source", "MODULE_ID", "getTokenData", "path", "getFlag", "clearTokenData", "unsetFlag", "setTokenData", "data", "valid", "getValidTokens", "t", "updates", "tokenId", "current", "original", "defaultValues", "property", "getWallCover", "origin", "target", "debug", "scene", "getSceneSetting", "clearDebug", "getSetting", "pointToTokenIntersectWall", "lineIntersectWall", "SIZES", "getCover", "perception", "options", "affects", "prone", "isProne", "returnValue", "value", "updateFromPerceptionRules", "systemCover", "getCoverEffect", "COVER_VALUES", "cover", "api", "custom", "wallCover", "customCover", "COVERS", "creatureCover", "getCreatureCover", "originToken", "targetToken", "setting", "ignoreIds", "originIds", "targetIds", "originActor", "targetActor", "drawDebugLine", "isExtraLarge", "size", "originSize", "targetSize", "originAlliance", "deadCover", "proneCover", "tokens", "actor", "ignored", "getIgnoredPerception", "a", "b", "extralarges", "margin", "intersectsEdge", "edge", "intersectsWith", "edges", "tokenDocument", "getRectEdges", "getVisibility", "systemVisibility", "visibility", "condition", "VISIBILITY_VALUES", "isInvisible", "seeInvisibility", "getPerception", "mergedVisibility", "targetLowlight", "targetDarkvision", "targetGreaterDarkvision", "hasGreaterDarkvision", "inDarkness", "darknessTemplates", "getDarknessTemplates", "darknessVisibility", "template", "darknessTokens", "getTemplateTokens", "mistTemplates", "getMistTemplates", "mistTokens", "exposure", "getLightExposure", "exposedVisibility", "updateToken", "context", "userId", "flags", "hk", "refreshed", "hoverToken", "hovered", "showAllConditionals", "clearConditionals", "deleteToken", "controlToken", "controlled", "CONDITIONALS", "el", "showConditionals", "targetId", "coords", "iconSize", "width", "style", "content", "savedPaths", "icon", "ICONS_PATHS", "conditionals", "preCreateToken", "targets", "ValidationMenu", "BaseMenu", "params", "options", "validated", "validateMessage", "localize", "templatePath", "selected", "token", "alliance", "getValidTokens", "t", "converted", "data", "property", "scene", "defaultValue", "defaultValues", "propertyList", "COVERS", "VISIBILITIES", "tokenId", "fullProperty", "currentValue", "processedValue", "covers", "visibilities", "i18n", "currentData", "originalData", "tokens", "id", "name", "actor", "current", "original", "validation", "getSetting", "html", "event", "__name", "CoverValidationMenu", "#value", "VisibilityValidationMenu", "#roll", "HideValidationMenu", "value", "roll", "dc", "visibility", "VISIBILITY_VALUES", "success", "DegreeOfSuccess", "CreateADiversionMenu", "UnHideValidationMenu", "PointOutValidationMenu", "#originator", "originatorId", "getTokenData", "ReverseVisibilityValidationMenu", "thisId", "tokenData", "parentData", "updates", "update", "MODULE_ID", "SeekValidationMenu", "#fromTemplate", "deleteSeekTemplate", "renderChatMessage", "message", "html", "token", "isGM", "hasPlayerOwner", "cover", "selected", "skipWait", "validated", "pointOut", "getFlags", "pf2eContext", "button", "createValidateButton", "CoverValidationMenu", "hint", "createWaitHint", "flavor", "msg", "localize", "createHint", "type", "createChatButton", "setFlag", "HideValidationMenu", "CreateADiversionMenu", "addBlindSkillCheckFlavor", "addSkillCheckFlavor", "buttons", "createValidateCombo", "SeekValidationMenu", "deleteSeekTemplate", "selectedToken", "PointOutValidationMenu", "t", "attackCheckRoll", "event", "UnHideValidationMenu", "__name", "validateMessage", "getFlag", "smallIcon", "smallAction", "smallSlashed", "actionTitle", "action", "modifier", "skillName", "check", "getActionName", "title", "property", "label", "icon", "tooltip", "slashed", "createTokenMessage", "content", "flags", "secret", "data", "MODULE_ID", "setupActions", "hide", "BaseAction", "getPrototype", "BaseActionVariant", "SingleCheckAction", "SingleCheckActionVariant", "setupCover", "setupHide", "setupCreateADiversion", "setupSneak", "setupSeek", "setupPointOut", "__name", "PointOutVariant", "options", "action", "localize", "token", "getSelectedToken", "pointOut", "PointOut", "MODULE_ID", "data", "name", "traits", "target", "t", "visibility", "getTokenData", "isVisible", "VISIBILITY_VALUES", "description", "dc", "content", "templatePath", "slug", "flags", "createTokenMessage", "SeekVariant", "getActionName", "getSetting", "seek", "deleteSeekTemplate", "Seek", "unit", "templates", "type", "distance", "label", "html", "event", "createSeekTemplate", "SneakVariant", "Sneak", "CreateADiversionVariant", "CreateADiversion", "HideVariant", "Hide", "TakeCoverVariant", "takeCover", "TakeCover", "actor", "cover", "getCoverEffect", "targets", "validateTokens", "covers", "tokenId", "id", "isProne", "dialog", "level", "skip", "process", "isSelected", "selected", "flavor", "defaultValues", "clearTokenData", "setTokenData", "source", "createCoverSource", "tokens", "actors", "getActorToken", "checkRoll", "wrapped", "args", "context", "actor", "createMessage", "type", "token", "target", "isReroll", "viewOnly", "item", "originToken", "getActorToken", "targetToken", "flatCheck", "getSetting", "validCheckRoll", "targetActor", "attackCheckRoll", "event", "perception", "perceptionRules", "o", "visibility", "getVisibility", "dc", "getPerception", "numberedDC", "asNumberOnly", "sign", "isUndetected", "VISIBILITY_VALUES", "isBlind", "isSuccess", "itemOptions", "distance", "cover", "getCover", "coverBonus", "ac", "overrideVisibility", "overrideCover", "COVER_VALUES", "items", "source", "createCoverSource", "createFlatFootedSource", "statistic", "highlighted", "getSeekTemplateTokens", "tokens", "selected", "validateTokens", "t", "__name", "renderCheckModifiersDialog", "dialog", "html", "options", "coverEffect", "getCoverEffect", "currentCover", "findChoiceSetRule", "getFlag", "coverOverride", "MODULE_ID", "template", "localize", "covers", "isProne", "COVERS", "slug", "label", "value", "modified", "coverIndex", "i", "COVER_UUID", "getFlatCheckDc", "extraOptions", "API", "getFlatCheckDc", "clearDebug", "getRectEdges", "lineIntersectWall", "pointToTokenIntersectWall", "getCreatureCover", "getWallCover", "getVisibility", "clearConditionals", "showConditionals", "showAllConditionals", "getTokenData", "getCover", "openHUD", "getLightExposure", "isProne", "getCoverEffect", "seeInvisibility", "hasGreaterDarkvision", "getValidTokens", "validateTokens", "getSceneSetting", "createSeekTemplate", "createDarknessTemplate", "createMistTemplate", "getDarknessTemplates", "getMistTemplates", "getSeekTemplateTokens", "deleteSeekTemplate", "getTemplateTokens", "perceptionRules", "getPerception", "updateFromPerceptionRules", "renderCombatTracker", "tracker", "html", "getSetting", "setupToggleTarget", "__name", "setupToggleTarget", "html", "_", "el", "event", "combatantId", "token", "isTargeted", "t", "__name", "renderCombatTrackerConfig", "config", "checked", "getSetting", "localize", "setSetting", "detectionModeTestVisibility", "visionSource", "mode", "config", "test", "__name", "canDetect", "threshold", "wrapped", "target", "origin", "reachesThreshold", "perception", "perceptionRules", "getVisibility", "VISIBILITY_VALUES", "ICONS", "IconPathMenu", "templatePath", "localize", "saved", "getSetting", "name", "ICONS_PATHS", "html", "event", "formData", "setSetting", "__name", "registerSettings", "register", "MODULE_ID", "path", "IconPathMenu", "__name", "setting", "key", "name", "type", "defValue", "extra", "CHECK_ROLL", "HIGHLIGHT_TEMPLATE_GRID", "DETECTION_MODE_TEST_VISIBILITY", "LIGHT_CAN_DETECT", "VISION_CAN_DETECT", "HEARING_CAN_DETECT", "TREMOR_CAN_DETECT", "registerSettings", "setupActions", "setupRuleElement", "MODULE_ID", "checkRoll", "highlightTemplateGrid", "detectionModeTestVisibility", "canDetect", "VISIBILITY_VALUES", "x", "renderSceneConfig", "renderCombatTrackerConfig", "renderCombatTracker", "API", "renderChatMessage", "el", "message", "hoverToken", "pasteToken", "updateToken", "deleteToken", "controlToken", "renderTokenHUD", "preCreateToken", "clearConditionals", "renderCheckModifiersDialog", "preCreateMeasuredTemplate", "onMeasuredTemplate"]
}
