(()=>{var It=Object.defineProperty;var vn=(t,e,n)=>e in t?It(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>It(t,"name",{value:e,configurable:!0});var Ce=(t,e,n)=>(vn(t,typeof e!="symbol"?e+"":e,n),n),yn=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var xe=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var W=(t,e,n)=>(yn(t,e,"access private method"),n);var ge="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",k={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},ae=["observed","concealed","hidden","undetected","unnoticed"],H=["none","lesser","standard","greater","greater-prone"],E={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},z={cover:"none",visibility:"observed"},me=["attack-roll","spell-attack-roll"],Et=[...me,"skill-check","perception-check"],Ne={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"};var ut="#000000",ft="#656665",Dt="#809e71",Ot=["darkness","dance-of-darkness","ravenous-darkness"],At=["obscuring-mist","stinking-cloud","noxious-vapors"];var m="pf2e-perception";function Q(t){return`modules/${m}/templates/${t}.hbs`}r(Q,"templatePath");function h(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(m),game.i18n[n?"format":"localize"](o.join("."),e)}r(h,"localize");function L(t,e){return t.getFlag(m,e)}r(L,"getFlag");function pt(t,e,n){return t.setFlag(m,e,n)}r(pt,"setFlag");function Pt(t,e){return t.unsetFlag(m,e,!0)}r(Pt,"unsetFlag");function $t(t){return foundry.utils.getProperty(t,`flags.${m}`)??{}}r($t,"getFlags");function D(t){return game.settings.get(m,t)}r(D,"getSetting");function Ue(t,e){return game.settings.set(m,t,e)}r(Ue,"setSetting");function Rt(){return game.user.role>=D("permission")}r(Rt,"hasPermission");function le(t){return game.i18n.localize(`PF2E.Actions.${t}.Title`)}r(le,"getActionName");function Ft(t){let n=game.pf2e.ConditionManager.getCondition("off-guard").toObject();return n.name+=` (${game.i18n.localize(`PF2E.condition.${t}.name`)})`,n}r(Ft,"createFlatFootedSource");function Ie(t,e){return e??=E[t]===3?4:E[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:h("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:ge},[m]:{level:t,bonus:e}}}}r(Ie,"createCoverSource");function ze(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(ze,"findChoiceSetRule");function Ee(t,e=!1){if(!(t instanceof Actor))return;let n=t.id,o=t.isToken;return(e?game.user.targets:canvas.tokens?.controlled??[]).find(i=>o?i.actor===t:i.actor.id===n)??t.getActiveTokens().shift()??null}r(Ee,"getActorToken");function Z(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(Z,"isProne");function te(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===ge);return e?ze(n)?.selection.level:n}r(te,"getCoverEffect");function wt(t,e){return!t||!e||!t.system.perception?.senses?!1:(e=e.toLowerCase(),!!t.system.perception.senses.find(({type:n})=>n===e))}r(wt,"hasSense");function Ge(t){return wt(t,"greater-darkvision")}r(Ge,"hasGreaterDarkvision");function je(t){return wt(t,"see-invisibility")}r(je,"seeInvisibility");var He={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},Lt=["criticalFailure","failure","success","criticalSuccess"],We,Mt,he,Be,de,De,Ye,_t,ne=class{constructor(e,n,o=null){xe(this,We);xe(this,he);xe(this,de);xe(this,Ye);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(s=>s instanceof NumericTerm):e.dice.find(s=>s instanceof foundry.dice.terms.Die&&s.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=W(this,Ye,_t).call(this),this.adjustment=W(this,We,Mt).call(this,this.unadjusted,o),this.value=this.adjustment?W(this,he,Be).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},M=ne;r(M,"DegreeOfSuccess"),We=new WeakSet,Mt=r(function(e,n){if(!n)return null;for(let o of["all",...Lt]){let{label:s,amount:i}=n[o]??{};if(i&&s&&!(e===ne.CRITICAL_SUCCESS&&i===He.INCREASE)&&!(e===ne.CRITICAL_FAILURE&&i===He.LOWER)&&(o==="all"||Lt.indexOf(o)===e))return{label:s,amount:i}}return null},"#getDegreeAdjustment"),he=new WeakSet,Be=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),de=new WeakSet,De=r(function(e){return this.dieResult===20?W(this,he,Be).call(this,He.INCREASE,e):this.dieResult===1?W(this,he,Be).call(this,He.LOWER,e):e},"#adjustDegreeByDieValue"),Ye=new WeakSet,_t=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?W(this,de,De).call(this,ne.CRITICAL_SUCCESS):e-this.rollTotal>=10?W(this,de,De).call(this,ne.CRITICAL_FAILURE):this.rollTotal>=e?W(this,de,De).call(this,ne.SUCCESS):W(this,de,De).call(this,ne.FAILURE)},"#calculateDegreeOfSuccess"),Ce(M,"CRITICAL_FAILURE",0),Ce(M,"FAILURE",1),Ce(M,"SUCCESS",2),Ce(M,"CRITICAL_SUCCESS",3);function Vt(t,e){let n="",o=["standard","npc-vision"];for(let i of o){let c=ve(t.object,i);n+=`<div class="form-group pf2e-perception-injected">
    <label>${h(`settings.${i}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${i}" ${c?"checked":""}>
    <p class="notes">${h(`settings.${i}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let s=e.find(".pf2e-perception-injected").toArray().reduce((i,c)=>(i+=c.clientHeight,i),0);t.setPosition({top:t.position.top-s/2})}r(Vt,"renderSceneConfig");function G(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(D("encounter")){let n=game.combats.active;return n?e.filter(o=>{let s=o.actor,i=s.traits;return s.type==="familiar"||i.has("minion")||i.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(G,"getValidTokens");function oe(t,e){let n=G(t).map(o=>o.id);return e.filter(o=>{let s=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(s)})}r(oe,"validateTokens");function ve(t,e){return L(t,e)??D(e)}r(ve,"getSceneSetting");function kn(t,e){return canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measurePath([t,e]).distance:bn(new Ray(t,e))}r(kn,"measureDistance");function bn(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let n=canvas.dimensions.size,o=canvas.dimensions.distance,s=Math.ceil(Math.abs(t.dx/n)),i=Math.ceil(Math.abs(t.dy/n)),c=Math.ceil(Math.abs((t.dz||0)/n)),a=[s,i,c].sort((l,p)=>l-p),d={doubleDiagonal:a[0],diagonal:a[1]-a[0],straight:a[2]-a[1]},f=d.diagonal+d.doubleDiagonal>1&&e===10?1:0;return(Math.floor(d.doubleDiagonal*1.75+d.diagonal*1.5+d.straight)-f)*o}r(bn,"measureDistanceOnGrid");function Nt({areaShape:t,object:e,colors:n,document:o,collisionType:s="move",preview:i=!1,collisionOrigin:c}){if(!e.id&&!i)return;let a=canvas.dimensions,d=canvas.interface.grid;if(!(d&&a))return;let f=o.angle??0,u=o.direction??45,l=d.getHighlightLayer(e.highlightId)?.clear();if(!l)return;let p=canvas.grid.getCenterPoint({x:o.x,y:o.y}),{i:g,j:v}=canvas.grid.getOffset({x:p.x,y:p.y}),S=(360+(u-f*.5)%360)%360,F=(360+(u+f*.5)%360)%360,b="snappingMode"in e?canvas.grid.getSnappedPoint({x:o.x,y:o.y},{mode:e.snappingMode}):e.center,y=r((I,w,R)=>(I=(360+I%360)%360,w=(360+w%360)%360,R=(360+R%360)%360,I<w?R>=I&&R<=w:R>=I||R<=w),"withinAngle"),C=(()=>{if(t!=="cone")return{x:0,y:0};let I=(u>=0?360-u:-u)%360,w=b.x%a.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(I))*100)/100)/2:0,R=b.y%a.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(I))*100)/100)/2:0;return{x:w*a.size,y:R*a.size}})(),x=Math.clamp(o.width??0,1.5,2),_=o.distance??0,T=_*x/a.distance,O=Math.ceil(T/(a.size/canvas.grid.sizeX)),A=Math.ceil(T/(a.size/canvas.grid.sizeY)),U=r(I=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=a.size)return{x:0,y:0};let w=(e.w-a.size)/2,R=r((K,j)=>j===K?0:j>K?w:-w,"getCoordinate");return{x:R(e.center.x,I.x),y:R(e.center.y,I.y)}},"offsetEmanationOrigin");for(let I=-A;I<A;I++)for(let w=-O;w<O;w++){let{x:R,y:K}=canvas.grid.getTopLeftPoint({i:g+I,j:v+w}),j={x:R+a.size*.5,y:K+a.size*.5};if(j.x<0||j.y<0)continue;let ce=U(j),ee={x:b.x+C.x+ce.x,y:b.y+C.y+ce.y};if(t==="cone"){let xt=new Ray(ee,j),hn=(360+xt.angle/(Math.PI/180)%360)%360;if(xt.distance>0&&!y(S,F,hn))continue}if(kn(j,ee)>_)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[s].testCollision(c??ee,j,{type:s,mode:"any"})?(d.highlightPosition(l.name,{x:R,y:K,border:1,color:0}),l.beginFill(0,.5).moveTo(R,K).lineTo(R+a.size,K+a.size).endFill()):d.highlightPosition(l.name,{x:R,y:K,border:n.border,color:n.fill})}}r(Nt,"highlightGrid");var Tn={burst:"circle",cone:"cone",cube:"rect",cylinder:"circle",emanation:"circle",line:"ray",square:"rect"};function gt({type:t,distance:e,traits:n,fillColor:o,width:s,flags:i}){let c={t:Tn[t],distance:e,fillColor:o||game.user.color,flags:{[m]:i}};switch(c.t){case"ray":c.width=Number(s)||CONFIG.MeasuredTemplate.defaults.width*canvas.dimensions.distance;break;case"cone":c.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let a=c.distance??0;c.distance=Math.hypot(a,a),c.width=a,c.direction=45;break}}n&&foundry.utils.setProperty(c,"flags.pf2e.origin.traits",n),canvas.templates.createPreview(c)}r(gt,"createTemplate");function qe({type:t="burst",token:e,distance:n}){mt(e)&&(n??=t==="cone"?30:15,gt({type:t,distance:n,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}r(qe,"createSeekTemplate");function Ut({type:t="burst",distance:e=20,conceal:n=!1}={}){gt({type:t,distance:e,fillColor:ut,flags:{type:"darkness",conceal:n}})}r(Ut,"createDarknessTemplate");function zt({type:t="burst",distance:e=20}={}){gt({type:t,distance:e,fillColor:ft,flags:{type:"mist"}})}r(zt,"createMistTemplate");function Gt(t,e){return e&&!mt(e)?null:canvas.scene.templates.filter(n=>L(n,"type")===t)??[]}r(Gt,"getTemplates");function Ke(t){return Gt("darkness",t)}r(Ke,"getDarknessTemplates");function Qe(t){return Gt("mist",t)}r(Qe,"getMistTemplates");function Ze(t){if(!mt(t))return null;let e=canvas.scene.templates.find(o=>L(o,"type")==="seek");if(!e)return null;let n=t instanceof Token?t.document:t;return ye(e,{collisionType:"sight",collisionOrigin:n.center})}r(Ze,"getSeekTemplateTokens");async function X(t){let e=t.scene.templates.filter(n=>L(n,"type")==="seek"&&L(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(X,"deleteSeekTemplate");function mt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(h("template.scene")),!1)}r(mt,"checkScene");function ye(t,{collisionOrigin:e,collisionType:n="move"}={}){let o=canvas.interface.grid,s=canvas.dimensions,i=t instanceof MeasuredTemplateDocument?t.object:t;if(!canvas.scene||!i?.highlightId||!o||!s)return[];let c=o.getHighlightLayer(i.highlightId);if(!c||canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return[];let a=canvas.grid.size,d=[],f=e??i.center,u=canvas.tokens.quadtree.getObjects(c.getLocalBounds(void 0,!0));for(let l of u){let p=l.document,g=[];for(let v=0;v<p.height;v++){let S=Math.floor(l.x/a)*a,b=Math.floor(l.y/a)*a+v*a;if(g.push(`${S},${b}`),p.width>1)for(let y=1;y<p.width;y++)g.push(`${S+y*a},${b}`)}for(let v of g){if(!c.positions.has(v))continue;let[S,F]=v.split(",").map(C=>Number(C)),b={x:S+s.size*.5,y:F+s.size*.5};if(b.x<0||b.y<0)continue;if(!CONFIG.Canvas.polygonBackends[n].testCollision(f,b,{type:n,mode:"any"})){d.push(l);break}}}return d}r(ye,"getTemplateTokens");function jt(){let t=["circle","cone"].includes(this.document.t),e=canvas.grid.type===CONST.GRID_TYPES.SQUARE;if(!t||!e)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.interface.grid.getHighlightLayer(this.highlightId)?.clear();return}let n=L(this.document,"collisionType"),o=L(this.document,"collisionOrigin");Nt({areaShape:this.areaShape,object:this,document:this.document,colors:{border:Number(this.document.borderColor),fill:Number(this.document.fillColor)},preview:!0,collisionType:n,collisionOrigin:o})}r(jt,"highlightTemplateGrid");function Ht(t){let{type:e,slug:n,castLevel:o=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&(Ot.includes(n)?t.updateSource({fillColor:ut,[`flags.${m}`]:{type:"darkness",conceal:o>=4}}):At.includes(n)?t.updateSource({fillColor:ft,[`flags.${m}`]:{type:"mist"}}):n==="cloudkill"&&t.updateSource({fillColor:Dt,[`flags.${m}`]:{type:"mist"}}))}r(Ht,"preCreateMeasuredTemplate");function Xe(t){L(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}r(Xe,"onMeasuredTemplate");function ke(t,e=1){let n=Object.getPrototypeOf(t);return e>1?ke(n,e-1):n}r(ke,"getPrototype");function Je(t,e){return t.name.localeCompare(e.name)}r(Je,"sortByName");function et(t){return t=Number(t),isNaN(t)?void 0:t}r(et,"asNumberOnly");var Y=class extends Application{#e;#s;#t;#n;#o;constructor({token:e,resolve:n,selected:o=[]},s={}){super(s),this.#e=e,this.#s=n,this.#t=o,this.#o=(i,c)=>{let a=i.id,d=this.element.find("[data-token-id]");d.removeClass("hover"),c&&d.filter(`[data-token-id=${a}]`).addClass("hover")},Hooks.on("hoverToken",this.#o)}async close(e={}){Hooks.off("hoverToken",this.#o),this.#s?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return foundry.utils.mergeObject(Application.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(h("menu.no-token"));return}n.id=`${m}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(s=>s.id===n.id);return o&&o.close(),new Promise(s=>{e.resolve=s,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let s=z[o],i=e[o]??s,c=n[o]??s;return{original:i,current:c,changed:i!==c,custom:c!==s,originalCustom:i!==s}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?oe(this.token,this.#t):[]}get currentData(){return foundry.utils.deepClone(this.#i)}get#i(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=V(this.document)??{};return foundry.utils.deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){return{i18n:h,covers:H.map(n=>({value:n,label:h(`cover.${n}`)})),visibilities:ae.map(n=>({value:n,label:h(`visibility.${n}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,s=this.scene.tokens.get(o)?.object;!s||s.controlled||s._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,s=o.name,i=z[s],c=o.value||i,a=o.closest(".token")?.dataset.tokenId,d=a?[a]:this.#t;for(let f of d)foundry.utils.setProperty(this.#i,`${f}.${s}`,c);a?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==i)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#i),this.close({resolve:!0})})}_saveData(e){tt(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],s=[],i=this.actor.alliance,c=i==="party"?"opposition":i==="opposition"?"party":null;for(let a of e)if(c){let d=a.actor?a.actor.alliance:a.alliance;d===i?n.push(a):d===c?o.push(a):d===null&&s.push(a)}else s.push(a);return{allies:n.sort(Je),neutral:s.sort(Je),enemies:o.sort(Je),hasTokens:n.length||o.length||s.length}}};r(Y,"BaseMenu");var Oe=class extends Y{get title(){return h("menu.perception.title",{name:this.token.name})}get template(){return Q("perception")}getData(e){let n=this.selected,o=this.currentData,s=this.getSavedData(),i=G(this.token).map(({id:c,name:a,actor:d})=>{let f=o[c]??{},u=s[c]??{};return{id:c,name:a,alliance:d.alliance,cover:Y.createPropertyData(u,f,"cover"),visibility:Y.createPropertyData(u,f,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(i)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),s=(o.length?o:e).find("[data-token-id]"),i=s.filter(":not(.ui-selected)").length===0;s.toggleClass("ui-selected",!i),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(Oe,"PerceptionMenu");var Sn=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function nt(t,e){let n=1-e;return{top:{A:J({x:e,y:e},t),B:J({x:n,y:e},t)},right:{A:J({x:n,y:e},t),B:J({x:n,y:n},t)},bottom:{A:J({x:n,y:n},t),B:J({x:e,y:n},t)},left:{A:J({x:e,y:n},t),B:J({x:e,y:e},t)}}}r(nt,"getRectEdges");function Ae(t,e,n=!1){return n&&q(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(Ae,"lineIntersectWall");function ot(t,e,n=!1){for(let o of Cn(e.bounds))if(Ae(t,o,n))return!0;return!1}r(ot,"pointToTokenIntersectWall");function J(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(J,"getRectPoint");function ue(){canvas.controls.debug.clear()}r(ue,"clearDebug");function q(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(q,"drawDebugLine");function*Cn(t){for(let e of Sn)yield J(e,t)}r(Cn,"rectSpread");function it(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.environment.darknessLevel<n.environment.globalLight.darkness.max)return;e&&ue();let o=t.document.center,s=null;for(let i of canvas.effects.lightSources){if(!i.active||i instanceof foundry.canvas.sources.GlobalLightSource)continue;let c=i.data.bright,a=i.data.dim;if(i.object===t){if(c)return"bright";a&&(s="dim");continue}if(!i.shape.contains(o.x,o.y)){e&&q(i,o,"red");continue}if(i.ratio===1&&c>0)return e&&q(i,o,"green"),"bright";if(i.ratio===0&&c>0){e&&q(i,o,"blue"),s="dim";continue}if(new Ray(i,o).distance<=c)if(e)q(i,o,"green"),s="bright";else return"bright";else e?(q(i,o,"blue"),s!=="bright"&&(s="dim")):s="dim"}return s}r(it,"getLightExposure");var be={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ignored:{targets:["allies","enemies"]},ac:{targets:["lesser","standard","greater","greater-prone"],value:["number"]}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:["number","string"]}}},xn={cover:Object.keys(be.cover),visibility:Object.keys(be.visibility),all:[...Object.keys(be.cover),...Object.keys(be.visibility)]};function Bt(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,n=t.value.constructor;class o extends game.pf2e.RuleElement{constructor(i,c){typeof i.targets=="string"&&(i.targets=[i.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...i},c);let a=xn[i.type];if(!a)return;if(!a?.includes(i.selector)){this.failValidation(`The type "${i.type}" only accepts the following selectors: ${a.join(", ")}.`);return}let d=be[i.type]?.[i.selector];if(!d)return;let f=r(p=>{let{name:g,uuid:v}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${g} (${v}) simple warning: ${p}`)},"selectorWarn"),u=Array.isArray(d.targets)?[...d.targets,"all"]:d.targets,l=Array.isArray(u)?u.join(", "):null;if(!u&&i.targets?.length){f(`The selector "${i.selector}" doesn't accept any targets property.`);return}if(i.selector==="ignore"&&!i.targets?.length){let p=`The selector "${i.selector}" requires a targets property with the ids of the tokens on the scene that should not give cover.`;this.failValidation(p);return}if(l&&i.targets?.some(p=>!u.includes(p))){let p=`The targets property of selector "${i.selector}" only accepts the following: ${l}.`;this.failValidation(p);return}else if(!l&&u&&i.targets?.some(p=>typeof p!==u)){let p=`The targets property of selector "${i.selector}" needs to be of type "${u}".`;this.failValidation(p);return}if(!d.value&&i.value){f(`The selector "${i.selector}" doesn't accept any value property.`);return}if(i.selector==="set"){if(!d.value.includes(i.value)){let p=d.value.join(", "),g=`The selector "${i.selector}" only accepts the following: ${p}.`;this.failValidation(g)}}else{let p=typeof i.value;if(d.value&&!d.value.includes(p)){let g=`The selector "${i.selector}" does not accept a value property of type ${p}.`;this.failValidation(g)}}}static defineSchema(){let{fields:i}=foundry.data;return{...super.defineSchema(),type:new i.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new i.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new i.StringField({required:!0,nullable:!1,blank:!1}),targets:new i.ArrayField(new i.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new n({required:!1,initial:void 0})}}test(i,c){return c?super.test(i):!1}addToPerception(i,c,a){if(!this.test(a,!0))return;let f=`${this.affects==="self"?i:i==="origin"?"target":"origin"}.${this.type}.${this.selector}`,u=be[this.type][this.selector];if(!u.targets){foundry.utils.setProperty(c,f,!0);return}let l=this.targets.includes("all")?u.targets:this.targets;if(!u.value){for(let p of l){let g=`${f}.${p}`;foundry.utils.setProperty(c,g,!0)}return}for(let p of l){let g=`${f}.${p}`,v=foundry.utils.getProperty(c,g);v?v.add(this.value):v=new Set([this.value]),foundry.utils.setProperty(c,g,v)}}}r(o,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=o}r(Bt,"setupRuleElement");function ie(t,e,{distance:n,extraOptions:o=[]}={}){let s=t.actor,i=e.actor;if(!s||!i)return{};let c={origin:s.rules.filter(l=>!l.ignored&&l.key==="PF2ePerception")??[],target:i.rules.filter(l=>!l.ignored&&l.key==="PF2ePerception")??[]};if(!c.origin.length&&!c.target.length)return{};let a={origin:s.getRollOptions(),target:i.getRollOptions()},d={origin:i.getSelfRollOptions("target"),target:s.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,n??=t.distanceTo(e);let f=[`origin:distance:${n}`,`target:distance:${n}`],u={};for(let l of["origin","target"]){let p=[...o,...a[l],...d[l],...f];for(let g of c[l])g.addToPerception(l,u,p)}return u}r(ie,"perceptionRules");function Wt(t){let e=t.actor;return e?(e.rules.filter(o=>!o.ignored&&o.key==="PF2ePerception"&&o.type==="cover"&&o.selector==="ignored")??[]).flatMap(o=>o.targets):[]}r(Wt,"getIgnoredPerception");function B(t,e,n,o,s){let i=t[e]?.[n]?.[o];return s?i?.[s]:i}r(B,"getPerception");function Te(t,e,n,o){o===void 0&&(o=n==="cover"?"none":"observed");let s=n==="cover"?H:ae;if(o&&B(t,e,n,"cancel",o))return;let i=B(t,e,n,"set",o)?.first();if(i&&s.includes(i))o=i;else if(o&&B(t,e,n,"reduce",o)){let c=s.indexOf(o);o=s[Math.max(0,c-1)]}return o===s[0]?void 0:o}r(Te,"updateFromPerceptionRules");function Yt(t,e){!Rt()||!t.object.actor?.isOfType("creature")||($(e).find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),$(e).find("[data-action=pf2e-perception]").on("click",n=>vt(t.object)))}r(Yt,"renderTokenHUD");function vt(t){return Oe.openMenu({token:t})}r(vt,"openHUD");function qt(t,e){for(let n of e)delete n.flags?.[m]}r(qt,"pasteToken");function V(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,L(t,e.join("."))}r(V,"getTokenData");async function Kt(t){return t=t instanceof Token?t.document:t,Pt(t,"data")}r(Kt,"clearTokenData");async function tt(t,e){let n=G(t).map(s=>s.id),o={};for(let s in e){if(!n.includes(s)){o[`flags.${m}.data.-=${s}`]=null;continue}let i=e[s],c=V(t,s)??{};if(i.visibility===z.visibility&&delete i.visibility,i.cover===z.cover&&delete i.cover,!(c.cover===i.cover&&c.visibility===i.visibility))if(!i.visibility&&!i.cover)o[`flags.${m}.data.-=${s}`]=null;else for(let a of["cover","visibility"])c[a]!==i[a]&&(i[a]?o[`flags.${m}.data.${s}.${a}`]=i[a]:o[`flags.${m}.data.${s}.-=${a}`]=null)}return t=t instanceof Token?t.document:t,t.update(o)}r(tt,"setTokenData");function st(t,e,n=!1){let o=t.scene;return ve(o,"standard")?(n&&ue(),(D("standard-type")==="points"?ot(t.center,e,n):Ae(t.center,e.center,n))?"standard":void 0):void 0}r(st,"getWallCover");var fe={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function ct(t,e,{perception:n={},options:o=[],affects:s="origin",debug:i=!1}={}){let c=o.includes("item:ranged")?Z(e.actor):!1,a=r(u=>Te(n,s,"cover",u),"returnValue"),d=te(e.actor,!0);if(c&&E[d]>E.lesser)return a("greater-prone");!c&&d==="greater-prone"&&(d=void 0);let f=V(e,t.id,"cover");if(c&&E[f]>E.lesser)return a("greater-prone");if(!c&&f==="greater-prone"&&(f=void 0),E[d]<E.standard){let u=game.modules.get(m).custom??{};if(E[f]<E.standard){let l=u.getWallCover,p;if(typeof l=="function"){let g=l(t,e,i);p=H.includes(g)?g:st(t,e,i)}else p=st(t,e,i);E[p]>E[f]&&(f=p)}if(E[f]<E.standard&&t.distanceTo(e)>5){let l=u.getCreatureCover,p;if(typeof l=="function"){let g=l(t,e,{perception:n,debug:i});p=H.includes(g)?g:rt(t,e,{perception:n,debug:i})}else p=rt(t,e,{perception:n,debug:i});E[p]>E[f]&&(f=p)}}return c&&E[f]>E.lesser?a("greater-prone"):a(E[f]>E[d]?f:void 0)}r(ct,"getCover");function rt(t,e,{perception:n={},debug:o=!1}={}){let s=D("lesser");if(s==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let i=(()=>{let T=Object.keys(n.origin?.cover?.ignore??{}),O=Object.keys(n.target?.cover?.ignore??{});return new Set([...T,...O])})(),c,a=t.center,d=e.center,f=t.actor,u=e.actor;o&&(ue(),q(a,d));let l=r(T=>{let O=fe[T.actor.size];return O-p>=2&&O-g>=2},"isExtraLarge"),p=fe[f.size],g=fe[u.size],v=f.alliance,S=D("dead-cover"),F=D("prone-cover"),b=t.scene.tokens.contents.filter(T=>{let O=T.actor,A=Wt(T);return O&&!T.hidden&&T!==t&&T!==e&&(F||!Z(O))&&(S||O.hitPoints?.value!==0)&&!i.has(T.id)&&!(A.includes("all")||A.includes(O.alliance===v?"allies":"enemies"))}).sort((T,O)=>fe[O.actor.size]-fe[T.actor.size]),y=p<fe.huge&&g<fe.huge&&b.filter(l).length,C=s==="ten"?.1:s==="twenty"?.2:0,x=r(T=>(o&&q(T.A,T.B,"red"),foundry.utils.lineSegmentIntersects(a,d,T.A,T.B)),"intersectsEdge"),_=s==="cross"?T=>x(T.top)&&x(T.bottom)||x(T.left)&&x(T.right):T=>Object.values(T).some(O=>x(O));for(let T of b){let O=T.object,A=nt(O.bounds,C);if(_(A))return y?"standard":"lesser";l(T)&&y--}return c}r(rt,"getCreatureCover");function se(t,e,{perception:n={},affects:o="origin",debug:s=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let i=t.actor,c=e.actor,a=(()=>{if(!i||!c)return;let y;c.hasCondition("blinded")?y="hidden":c.hasCondition("dazzled")&&(y="concealed");for(let C of["unnoticed","undetected","hidden","concealed"])k[C]>k[y]&&i.hasCondition(C)&&(y=C);return y})(),d=r(y=>f?(k[y]<k.hidden&&(y="hidden"),(je(c)||B(n,o,"visibility","noinvis"))&&(y="concealed"),Te(n,o,"visibility",y)):Te(n,o,"visibility",y),"returnValue"),f=i?.hasCondition("invisible"),u=V(t,e.id,"visibility"),l=k[a]>k[u]?a:u;if(k[l]>=k.hidden||f)return d(l);let p=c?.hasLowLightVision,g=c?.hasDarkvision,v=c&&Ge(c);if(v&&l==="concealed")return d(l);let S;if(!v){let y=Ke(t);if(y?.length){let C;for(let x of y){let _=ye(x);if(!_.length)continue;if(_.includes(t)||_.includes(e))S=!0;else continue;if(!g)return d("hidden");L(x,"conceal")&&(C="concealed")}if(C==="concealed"&&(l="concealed"),S&&l==="concealed")return d(l)}}if(l!=="concealed"){let y=Qe(t);if(y?.length)for(let C of y){let x=ye(C);if(!x.length)continue;if(x.includes(t)||x.includes(e))return d("concealed")}}if(S||v)return d(l);let F=it(t,s),b=F==="dim"?"concealed":F===null?"hidden":void 0;return(b==="concealed"&&p||b==="hidden"&&g)&&(b=void 0),k[b]>k[l]&&(l=b),d(l)}r(se,"getVisibility");function Qt(t,e,n,o){let s=e.flags?.["pf2e-perception"];if(s&&(s.data||s["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let i=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",i),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(Qt,"updateToken");function Zt(t,e){e?at(t):pe(t)}r(Zt,"hoverToken");function Xt(t){pe(t),game.user.isGM||ui.combat.render()}r(Xt,"deleteToken");function Jt(t,e){e&&(pe(),Hooks.once("sightRefresh",()=>t.hover&&at(t)))}r(Jt,"controlToken");var ht={};function pe(t){let e=t?.id;if(!e)return $(".pf2e-conditionals").remove();for(let n of ht[e]??[])n.remove();delete ht[e]}r(pe,"clearConditionals");function at(t){let e=G(t);for(let n of e)yt(n,t)}r(at,"showAllConditionals");async function yt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=V(t,e.id);if(foundry.utils.isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&k[n.visibility]>=k.hidden){if(!n.cover)return;n={cover:n.cover}}let o=e.id,s=canvas.clientCoordinatesFromCanvas(t),i=D("icon-size"),c=t.document.width*canvas.grid.size*t.worldTransform.a,a=[`top: ${s.y}px`,`left: ${s.x+c/2}px`,`--icon-size: ${i}px`].join("; "),d=`<div class="pf2e-conditionals" data-hover-id="${t.id}"`;d+=` data-token-id="${o}" style="${a}">`;let f=D("icon-path");Object.entries(n).map(([l,p])=>{let g=l==="cover"?"cover":p,v=f[g]||Ne[g];(v.startsWith("systems")||v.startsWith("modules"))&&(v=`../../../${v}`),d+=`<div class="conditional"><img src="${v}"></img></div>`}),d+="</div>";let u=$(d);(ht[o]??=[]).push(u),$(document.body).append(u)}r(yt,"showConditionals");function en(t){let e=t.actor;if(e?.isOfType("creature")&&(e.isOfType("npc")&&ve(t.scene,"npc-vision")&&t.updateSource({"sight.enabled":!0}),game.user.isGM&&t.hidden)){let n=game.user.targets,o={};for(let s of n)o[s.id]={visibility:"unnoticed"};n.size&&t.updateSource({[`flags.${m}.data`]:o})}}r(en,"preCreateToken");var Pe=class extends Y{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&tn(e.message),o}get title(){return h("menu.validation.title",{name:this.token.name})}get template(){return Q("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,n=e.actor.alliance;return G(e).filter(o=>o.actor.alliance!==n).map(o=>o.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,s=this.selected,i=z[n],c=n==="cover"?H:ae;for(let a of s){let d=o.tokens.get(a),f=`${a}.${n}`,u=foundry.utils.getProperty(e,f)??i,l=this.processValue({token:d,value:u});c.includes(l)||(l=u),u!==l&&foundry.utils.setProperty(e,f,l)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:s}=super.getData(e),i=this.currentData,c=this.getSavedData(!1),a=this.property,d=this.selected,f=G(this.token);f=f.map(({id:l,name:p,actor:g})=>{let v=i[l]??{},S=c[l]??{};return{id:l,name:p,alliance:g.alliance,selected:d.includes(l),...Y.createPropertyData(S,v,a)}});let u=D("validation");return u==="selected"?f=f.filter(l=>l.selected):u==="changed"&&(f=f.filter(l=>l.changed)),{...this._spliIntoAlliances(f),i18n:s,property:a,options:a==="cover"?n:o,showSelected:d.length!==f.length&&u==="all",showChanges:u!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(Pe,"ValidationMenu");var $e=class extends Pe{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r($e,"CoverValidationMenu");var re=class extends Pe{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(re,"VisibilityValidationMenu");var Re=class extends re{processValue({token:e,value:n}){let o=this.roll,s=e.actor.perception.dc.value,i=k[n],c=new M(o,s).value;return c>=M.SUCCESS&&i<k.hidden?"hidden":c<=M.FAILURE&&i>=k.hidden?"observed":n}};r(Re,"HideValidationMenu");var Fe=class extends re{processValue({token:e,value:n}){let o=this.roll,s=e.actor.perception.dc.value,i=k[n];return new M(o,s).value>=M.SUCCESS&&i<k.hidden?"hidden":n}};r(Fe,"CreateADiversionMenu");var we=class extends re{get selected(){return G(this.token).map(e=>e.id)}processValue({token:e,value:n}){return k[n]>=k.hidden?"observed":n}};r(we,"UnHideValidationMenu");var Le=class extends re{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,s=V(e)??{};return G(e).filter(i=>{if(i.id===o||i.actor.alliance===n)return!1;let c=foundry.utils.getProperty(s,`${i.id}.visibility`);return k[c]>=k.undetected}).map(i=>i.id)}processValue({token:e,value:n}){return k[n]>=k.undetected?"hidden":n}};r(Le,"PointOutValidationMenu");var lt=class extends re{getSavedData(e=!0){let n=this.token.id,o=G(this.token),s={};for(let i of o){let c=V(i,n);c&&(s[i.id]=foundry.utils.deepClone(c))}return e?this._convertData(s):s}getData(){let e=super.getData();return e.isReversed=!0,e.options=ae.map(n=>({value:n,label:h(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,s=[];for(let[i,c]of Object.entries(e)){let a={_id:i},d=n.tokens.get(i);if(d){c.visibility===z.visibility&&delete c.visibility;let f=V(d,o)??{};if(f?.visibility===c.visibility)continue;!f.cover&&!c.visibility?a[`flags.${m}.data.-=${o}`]=null:c.visibility?a[`flags.${m}.data.${o}.visibility`]=c.visibility:a[`flags.${m}.data.${o}.-=visibility`]=!0}else a[`flags.${m}.data.-=${o}`]=null;s.push(a)}n.updateEmbeddedDocuments("Token",s)}};r(lt,"ReverseVisibilityValidationMenu");var Me=class extends lt{#e;constructor(e,n={}){super(e,n),this.#e=e.fromTemplate}get globalSelection(){return[]}static async openMenu(e,n){await super.openMenu(e,n)&&X(e.token)}processValue({token:e,value:n}){let o=this.roll,s=e.actor.skills.stealth.dc.value,i=k[n],c=new M(o,s).value;return c>=M.CRITICAL_SUCCESS&&i>=k.hidden||c>=M.SUCCESS&&i===k.hidden?"observed":c>=M.SUCCESS&&i>=k.undetected?"hidden":n}};r(Me,"SeekValidationMenu");function bt(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,s=n.hasPlayerOwner,{cover:i,selected:c,skipWait:a,validated:d,pointOut:f}=$t(t),u=t.getFlag("pf2e","context");if(i){if(o){let l=dt({property:"cover",skipWait:a,validated:d});e.find(".message-content").append(l),e.find("[data-action=validate-cover]").on("click",()=>{$e.openMenu({token:n,selected:c,value:i,message:t})})}else if(!a){let l=kt("cover",d);e.find(".message-content").append(l)}}else if(u?.pf2ePerception?.visibility){d||e.find(".message-buttons").remove();let l=e.find(".flavor-text");!o&&s&&(e.find(".message-sender").text(n.name),l.empty());let p=h(`message.flat-check.${d===void 0?"blind":d?"success":"failure"}`),g=rn(p,d);if(l.append(g),o)for(let v of["success","failure"])l.append(Tt({action:`${v}-message`,icon:"fa-solid fa-message",label:h("message.flat-check.button",v)})),e.find(`[data-action=${v}-message]`).on("click",()=>{pt(t,"validated",v==="success")})}else if(u?.type==="skill-check"&&u.pf2ePerception)if(o){if(u.options.includes("action:hide")){let l=dt({property:"visibility",skipWait:a,validated:d});e.find(".flavor-text").append(l),e.find("[data-action=validate-visibility]").on("click",()=>{Re.openMenu({token:n,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected})})}else if(u.options.includes("action:create-a-diversion")){let l=dt({property:"visibility",skipWait:a,validated:d});e.find(".flavor-text").append(l),e.find("[data-action=validate-visibility]").on("click",()=>{Fe.openMenu({token:n,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected})})}}else s&&(u.options.includes("action:hide")?on({token:n,message:t,html:e,validated:d,action:"Hide"}):u.options.includes("action:create-a-diversion")&&sn(e,d));else if(u?.type==="perception-check"&&u.pf2ePerception)if(o){if(u.options.includes("action:seek")){let l=nn({skipWait:a,validated:d,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(l),e.find("[data-action=validate-visibility]").on("click",()=>{Me.openMenu({token:n,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected,fromTemplate:u.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{X(n)})}}else s&&u.options.includes("action:seek")&&on({token:n,message:t,html:e,validated:d,action:"Seek"});else if(f){let l=n.scene.tokens.get(f);if(!l)return;if(o){let p=nn({skipWait:a,validated:d,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(p),e.find("[data-action=validate-visibility]").on("click",()=>{Le.openMenu({message:t,token:l,originator:n,selected:canvas.tokens.controlled.map(g=>g.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(l.center)})}else if(s){let p=kt("visibility",d);e.find(".message-content").append(p)}}if(o&&me.includes(u?.type)){let p=`<span class="pf2e-perception-unhide">
    <button data-action="unhide" title="${h("message.unhide.tooltip")}">
        <i class="fa-duotone fa-eye-slash"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(p),e.find("[data-action=unhide]").on("click",g=>{g.stopPropagation(),we.openMenu({token:n})})}}r(bt,"renderChatMessage");function tn(t){L(t,"validated")||pt(t,"validated",!0)}r(tn,"validateMessage");function nn({skipWait:t,validated:e,smallIcon:n,smallAction:o,smallSlashed:s}){let i='<div class="pf2e-perception-chat-combo">';return i+=dt({property:"visibility",skipWait:t,validated:e}),i+=Tt({action:o,icon:n,slashed:s,tooltip:h(`message.visibility.small-button.${o}`)}),i+="</div>",i}r(nn,"createValidateCombo");function In(t,e){let n=game.i18n.localize(e==="perception"?"PF2E.PerceptionLabel":`PF2E.Skill${e.capitalize()}`),o=h("message.check");return`<h4 class="action">
    <strong>${le(t)}</strong>
    <span class="action-glyph">1</span>
    <span class="subtitle">(${n} ${o})</span>
</h4>`}r(In,"actionTitle");function sn(t,e){let n=kt("visibility",e);t.find(".flavor-text").append(n)}r(sn,"addSkillCheckFlavor");function on({html:t,token:e,message:n,validated:o,action:s}){let i=n.getFlag("pf2e","modifierName"),c=In(s,i);t.find(".message-sender").text(e.name),t.find(".flavor-text").html(c),sn(t,o)}r(on,"addBlindSkillCheckFlavor");function kt(t,e){let n=h(`message.${t}.player.${e?"validated":"wait"}`);return rn(n,e)}r(kt,"createWaitHint");function rn(t,e){return`<i class="pf2e-perception-hint">${e===!0?`<i class="fa-solid fa-check validated"></i> ${t}`:e===!1?`<i class="fa-solid fa-xmark canceled"></i> ${t}`:t}</i>`}r(rn,"createHint");function dt({skipWait:t,validated:e,property:n}){let o=h(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check validated"></i>'),Tt({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r(dt,"createValidateButton");function Tt({action:t,icon:e,label:n,tooltip:o,slashed:s=!1}){let i=`<button type="button" class="pf2e-perception-chat-button" data-action="${t}" title="${o}">`;return e&&(i+=`<i class="${e} ${n?"":"no-label"}"></i>`,s&&(i+='<i class="fa-solid fa-slash-forward slashed"></i>')),n&&(i+=`${e?" ":""}${n}`),i+="</button>",i}r(Tt,"createChatButton");async function St({content:t,token:e,flags:n,secret:o}){let s={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&foundry.utils.setProperty(s,`flags.${m}`,n),o&&(s.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,s.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(s)}r(St,"createTokenMessage");function cn(){let t=game.pf2e.actions.get("hide"),e=ke(t,2).constructor,n=ke(t.toActionVariant(),2).constructor,o=ke(t,1).constructor,s=ke(t.toActionVariant(),1).constructor;Fn(e,n),Rn(o,s),$n(o,s),Pn(o,s),On(o,s),En(e,n)}r(cn,"setupActions");function En(t,e){class n extends e{async use(i={}){let c=h("action.point-out"),a=Se(i,c);a&&Dn(this,a)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${m}.action.point-out`,description:`${m}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(i={}){return i.name??=this.name,new n(this,i)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(En,"setupPointOut");async function Dn({name:t,traits:e},n){let o=game.user.targets.filter(f=>f.actor).first(),s=o?V(o,n.id,"visibility"):void 0,i=o&&k[s]<k.undetected,c;if(i){let f=o.actor.skills.stealth.dc.value;c=h("message.point-out.short-check",{check:`@Check[type:perception|dc:${f}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=h("message.point-out.short");let a=await renderTemplate(Q("point-out"),{description:c,name:t,traits:e.map(f=>({slug:f,tooltip:CONFIG.PF2E.traitsDescriptions[f],name:CONFIG.PF2E.actionTraits[f]}))}),d={pointOut:i?o.id:void 0};St({content:a,token:n,flags:d})}r(Dn,"pointOut");function On(t,e){class n extends e{async use(i={}){let c=le("Seek"),a=Se(i,c);if(a)return D("seek-template")&&!await An(a)?X(a):(i.actors=[a.actor],super.use(i))}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(i){return new n(this,i)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(On,"setupSeek");async function An(t){let e=game.i18n.localize("PF2E.Foot.Plural"),n='<p style="margin: 0 0.3em; text-align: center;">';n+=`${h("dialog.seek.hint")}</p><p>`;let o=[{type:"cone",distance:30},{type:"burst",distance:15},{type:"burst",distance:30}];for(let{type:s,distance:i}of o){let c=game.i18n.format("PF2E.TemplateLabel",{size:i,unit:e,shape:game.i18n.localize(`PF2E.Area.Shape.${s}`)});n+=`<button type="button" data-action="create-template" 
        data-type="${s}" data-distance="${i}" style="margin: 0 0 5px; padding: 0;">
    <i class="fa-thin fa-cubes"></i> ${c}</button>
</button>`}return n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:h("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:h("dialog.seek.cancel"),callback:s=>!1}},close:()=>!1,render:s=>{s.filter(".dialog-content").find("[data-action=create-template]").on("click",c=>{let{type:a,distance:d}=c.currentTarget.dataset;X(t),qe({type:a,distance:d,token:t})})}},{width:300,left:10})}r(An,"seek");function Pn(t,e){class n extends e{async use(i={}){let c=le("Sneak"),a=Se(i,c);if(a)return i.actors=[a.actor],super.use(i)}}r(n,"SneakVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(i){return new n(this,i)}}r(o,"Sneak")}r(Pn,"setupSneak");function $n(t,e){class n extends e{async use(i={}){let c=le("CreateADiversion"),a=Se(i,c);if(a)return i.actors=[a.actor],super.use(i)}}r(n,"CreateADiversionVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.CreateADiversion.Description",name:"PF2E.Actions.CreateADiversion.Title",notes:[{outcome:["criticalSuccess","success"],text:"PF2E.Actions.CreateADiversion.Notes.success"},{outcome:["criticalFailure","failure"],text:"PF2E.Actions.CreateADiversion.Notes.failure"}],section:"skill",slug:"create-a-diversion",statistic:"deception",traits:["mental"],variants:[{name:"PF2E.Actions.CreateADiversion.DistractingWords.Title",rollOptions:["action:create-a-diversion","action:create-a-diversion:distracting-words"],slug:"distracting-words",traits:["auditory","linguistic","mental"]},{name:"PF2E.Actions.CreateADiversion.Gesture.Title",rollOptions:["action:create-a-diversion","action:create-a-diversion:gesture"],slug:"gesture",traits:["manipulate","mental"]},{name:"PF2E.Actions.CreateADiversion.Trick.Title",rollOptions:["action:create-a-diversion","action:create-a-diversion:trick"],slug:"trick",traits:["manipulate","mental"]}]})}toActionVariant(i){return new n(this,i)}}r(o,"CreateADiversion"),game.pf2e.actions.set("create-a-diversion",new o)}r($n,"setupCreateADiversion");function Rn(t,e){class n extends e{async use(i={}){let c=le("Hide"),a=Se(i,c);if(a)return i.actors=[a.actor],super.use(i)}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(i){return new n(this,i)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r(Rn,"setupHide");function Fn(t,e){class n extends e{async use(i={}){let c=h("action.take-cover"),a=Se(i,c);a&&wn(a)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(i){return new n(this,i)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(Fn,"setupCover");async function wn(t){let e=t.actor,n=te(e),o=oe(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let s=V(t)??{},i=Object.entries(s).reduce((d,[f,{cover:u}])=>(u&&(d[f]=u),d),{}),c=await renderTemplate(Q("covers-dialog"),{i18n:h,hasTargets:!!o.length,hasCovers:!foundry.utils.isEmpty(i),hasTargetCover:o.some(d=>d in i),isProne:Z(e)}),a=new Dialog({title:`${t.name} - ${h("action.take-cover")}`,content:c,buttons:{},render:d=>{d.find("button").on("click",async f=>{let{level:u}=f.currentTarget.dataset,l=D("skip-cover"),p=r(async(g,v)=>{let S=v?o:void 0,F=g===z.cover?S?"remove":"remove-all":"take";if(await St({content:h(`message.cover.${F}`,{cover:h(`cover.${g}`)}),flags:{selected:S,cover:g,skipWait:l},token:t}),l){if(g===z.cover&&!S)return Kt(t);let b=foundry.utils.deepClone(V(t))??{};for(let y of o)foundry.utils.setProperty(b,`${y}.cover`,g);return tt(t,b)}},"process");if(u==="remove-all")p(z.cover);else if(u==="remove")p(z.cover,!0);else if(o.length)p(u,!0);else{let g=Ie(u);e.createEmbeddedDocuments("Item",[g])}a.close()})}}).render(!0)}r(wn,"takeCover");function Se(t,e){let n=t.tokens?.filter(i=>i.actor)??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[Ee(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(i=>i.actor)),n.length||(n=[Ee(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(h("action.only-one",{action:e}));return}if(!n.length){ui.notifications.warn(h("action.must-one",{action:e}));return}let s=n[0];if(!s?.actor?.isOfType("creature")){ui.notifications.warn(h("action.must-creature",{action:e}));return}return s}r(Se,"getSelectedToken");async function an(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:s="true",type:i,token:c,target:a,isReroll:d,viewOnly:f,item:u}=n,l=(c??Ee(o))?.object,p=a?.token?.object,g=D("flat-check");if(f||d||!s||!l||o.isOfType("hazard")||!Et.includes(i))return t(...e);let v=p?.actor;if(me.includes(i)&&v){let S=e[2];e:if(g!=="none"){let A=ie(l,p,{extraOptions:n.options.filter(ce=>ce.startsWith("item:"))}),U=se(p,l,{perception:A,affects:"target"});if(!U)break e;let I=(()=>{let ce=B(A,"target","visibility","dc",U)?.first(),ee=et(ce);if(!ee)return ee;let Ct=ce[0];return["-","+"].includes(Ct)?(U==="concealed"?5:11)+ee:ee})();if(I===0)break e;let w=k[U]>=k.undetected,R=S?.ctrlKey||S?.metaKey,j=(await new l.actor.saves.reflex.constructor(l.actor,{modifiers:[],slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${U}.name`)}`,check:{type:"flat-check"}}).roll({dc:{value:I??(U==="concealed"?5:11)},target:p.actor,rollMode:w||R?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(w&&(n.options.add("secret"),n.pf2ePerception={isSuccess:j,visibility:U}),g!=="roll"&&!w&&!j)return}let F=u?.getRollOptions("item")??[],b=l.distanceTo(p),y=ie(l,p,{extraOptions:F,distance:b}),C=se(l,p,{perception:y,affects:"origin"});C&&B(y,"target","visibility","noff",C)&&(C=void 0);let x=ct(l,p,{perception:y,affects:"target",options:F}),_;if(x){let A=B(y,"target","cover","ac",x)?.first();A!=null&&(A=Math.clamped(et(A),0,4)),A===0?x=void 0:A&&(_=A)}let T=k[C]>k.concealed,O=E[x]>E.none;if(O||T){let A=foundry.utils.deepClone(v._source.items);if(O){let I=Ie(x,_);A.push(I)}if(T){let I=Ft(C);A.push(I)}a.actor=v.clone({items:A},{keepId:!0});let U=n.dc;if(U?.slug){let I=a.actor.getStatistic(U.slug)?.dc;I&&(U.value=I.value,U.statistic=I)}}return t(...e)}else if(n.options.has("action:hide"))foundry.utils.setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:create-a-diversion"))foundry.utils.setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let S=Ze(l),F=S??Array.from(game.user.targets),b=oe(l,F).filter(y=>!y.document.hidden).map(y=>y.id);foundry.utils.setProperty(n,"pf2ePerception.selected",b),foundry.utils.setProperty(n,"pf2ePerception.fromTemplate",!!S)}return t(...e)}r(an,"checkRoll");function ln(t,e){let{createMessage:n="true",type:o,token:s,target:i,isReroll:c,options:a,dc:d}=t.context,f=s,u=i?.token,l=i?.actor;if(c||!n||!f||!u||!l||!me.includes(o))return;let p=te(l),g=p?ze(p)?.selection.level??L(p,"level"):void 0,v=t[m]?.coverOverride??g,S=`<div class="conditional">
    <div class="label">${h("dice-checks.cover.label")}</div>
    <select name="overrideCover">
        <option value="">${h("dice-checks.cover.none")}</option>`,F=Z(l)?H.slice(1):H.slice(1,-1);for(let b of F){let y=b===v?"selected":"",C=h(`cover.${b}`);S+=`<option value="${b}" ${y}>${C}</option>`}S+="</select></div>",S+="<hr>",e.find(".roll-mode-panel").before(S),e.find("select[name=overrideCover]").on("change",b=>{let y=b.currentTarget.value||void 0;foundry.utils.setProperty(t,`${m}.coverOverride`,y),v=y}),e.find("button.roll")[0].addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation();let y=!1,C=foundry.utils.deepClone(l._source.items);if(v!==g){y=!0;let x=C.findIndex(_=>foundry.utils.getProperty(_,"flags.core.sourceId")===ge);if(x!==-1&&C.splice(x,1),v){let _=Ie(v);C.push(_)}}if(y&&(i.actor=l.clone({items:C},{keepId:!0}),d?.slug)){let x=i.actor.getStatistic(d.slug)?.dc;x&&(d.value=x.value,d.statistic=x)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}r(ln,"renderCheckModifiersDialog");function dn(t,e,n=[]){let o=ie(t,e,{extraOptions:n}),s=se(e,t,{perception:o,affects:"target"});return s?(()=>{let c=B(o,"target","visibility","dc",s)?.first(),a=et(c);if(!a)return a;let d=c[0];return["-","+"].includes(d)?(s==="concealed"?5:11)+a:a})()??(s==="concealed"?5:11):0}r(dn,"getFlatCheckDc");var un={check:{getFlatCheckDc:dn},geometry:{clearDebug:ue,getRectEdges:nt,lineIntersectWall:Ae,pointToTokenIntersectWall:ot},token:{getCreatureCover:rt,getWallCover:st,getVisibility:se,clearConditionals:pe,showConditionals:yt,showAllConditionals:at,getTokenData:V,getCover:ct,openHUD:vt},lighting:{getLightExposure:it},actor:{isProne:Z,getCoverEffect:te,seeInvisibility:je,hasGreaterDarkvision:Ge},scene:{getValidTokens:G,validateTokens:oe,getSceneSetting:ve},template:{createSeekTemplate:qe,createDarknessTemplate:Ut,createMistTemplate:zt,getDarknessTemplates:Ke,getMistTemplates:Qe,getSeekTemplateTokens:Ze,deleteSeekTemplate:X,getTemplateTokens:ye},ruleElement:{perceptionRules:ie,getPerception:B,updateFromPerceptionRules:Te}};function fn(t,e){D("target")&&Ln(e)}r(fn,"renderCombatTracker");function Ln(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:s}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(s??"")?.token;if(!c)return;let a=Array.from(game.user.targets).some(d=>d.document===c);c.object.setTarget(!a,{releaseOthers:!o.shiftKey})},!0)})}r(Ln,"setupToggleTarget");function pn(t,e){let n=D("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${h("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${h("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let s=o.currentTarget.checked;Ue("encounter",s)})}r(pn,"renderCombatTrackerConfig");function gn(t,e,n={}){return!e.enabled||!this._canDetect(t,n.object,n)?!1:n.tests.some(o=>this._testPoint(t,e,n.object,o))}r(gn,"detectionModeTestVisibility");function _e(t){return function(e,n,o,s){if(e(n,o)===!1)return!1;let c=n.object;return!Mn(c,o,t,s)}}r(_e,"canDetect");function Mn(t,e,n,o={}){if(!t.actor||!e.actor)return!1;if(!o.visibility){let s=ie(t,e);o.visibility=se(e,t,{perception:s,affects:"target"})}return k[o.visibility]>=n}r(Mn,"reachesThreshold");var _n=["cover","concealed","hidden","undetected","unnoticed"],Ve=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:Q("icon-path-menu"),title:h("settings.icon-path.name"),width:500})}getData(){let e=D("icon-path");return{icons:_n.map(o=>({name:o,placeholder:Ne[o],value:e[o]??"",label:o==="cover"?h("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[o])})),i18n:h}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){Ue("icon-path",n)}};r(Ve,"IconPathMenu");function mn(){N("icon-path",Object,{},{config:!1}),game.settings.registerMenu(m,"icon-path-menu",{name:P("icon-path","name"),label:P("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:Ve}),N("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:P("permission","choices.1"),2:P("permission","choices.2"),3:P("permission","choices.3"),4:P("permission","choices.4")}}),N("npc-vision",Boolean,!1),N("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),N("lesser",String,"ten",{choices:{none:P("lesser","choices.none"),cross:P("lesser","choices.cross"),zero:P("lesser","choices.zero"),ten:P("lesser","choices.ten"),twenty:P("lesser","choices.twenty")}}),N("standard",Boolean,!0),N("dead-cover",Boolean,!0),N("prone-cover",Boolean,!0),N("standard-type",String,"center",{choices:{center:P("standard-type","choices.center"),points:P("standard-type","choices.points")}}),N("skip-cover",Boolean,!0),N("validation",String,"all",{choices:{all:P("validation","choices.all"),selected:P("validation","choices.selected"),changed:P("validation","choices.changed")}}),N("flat-check",String,"roll",{choices:{none:P("flat-check","choices.none"),roll:P("flat-check","choices.roll"),cancel:P("flat-check","choices.cancel")}}),N("encounter",Boolean,!1),N("icon-size",Number,26,{scope:"client",range:{min:26,max:52}}),N("seek-template",Boolean,!0,{scope:"client"})}r(mn,"registerSettings");function P(t,e){return`${m}.settings.${t}.${e}`}r(P,"path");function N(t,e,n,o={}){game.settings.register(m,t,{name:P(t,"name"),hint:P(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(N,"register");var Vn="game.pf2e.Check.roll",Nn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",Un="DetectionMode.prototype.testVisibility",zn="CONFIG.Canvas.detectionModes.lightPerception._canDetect",Gn="CONFIG.Canvas.detectionModes.basicSight._canDetect",jn="CONFIG.Canvas.detectionModes.hearing._canDetect",Hn="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{mn(),cn(),Bt(),libWrapper.register(m,Vn,an),libWrapper.register(m,Nn,jt,"OVERRIDE"),libWrapper.register(m,Un,gn,"OVERRIDE"),libWrapper.register(m,zn,_e(k.hidden),"WRAPPER"),libWrapper.register(m,Gn,_e(k.hidden),"WRAPPER"),libWrapper.register(m,jn,_e(k.undetected),"WRAPPER"),libWrapper.register(m,Hn,_e(k.undetected),"WRAPPER"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Vt),Hooks.on("renderCombatTrackerConfig",pn)):Hooks.on("renderCombatTracker",fn),game.modules.get(m).custom={getWallCover:void 0,getCreatureCover:void 0}});Hooks.once("ready",()=>{game.modules.get(m).api=un,Hooks.on("renderChatMessage",bt);for(let e of document.querySelectorAll("#chat-log .chat-message")){let n=game.messages.get(e.dataset.messageId);n&&bt(n,$(e))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${m}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",Zt);Hooks.on("pasteToken",qt);Hooks.on("updateToken",Qt);Hooks.on("deleteToken",Xt);Hooks.on("controlToken",Jt);Hooks.on("renderTokenHUD",Yt);Hooks.on("preCreateToken",en);Hooks.on("canvasPan",()=>pe());Hooks.on("renderCheckModifiersDialog",ln);Hooks.on("preCreateMeasuredTemplate",Ht);Hooks.on("createMeasuredTemplate",Xe);Hooks.on("updateMeasuredTemplate",Xe);Hooks.on("deleteMeasuredTemplate",Xe);})();
//# sourceMappingURL=main.js.map
